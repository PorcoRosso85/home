# グローバル設定

## 用語定義
- **完了状態**: TDD（Test-Driven Development）のGREEN状態およびREFACTOR完了を意味する
  - RED: 失敗するテストが書かれた状態
  - GREEN: テストが通る最小限の実装が完了した状態
  - REFACTOR: コードの品質改善が完了した状態

## 作業規則
- コード変更には/trd_dqlコマンドによる要件設定が必要
- 要件はTRDシステムにのみ基づく
- READMEと同じタスクをおこなう。異なるタスクを計画するべきと判断した場合ユーザーに確認する。
- URLが与えられた場合、`/web`コマンドを実行して本文を抽出する。

## 行動規範
- **長時間実行コマンドの事前判断**:
  - **判断基準**: 以下のいずれかに該当する場合は「長時間実行」と判断
    - ビルド・コンパイル系: `nix build`, `npm install`, `cargo build`, `make`
    - テスト実行系: `pytest` (多数のテスト), `cargo test --all`, `npm test`
    - 大量ファイル操作: `find` (大規模検索), `grep -r` (大規模ディレクトリ)
    - ネットワーク待機: `curl`/`wget` (大容量ダウンロード), `nix develop`
    - 監視・ウォッチ系: `watch`, `tail -f`, 開発サーバー起動
  - **対応**: 長時間実行と判断した場合
    1. そのコマンドを直接実行しない
    2. ユーザーに `/tmux` 使用を提案: 「このコマンドは時間がかかる可能性があるため、`/tmux window.pane`での実行を推奨します」
    3. 具体的なコマンド例を提示
- **レスポンシブ性の維持**: 実行時間が長くなる可能性のあるbashコマンドは、別のtmux paneで実行する
  - `/tmux`コマンドを使用して長時間実行コマンドを送信
  - これによりユーザーへの応答性を常に維持
- **位置確認の徹底**: コマンド送信前に必ず自分の現在位置を確認する
  - `pwd`で作業ディレクトリを確認
  - 意図したディレクトリで作業していることを保証

## 作業範囲規則
- **作業ディレクトリ制限**: 現在作業しているディレクトリ以下のみを変更対象とする
  - 例: `/home/nixos/bin/src/search/vss/kuzu/` で作業中の場合、その配下のみ変更可能
  - **重要**: 親ディレクトリや他プロジェクトのファイルは読み取りのみ許可、**一切の変更・操作を禁止**
  - 例外: 共通規約（`/home/nixos/bin/docs/conventions/`）や共通コマンド（`/home/nixos/.claude/commands/`）の更新時のみ変更可能

## タスク管理規則
- **TodoWrite/TodoReadツール使用義務**: すべての作業はTodoWrite/TodoReadツールで管理する
- **単一ファイル変更原則**: 
  - 1つのタスクで1つのファイル変更を完結させる
  - 変更後は必ず動作確認/テストを実行
  - 成功確認後のみ次のファイル変更タスクへ移行
  - 複数ファイル変更が必要な場合はタスクを分割
- **並列実行の検討義務**: 複数の独立したタスクがある場合、必ず並列サブエージェント（Taskツール）の使用を検討する
  - 検索タスク、ファイル読み込み、独立した実装タスクは並列実行を優先
  - 「複数タスクを並列で実行できないか？」を常に自問する
- **ナンバリング規則**: タスクには番号を付与し、優先順位はユーザーとの議論で確定
- **ネスト構造**: タスク実行中に脱線する場合は必ずネストさせる（例: Task01実行中の脱線はTask01.01として追加）
- **ステータス管理**:
  - `pending`: 未着手のタスク
  - `in_progress`: 作業中（同時に1つまで）
  - `completed`: 完了済み
- **タスク更新規則**:
  - タスク開始時は即座に`in_progress`に更新
  - 完了時は即座に`completed`に更新（バッチ更新禁止）
  - 失敗時は`in_progress`のまま残し、新規タスクで問題を記録
  - タスク更新・変更時の宣言義務（毎回必須）:
    1. 今のタスク目的を明確に出力すること
    2. bin/docs/conventions規約に徹底準拠していることを宣言すること
    3. 宣言にあたり記憶から失われていないか自分を鑑み、必要に応じて再確認を実施
- **TodoReadの使用**:
  - 会話開始時に必ず実行
  - 数メッセージごとに定期的に確認
  - ユーザーが過去のタスクについて言及した際

## 例外処理
- /trd_dqlに基づかないコード変更要求：
  「その変更には要件定義が必要です。まず/trd_dqlで要件を設定してください」
- 緊急修正の場合：
  「緊急修正も要件化が必要です。req_hotfix_YYYYMMDDとして追加してください」

## プロジェクト
- KuzuDB要件管理: ~/bin/src/kuzu/

## 開発規約
- **規約ディレクトリ**: `/home/nixos/bin/docs/conventions/` 内のマークダウンファイル群を唯一の規約とする。
- 全言語・全プロジェクトで統一規約を適用。

## 実装原則

### コンポーネント層の原則
- **正規化・単一責務の徹底**: 各実装は目的に沿った仕様・責務に基づき、正規化・単一責務化を徹底する
- **再利用可能性**: 正規化の結果として自然に再利用可能な設計となる
- **目的駆動**: すべての実装は明確な目的とその結果としての仕様に基づく

### アプリケーション層の制約
- **非正規化の正当性**: アプリケーション層・ユーティリティツールは統合・利便性を目的とした非正規化が許容される
- **必要性の検証**: 明確な目的なき実装は禁止。以下を検証すること：
  - なぜ既存コンポーネントの組み合わせでは不十分か
  - どのような価値を提供するか
  - 責務の重複がないか
- **実装前確認**: この制約下での必須性を検討後、初めて具現化に着手する

## 作業の合言葉
- **「組織」「別のClaudeに依頼」「階層構造」**: `/org` コマンドを実行（並列タスク実行）
- **「tmux」「ペイン」「隣のClaude」**: `/tmux` コマンドを実行（同一ウィンドウ内の他ペインへタスク送信）
- **「コマンド管理」「コマンド作成」「コマンド更新」「コマンド削除」**: `/command` コマンドを実行
- **「TDD」「失敗するテスト」「t-wada」「Baby Steps」「YAGNI」**: `/tdd` コマンドを実行
- **「POC」「記事を保存」「ドキュメント保存」「readability」**: `/poc` コマンドを実行（品質保証付きPOC実施の自動化）
- **「仕様」「spec」「テスト一覧」「責務確認」**: `/spec` コマンドを実行
- **「コミット」「git commit」**: `/commit` コマンドを実行（Claudeが編集したファイルのみのコミットを保証）
- **「議論」「前提確認」「要件整理」「ソクラテス的対話」「ASCII」「シーケンス図」「処理の流れ」「sequential diagram」「discuss」**: `/discuss` コマンドを実行（議論を深め、必要に応じてASCII図で可視化）
- **「URL」「ウェブ記事」「記事を読む」**: `/web` コマンドを実行（URLから本文を抽出）
- **「TRD」「要件」「トレーサビリティ」「DQL」**: `/trd_dql` コマンドを実行（要件の照会・確認）
- **「データ投入」「DML」「要件登録」**: `/trd_dml` コマンドを実行（要件データベースの構築）
- **「ユーザー視点」「レビュー」「使いやすさ」「初心者」「目的確認」**: `/review_by_user` コマンドを実行（ユーザー視点でのシステムレビュー）
- **「規約」「ルール」「conventions」「標準」「規則」**: `/conventions` コマンドを実行（文脈に応じた規約確認とタスク統合）
- **「エントリーポイント」「nix run」「LLM-first」「対話的」「JSON入力」**: `/entry` コマンドを実行（LLM-firstなエントリポイントの設計）
- **「テスト整合性」「仕様と要件の整合」「テストの価値」「担保内容」「テスト哲学」「tested」**: `/tested` コマンドを実行（テストとアプリケーションの整合性確認）
- **「オーケストレーター」「段階的実行」「ステップ分解」「並列サブタスク」「orchestrate」**: `/orch` コマンドを実行（複雑なタスクの段階的並列実行）
- **「フェーズ」「段階」「ステップ」「分解」「計画」「baby steps」**: `/phase` コマンドを実行（タスクをBaby Stepsに分解、各フェーズにテスト含む）
- **「正規化」「責務分離」「重複排除」「圧縮」「normalize」**: `/normalize` コマンドを実行（責務分離・正規化・可逆圧縮の徹底）
- **「提案」「アイデア」「どうすればいい」「他に案」「propose」**: `/propose` コマンドを実行（文脈に沿った具体的提案と反論想定）
- **「ノート」「メモ」「文書化」「ドキュメント化」「記録」「note」**: `/note` コマンドを実行（議論の一貫性判断と再利用可能なドキュメント作成）

## APE（Automatic Prompt Engineer）ルール
- 全タスク開始時「Let's work step by step」を前置
- コード実装:「understand patterns→implement systematically」
- バグ修正:「reproduce→isolate→fix」  
- リファクタ:「identify→extract→refactor incrementally」
- 完了時自己評価:「✅成功/⚠️要改善/❌失敗」+理由+改善点記録
- 成功パターン蓄積→同種タスクで優先採用

## Git Commit Rules
自らが編集したファイル以外のstagingがないことを確認後、初めてコミット可能

## エラー対応規則（/org実行時）
- エラー発生時は必ず背景と理由を説明する
  - 何が起きたか
  - なぜそのエラーが発生したか
  - どのような解決が必要か
- GraphDBへの問い合わせ時は以下を出力する
  - なぜ問い合わせが必要か
  - 何を調べようとしているか
  - 実行するクエリの内容
- 解決策適用時は選択理由を説明する
  - なぜその解決策を選んだか
  - 他の選択肢との比較
  - 期待される結果

## 位置認識規則（/org実行時）
- 作業開始時は自分の位置と役割を確認する
  - pwdで現在のディレクトリ
  - flake.nixからプロジェクトタイプ
  - GraphDBから期待される状態
- ディレクトリパスを基にGraphDBから文脈を取得
  - 現在のバージョンと期待状態
  - 必要なファイルと実装内容
  - 親ディレクトリとの関係性