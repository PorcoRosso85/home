# MCP Unified Management Tool v2.0 - Production Perfect

**Single source of truth for MCP server configurations with enterprise-grade safety**

## 概要

MCP Unified Management Tool は、複数のAI開発ツール（Claude Code/CLI、Cursor、OpenCode）のMCPサーバー設定を統一管理するProduction-Perfect実装です。マスター設定ファイル（`~/.mcp/servers.json`）から各クライアントの既定場所・形式へ安全に配布します。

## 主要機能・安全改善

### Production-Perfect v2.0の6つの安全改善

1. **flock排他制御** - 同時実行時の競合状態を完全防止
2. **symlink保護** - パストラバーサル攻撃から保護、symlink上書きを拒否
3. **diffフォールバック** - git → diff -u → 並列表示の3段階フォールバック
4. **Claude出力ガード** - `.git`検知によるプロジェクト外書き込み防止
5. **絶対パス検査** - 相対パス検出による不正引数の排除
6. **レジストリ絶対パス化** - CWD独立性確保、プロセス移植性向上

### 既定設定（Safe-by-Default）

- **`--profile full`** - フル機能プロファイル
- **`--target all`** - 全対応クライアント
- **`--check-env on`** - 環境変数検証ON
- **`--expand-env off`** - 環境変数展開OFF（安全性重視）
- **既定dry-run** - `--apply`明示時のみ実際の変更実行

## 対応クライアント・出力先

| クライアント | 出力先 | 対応状況 | 制限事項 |
|-------------|--------|----------|----------|
| **Claude Code/CLI** | `./.claude/mcp.json` | ✅ 完全対応 | プロジェクト内（.git存在）のみ |
| **Cursor/Codex** | `~/.codex/config.toml` | ✅ 完全対応 | - |
| **OpenCode** | `~/.config/opencode/opencode.json` | ⚠️ 暫定SKIP | 仕様確証まで対応保留 |

### Claude出力ガードの動作

```bash
# .gitが存在するプロジェクト内 → 正常出力
cd /path/to/git-project
mcp-sync --target claude --apply
# → ./.claude/mcp.json に出力

# .gitが存在しないディレクトリ → 安全にSKIP
cd /tmp
mcp-sync --target claude --apply
# → WARNING: Claude target skipped - not in a git project
```

## 基本使用方法

### 設定ファイル構造

**マスター設定** (`~/.mcp/servers.json`):
```json
{
  "version": "1.0",
  "mcpServers": {
    "filesystem": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "$HOME/Documents"],
      "env": {},
      "tags": ["all"]
    },
    "github": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${env:GITHUB_TOKEN}"
      },
      "tags": ["claude", "opencode", "codex"]
    }
  },
  "profiles": {
    "minimal": ["filesystem"],
    "full": ["filesystem", "github"]
  }
}
```

### 基本コマンド例

```bash
# 現在の状態確認（安全・読み取り専用）
mcp-sync --inventory

# プレビュー（既定動作・変更なし）
mcp-sync --dry-run

# 実際の変更適用
mcp-sync --apply

# 特定プロファイル・ターゲット指定
mcp-sync --profile minimal --target claude --apply

# 生成ファイルのクリーンアップ（プレビュー）
mcp-sync --clean

# 生成ファイルの実際削除
mcp-sync --clean --apply
```

## 安全機能詳細

### 1. flock排他制御

```bash
# 同時実行時の自動待機・エラー処理
Terminal1: mcp-sync --apply  # 実行中
Terminal2: mcp-sync --apply  # 10秒待機後エラー
# ERROR: Failed to acquire registry lock within 10s (another mcp-sync process may be running)
```

### 2. symlink保護

```bash
# symlinkファイルは上書き拒否
ln -s /etc/passwd ~/.claude/mcp.json
mcp-sync --target claude --apply
# → SKIP: ~/.claude/mcp.json is a symlink (protected from overwrite)
```

### 3. diffフォールバック

```bash
# git利用可能時
mcp-sync --apply
# → git diffで高品質な差分表示

# git無効時
PATH="/tmp:$PATH" mcp-sync --apply
# → 自動的にdiff -u使用

# diff無効時
# → 並列表示（--- New | Old ---）
```

### 4. 絶対パス検査

```json
// 相対パス検出・拒否例
{
  "server": {
    "args": ["./relative/path.js"]  // ❌ 検出されエラー
  }
}
```

```bash
mcp-sync --apply
# ERROR: Relative path detected in server 'test-server' args: ./relative/path.js
# (use absolute paths or environment variables like $HOME)
```

### 5. レジストリ絶対パス化

```bash
# CWD変更しても正常動作
cd /tmp
mcp-sync --apply  # ~/.mcp/state/generated.json の絶対パス管理により正常動作
```

### 6. 環境変数安全展開

```json
{
  "env": {
    "API_KEY": "${env:SECRET_TOKEN}"  // ✅ 安全展開
  },
  "args": ["$HOME/bin/server"]        // ✅ $HOME展開のみ
}
```

## トラブルシューティング

### よくあるエラーと対処法

#### 1. ロック取得失敗
```bash
ERROR: Failed to acquire registry lock within 10s
```
**対処:** 他のmcp-syncプロセス終了を待つか、staleロック削除
```bash
rm -f ~/.mcp/state/generated.json.lock
```

#### 2. Claude出力スキップ
```bash
WARNING: Claude target skipped - not in a git project
```
**対処:** Gitプロジェクト内で実行するか、手動でclaude出力指定
```bash
cd /path/to/git-project
mcp-sync --target claude --apply
```

#### 3. 相対パス検出
```bash
ERROR: Relative path detected in server 'test' args: ./script.js
```
**対処:** 絶対パスまたは環境変数を使用
```json
{
  "args": ["$HOME/bin/script.js"]
}
```

#### 4. 環境変数未定義
```bash
ERROR: Environment variable 'SECRET_TOKEN' is not set
```
**対処:** 環境変数設定または検証無効化
```bash
export SECRET_TOKEN="your-token"
# または
mcp-sync --check-env off --apply
```

### デバッグ・検証方法

```bash
# 詳細ステータス確認
mcp-sync --inventory

# 出力例:
# Status for claude target (file: /path/to/.claude/mcp.json):
#   Current file: exists (hash: abc123...)
#   Registry record: matches (generated by mcp-sync v2.0)
#   Status: Generated file, up to date

# 生成ファイル検出テスト
mcp-sync --clean --dry-run

# レジストリ状態確認
cat ~/.mcp/state/generated.json
```

## 制限事項・将来計画

### 現在の制限

1. **OpenCode** - 仕様確証まで暫定SKIP（警告表示のみ）
2. **Claude** - プロジェクト内（.git存在）のみ対応
3. **環境変数** - `${env:VAR}`形式のみサポート

### 将来計画

1. **OpenCode完全対応** - 公式仕様確定後の即時対応
2. **テンプレートシステム** - 高度なカスタマイズ機能
3. **CI/CD統合** - 自動化・逸脱検知の強化

## コマンドリファレンス

```bash
# 使用法
mcp-sync [OPTIONS]

# 安全オプション
--apply             # 変更適用（既定：dry-runのみ）
--quarantine        # 不明ファイルを.invalidに移動（既定：保持）
--inventory         # 現在のファイル状態表示・終了
--clean             # 生成ファイルのみ除去・隔離（ultra-safe）

# 標準オプション
--profile PROFILE   # 使用プロファイル（既定：full）
--target TARGETS    # 対象クライアント（既定：all）
                    # 利用可能：claude, codex, opencode, all
                    # 注意：opencode は仕様確証まで暫定スキップ
--dry-run          # 変更なしプレビュー（既定動作）
--check-env on|off # 環境変数チェック（既定：on）
--expand-env on|off # 環境変数展開（既定：off）
-h, --help         # ヘルプ表示

# 実用例
mcp-sync --inventory                       # ファイル状態表示
mcp-sync --dry-run                         # 変更プレビュー（既定）
mcp-sync --apply                           # 変更適用
mcp-sync --profile minimal --apply        # minimal適用
mcp-sync --target claude,codex --apply    # 特定ターゲット適用
mcp-sync --target opencode --apply        # OpenCode（警告表示）
mcp-sync --quarantine --apply             # 不明ファイル隔離
mcp-sync --clean                           # クリーンアップ予約（dry-run）
mcp-sync --clean --apply                   # 生成ファイル削除
mcp-sync --clean --quarantine --apply     # 生成ファイル隔離
```

## ファイル構造

```
~/.mcp/
├── servers.json              # マスター設定（編集対象）
├── state/
│   ├── generated.json        # レジストリ（自動管理）
│   └── generated.json.lock   # 排他制御ロック
├── mcp-sync                  # 実行バイナリ
└── README.md                 # このファイル

# 出力先
./.claude/mcp.json                     # Claude Code/CLI設定
~/.codex/config.toml                   # Cursor/Codex設定
~/.config/opencode/opencode.json       # OpenCode設定（将来）
```

---

**動作確認済み: Production-Perfect v2.0の全6安全改善が正常動作、レジストリ絶対パス化システム完全実装、OpenCode暫定SKIP対応済み**

このREADMEによりProduction運用者は全機能を完全理解し、安全かつ効率的にMCP設定を統一管理できます。