# 責務分離ドキュメント

## 概要

本ドキュメントは、flake-graphプロジェクトエコシステムにおける各コンポーネントの責務と境界を明確化し、それぞれの連携方法を定義します。

## コンポーネントの責務

### 1. flake-graph（統合分析・ビジネス価値提供）

**責務：**
- Flakeベースプロジェクトの統合的な分析とレポート生成
- アーキテクチャ分析によるプロジェクト構造の可視化
- 重複コード検出によるコード品質の向上支援
- READMEの整合性チェックによるドキュメント品質管理
- ビジネス価値の提供（開発効率化、品質向上）

**境界：**
- 具体的な分析ロジックは下位コンポーネントに委譲
- UIとレポート生成に特化
- ビジネスルールとワークフローの定義

### 2. vss_kuzu（汎用意味的類似性エンジン）

**責務：**
- テキストの意味的類似性検索の提供
- ベクトル埋め込みの生成と管理
- 高速な類似性検索の実現
- 永続化と検索インデックスの管理

**境界：**
- 言語非依存の汎用的な類似性検索に特化
- ドメイン固有のロジックは含まない
- 純粋な技術コンポーネントとして機能

### 3. similarity（AST構造的類似性検出）

**責務：**
- プログラムコードのAST（抽象構文木）解析
- 構造的な類似性の検出
- 言語固有の構文パターン認識
- コード重複の正確な特定

**境界：**
- コードの構造的側面にフォーカス
- 意味的な解釈は行わない
- 言語ごとの実装を提供

### 4. requirement/graph（要件ベース分析）

**責務：**
- 要件とコードの対応関係の管理
- トレーサビリティの確保
- 要件カバレッジの分析
- 変更影響度の評価

**境界：**
- 要件管理に特化した独立プロジェクト
- 他コンポーネントとは疎結合
- 必要に応じて連携API提供

## 連携アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      flake-graph                             │
│                 （統合分析・ビジネス価値）                    │
│  ┌─────────────┐ ┌──────────────┐ ┌──────────────────┐    │
│  │Architecture │ │  Duplicate   │ │     README       │    │
│  │  Analyzer   │ │  Detector    │ │     Checker      │    │
│  └──────┬──────┘ └──────┬───────┘ └────────┬─────────┘    │
│         │                │                   │               │
│  ┌──────┴────────────────┴───────────────────┴──────────┐  │
│  │                    Adapter Layer                       │  │
│  │  ┌─────────────┐              ┌───────────────────┐  │  │
│  │  │ VSS Adapter │              │Similarity Adapter │  │  │
│  │  └──────┬──────┘              └─────────┬─────────┘  │  │
│  └─────────┼────────────────────────────────┼────────────┘  │
└────────────┼────────────────────────────────┼───────────────┘
             │                                │
             │                                │
┌────────────┼────────────────┐  ┌───────────┼───────────────┐
│            ▼                │  │           ▼               │
│      vss_kuzu               │  │      similarity           │
│  （意味的類似性エンジン）    │  │  （構造的類似性検出）      │
│                             │  │                           │
│  ・ベクトル埋め込み         │  │  ・AST解析               │
│  ・類似性検索               │  │  ・構造パターン認識        │
│  ・永続化管理               │  │  ・言語固有実装           │
└─────────────────────────────┘  └───────────────────────────┘

                    ┌─────────────────────────┐
                    │   requirement/graph     │
                    │  （要件ベース分析）      │
                    │                         │
                    │  ・要件トレーサビリティ  │
                    │  ・カバレッジ分析       │
                    │  ・変更影響評価         │
                    └─────────────────────────┘
```

## 連携方法

### 1. Adapter Pattern による疎結合

- 各コンポーネントは独立して開発・テスト可能
- Adapterを通じて統一的なインターフェースを提供
- 実装の詳細を隠蔽し、変更の影響を最小化

### 2. データフロー

```
ユーザー入力
    │
    ▼
flake-graph CLI
    │
    ├─→ Scanner（ファイル探索）
    │
    ├─→ VSS Adapter ─→ vss_kuzu（意味検索）
    │
    ├─→ Similarity Adapter ─→ similarity（構造分析）
    │
    └─→ レポート生成
```

### 3. 責務の境界維持

- **単一責務の原則**：各コンポーネントは1つの明確な責務を持つ
- **インターフェース分離**：必要最小限のインターフェースのみ公開
- **依存性逆転**：上位層は下位層の抽象に依存

## 統合ポイント

1. **flake-graph → vss_kuzu**
   - 意味的に類似したコードの検索
   - READMEと実装の整合性チェック

2. **flake-graph → similarity**
   - 構造的に重複したコードの検出
   - リファクタリング候補の特定

3. **flake-graph ⟷ requirement/graph（将来的な連携）**
   - 要件とコードの対応関係の可視化
   - 変更による要件への影響分析

## まとめ

この責務分離により、各コンポーネントは独立して進化可能でありながら、統合時には高いビジネス価値を提供できる設計となっています。明確な境界と責務により、保守性と拡張性の両立を実現します。