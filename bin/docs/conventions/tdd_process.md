# TDD開発プロセス

> 📚 関連ファイル
> - 設計原則 → [testing.md](./testing.md)
> - testing.mdの理念に基づいた具体的な実践方法
> - 迷ったらtesting.mdの黄金律に立ち返る

## スタイル: t-wada TDD + Michael Feathers

我々は、和田卓人氏によって提唱されたTDD（テスト駆動開発）のスタイルを基本とし、
Michael Feathersのレガシーコード対応手法を統合した実践的なアプローチを採用します。
これは、単なるテスト手法ではなく、ソフトウェア設計のプロセスです。

## 開発サイクル: Red-Green-Refactor

すべての機能開発は、以下のサイクルを厳守して進めます。

### 基本サイクル

1.  **RED**: まず、失敗するテストコードを書きます。この時点では、実装コードは存在しないか、不完全です。テストを実行し、期待通りに失敗することを確認します。
2.  **GREEN**: 次に、そのテストをパスさせるための最小限のコードを実装します。コードの綺麗さよりも、まずテストを通すことを優先します。
3.  **REFACTOR**: テストが通る状態を維持したまま、実装コードの設計を改善します。重複の排除、命名の改善、可読性の向上などを行います。リファクタリング後も、すべてのテストがパスすることを確認します。

## 開始点による適用パターン

### パターンA: 新規開発TDD（Beck流）

新規機能を開発する場合は、クラシックなRed-Green-Refactorを適用します。

1. **RED**: 存在しない機能の失敗するテストを書く
2. **GREEN**: 最小限の実装でテストを通す
3. **REFACTOR**: 設計を改善する

### パターンB: 既存コード改修TDD（Feathers流）

既存コードを改修する場合は、まず保護してから改修します。

1. **CHARACTERIZE**: 現在の動作を記録するテストを書く（特性テスト）
   - 「正しさ」ではなく「現状」を正確に捉える
   - バグも含めて現在の振る舞いを保護
2. **RED**: 新しい振る舞いの失敗するテストを書く
3. **GREEN**: 最小限の実装でテストを通す
4. **REFACTOR**: 設計を改善する

## 共通テクニック

### Sprout Method（新芽メソッド）
既存の複雑なコードに新機能を追加する際は、新機能を独立したメソッドとして実装します。
既存コードの修正は最小限に留め、新機能部分はTDDで開発します。

### Wrap Method（ラップメソッド）
既存のメソッドを薄いラッパーで包み、前後に新しい処理を追加します。
既存の動作を保護しながら、新機能を追加できます。

### 段階的改善
- 一度にすべてをテスト化しない
- 変更が必要な箇所から段階的にテストを追加
- カバレッジ目標：新規コード80%以上、レガシー改修は変更箇所のみ

## 原則

### 基本原則
- **Incremental Development**: 小さな変更を積み重ねて確実に前進
- **Baby Steps**: 一度に一つの小さな変更のみ行う
- **YAGNI (You Aren't Gonna Need It)**: 必要になるまで実装しない
- **Fail Fast**: 問題を早期に発見し、修正コストを最小化
- **仕様ファースト**: テストは実装ではなく仕様を表現する

### 実践原則
- **テストファーストを厳守**: 実装コードよりも先に、テストコードを必ず書きます。
- **1つのテストに1つのアサーション**: 1つのテストケースでは、1つのことだけを検証することを原則とします。
- **テストは仕様書**: テストコードは、それ自体が実行可能な仕様書として機能するように記述します。
- **モックよりも実際の値**: 可能な限りモックやスタブを使わず、実際のデータ構造や関数を使ってテストします。
- **完璧より変更可能性**: 完璧なテストよりも変更可能性の確保を優先します。

## Redフェーズの重要性

Redフェーズこそがテストの品質を決定する。この段階で：
- テストが仕様を正確に反映しているか確認
- テストが意味のある失敗をするか検証
- 実装前にインターフェースを設計
- テストの独立性と再現性を保証

## Redフェーズチェックリスト

開発開始前に以下を確認：
- □ テストは要件・仕様を正確に反映しているか
- □ テストファイルの配置は規約に従っているか  
- □ テストは実装の詳細ではなく振る舞いを検証しているか
- □ `nix run .#test` でテストが実行可能か
- □ 失敗メッセージが問題を明確に示しているか
- □ Baby Stepsとして適切な粒度か（YAGNIを守っているか）

## 要求事項

- 新機能の追加やバグ修正は、必ず失敗するテストを書くことから始めます。
- テストが失敗することを確認する前に、実装に着手してはいけません。
- リファクタリングは、テストがGREENの時にのみ行います。
- 既存コードの改修時は、まず特性テストで現状を保護してから着手します。
