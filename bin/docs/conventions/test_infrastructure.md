# ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£è¦ç´„

> ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
> - ãƒ†ã‚¹ãƒˆå“²å­¦ â†’ [testing.md](./testing.md)
> - TDDãƒ—ãƒ­ã‚»ã‚¹ â†’ [tdd_process.md](./tdd_process.md)
> - ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒã®æŠ€è¡“çš„è©³ç´°ã‚’å®šç¾©

## ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ã¨å‘½åè¦å‰‡

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
- **åŸå‰‡**: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã™ã‚‹
- **ç†ç”±**: ãƒ†ã‚¹ãƒˆã¨ã‚³ãƒ¼ãƒ‰ã®é–¢é€£æ€§ã‚’æ˜ç¢ºã«ã—ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Š

### ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

| è¨€èª | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å | ä¾‹ |
|------|-----------------|-----|
| Python | `test_<å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«å>.py` | `test_vss_service.py` (vss_service.pyã®ãƒ†ã‚¹ãƒˆ) |
| TypeScript | `<å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«å>.test.ts` | `vssService.test.ts` |
| Go | `<å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«å>_test.go` | `vss_service_test.go` |
| Rust | `mod.rs` å†…ã® `#[cfg(test)]` | `tests/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª |

> ğŸ’¡ ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®1å¯¾1å¯¾å¿œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã®ç™ºè¦‹æ€§ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Š

### é–¢æ•°å‘½åè¦å‰‡

ãƒ†ã‚¹ãƒˆé–¢æ•°ã¯ã€å‹•ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ä»•æ§˜ã‚’èª¬æ˜ã™ã‚‹åå‰ã«ã™ã‚‹ï¼š

| è¨€èª | ãƒ†ã‚¹ãƒˆé–¢æ•°å | ä¾‹ |
|------|-------------|-----|
| Python | `def test_<ä½•ã‚’_ã©ã†ã™ã‚‹ã¨_ã©ã†ãªã‚‹>()` | `def test_vector_search_with_similar_query_returns_relevant_documents()` |
| TypeScript | `test('<ä»•æ§˜ã®èª¬æ˜>', ...)` | `test('vector search with similar query returns relevant documents', ...)` |
| Go | `func Test<WhatWhenThen>(t *testing.T)` | `func TestVectorSearchWithSimilarQueryReturnsRelevantDocuments(t *testing.T)` |
| Rust | `fn test_<what_when_then>()` | `fn test_vector_search_with_similar_query_returns_relevant_documents()` |

> ğŸ’¡ é–¢æ•°åã§ä»•æ§˜ã‚’è¡¨ç¾ã—ã€ãƒ†ã‚¹ãƒˆãŒä½•ã‚’ä¿è¨¼ã™ã‚‹ã‹ã‚’æ˜ç¢ºã«ã™ã‚‹ â†’ [testing.md](./testing.md)

## ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼

### æ¨™æº–ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼

| è¨€èª | ãƒ©ãƒ³ãƒŠãƒ¼ | å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ | ä½¿ç”¨å ´é¢ |
|------|---------|-------------|----------|
| Python | pytest | `pytest` | E2Eãƒ†ã‚¹ãƒˆï¼ˆå…¨è¨€èªå…±é€šï¼‰ã€Pythonå®Ÿè£…ã®å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ |
| TypeScript | node:test / deno test | `npm test` / `deno test` | TypeScriptå®Ÿè£…ã®å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ |
| Go | go test | `go test ./...` | Goå®Ÿè£…ã®å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ |
| Rust | cargo test | `cargo test` | Rustå®Ÿè£…ã®å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ |

> ğŸ’¡ E2Eãƒ†ã‚¹ãƒˆã¯è¨€èªã‚’å•ã‚ãšpytestã§çµ±ä¸€ã€‚çµ±åˆãƒ»å˜ä½“ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…è¨€èªã¨åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ã€‚

### Nixçµ±åˆ

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®åŸºæœ¬æ–¹é‡

- **é–‹ç™ºãƒ»é€šå¸¸åˆ©ç”¨**: `nix shell . -c pytest` ï¼ˆé«˜é€Ÿãƒ»ç›´æ¥å®Ÿè¡Œï¼‰
- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¤œè¨¼**: `nix run .#test` ï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒ»CIç­‰ï¼‰

#### å®Ÿè£…è¦ä»¶

##### 1. packagesã§ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’å†åˆ©ç”¨å¯èƒ½ã«

```nix
# flake.nix
{
  packages.${system}.testEnv = pkgs.python312.withPackages (ps: [
    ps.pytest
    # å¿…è¦ãªä¾å­˜é–¢ä¿‚
  ]);
  
  # è£œåŠ©çš„ä½ç½®ã¥ã‘ï¼šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°æ¤œè¨¼ãŒå¿…è¦ãªå ´åˆã®ã¿
  apps.${system}.test = {
    type = "app";
    program = "${pkgs.writeShellScript "test" ''
      ${packages.${system}.testEnv}/bin/pytest
    ''}";
  };
}
```

##### 2. nix shellã§ã®ç›´æ¥å®Ÿè¡Œã‚’æ¨™æº–åŒ–

```bash
# æ¨™æº–çš„ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆé–‹ç™ºç”¨ï¼‰
nix shell . -c pytest              # Python
nix shell . -c "deno test"         # TypeScript
nix shell . -c "cargo test"        # Rust

# ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®è¨­å®šä¾‹
alias test="nix shell . -c pytest"
```

##### 3. nix runã®ä½¿ç”¨å ´é¢

- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°æ¤œè¨¼ãŒå¿…è¦ãªå ´åˆ
- CI/CDã§ã®å®Œå…¨æ€§ç¢ºèªæ™‚
- ãƒªãƒªãƒ¼ã‚¹å‰ã®æœ€çµ‚ç¢ºèª

## ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š

### ç’°å¢ƒå¤‰æ•°
- `TEST_ENV=true`: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
- `CI=true`: CIç’°å¢ƒã§ã®å®Ÿè¡Œã‚’ç¤ºã™ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
- å˜ä½“ãƒ†ã‚¹ãƒˆ: 5ç§’ä»¥å†…
- çµ±åˆãƒ†ã‚¹ãƒˆ: 30ç§’ä»¥å†…
- E2Eãƒ†ã‚¹ãƒˆ: 5åˆ†ä»¥å†…

### ä¸¦åˆ—å®Ÿè¡Œ
- å¯èƒ½ãªé™ã‚Šä¸¦åˆ—å®Ÿè¡Œã‚’æœ‰åŠ¹ã«ã™ã‚‹
- ãƒ†ã‚¹ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚ã‚’æ’é™¤ã™ã‚‹
- å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é¿ã‘ã‚‹

## CI/CDçµ±åˆ

### GitHub Actionsä¾‹
```yaml
- name: Run tests
  run: nix run .#test
```

### å¿…é ˆãƒã‚§ãƒƒã‚¯
- ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒé–¾å€¤ã‚’æº€ãŸã™ã“ã¨ï¼ˆæ–°è¦ã‚³ãƒ¼ãƒ‰80%ä»¥ä¸Šï¼‰
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒå¦¥å½“ã§ã‚ã‚‹ã“ã¨

## E2Eãƒ†ã‚¹ãƒˆæ§‹é€ 

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
E2Eãƒ†ã‚¹ãƒˆã¯ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ç¯„å›²ã«å¿œã˜ã¦`e2e/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§æ§‹é€ åŒ–ã™ã‚‹ï¼š

```
e2e/
â”œâ”€â”€ internal/      # å†…éƒ¨E2Eãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ test_e2e_*.py
â””â”€â”€ external/      # å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ
    â”œâ”€â”€ flake.nix
    â””â”€â”€ test_e2e_*.py
```

### internalï¼ˆå†…éƒ¨E2Eãƒ†ã‚¹ãƒˆï¼‰
- **å¯¾è±¡**: åŒä¸€flakeå†…ã§ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰å‹•ä½œ
- **å†…å®¹**: CLIã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã€APIå‘¼ã³å‡ºã—ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **å®Ÿè¡Œ**: ãƒ¡ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®ä¸€éƒ¨ã¨ã—ã¦å®Ÿè¡Œ
- **ä¾‹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€ã‚³ãƒãƒ³ãƒ‰ãƒã‚§ãƒ¼ãƒ³ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†

### externalï¼ˆå¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆï¼‰
- **å¯¾è±¡**: ä»–ã®flakeã‹ã‚‰ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹å ´åˆã®å‹•ä½œ
- **å†…å®¹**: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®importã€å…¬é–‹APIã®å¥‘ç´„ã€å‹æƒ…å ±ã®æ­£ç¢ºæ€§
- **å®Ÿè¡Œ**: ç‹¬ç«‹ã—ãŸflakeã¨ã—ã¦åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œ
- **ä¾‹**: `from package import PublicAPI`ã®å‹•ä½œç¢ºèª

### ãƒ†ã‚¹ãƒˆå®Ÿè£…ä¾‹

#### Internal E2Eãƒ†ã‚¹ãƒˆ
```python
# e2e/internal/test_e2e_search_workflow.py
def test_e2e_vector_search_complete_workflow():
    """ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ"""
    # 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
    result = subprocess.run(["nix", "run", ".#init-db"], ...)
    
    # 2. ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
    result = subprocess.run(["nix", "run", ".#load-data"], ...)
    
    # 3. æ¤œç´¢å®Ÿè¡Œ
    result = subprocess.run(["nix", "run", ".#search", "--query", "test"], ...)
    
    # 4. çµæœæ¤œè¨¼
    assert "expected_result" in result.stdout
```

#### External E2Eãƒ†ã‚¹ãƒˆ
```nix
# e2e/external/flake.nix
{
  inputs.target-package.url = "path:../..";
  
  outputs = { self, target-package, ... }: {
    apps.test = {
      type = "app";
      program = "${pkgs.writeShellScript "test-external" ''
        ${pythonEnv}/bin/pytest -v test_e2e_*.py
      ''}";
    };
  };
}
```

```python
# e2e/external/test_e2e_import.py
def test_e2e_package_can_be_imported():
    """ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤–éƒ¨ã‹ã‚‰æ­£ã—ãimportã§ãã‚‹ã“ã¨ã‚’ç¢ºèª"""
    import vss_kuzu
    assert hasattr(vss_kuzu, '__version__')
    assert callable(vss_kuzu.search)
```

### å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã®çµ±åˆ
```nix
# flake.nix
apps.test = {
  type = "app";
  program = "${pkgs.writeShellScript "test" ''
    # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
    ${pythonEnv}/bin/pytest -v src/
    
    # å†…éƒ¨E2Eãƒ†ã‚¹ãƒˆ
    [ -d "e2e/internal" ] && ${pythonEnv}/bin/pytest -v e2e/internal/
    
    # å¤–éƒ¨E2Eãƒ†ã‚¹ãƒˆ
    [ -f "e2e/external/flake.nix" ] && (cd e2e/external && nix run .#test)
    
    # è­¦å‘Šè¡¨ç¤º
    [ ! -d "e2e/internal" ] && echo "âš ï¸  WARNING: No internal E2E tests"
    [ ! -d "e2e/external" ] && echo "âš ï¸  WARNING: No external E2E tests"
  ''}";
};
```

## ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†

### ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
- `fixtures/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
- æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨
- å®Ÿãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºç‰ˆã‚’ä½¿ç”¨

### ãƒ¢ãƒƒã‚¯ã¨ã‚¹ã‚¿ãƒ–
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€šä¿¡ã¯å¿…ãšãƒ¢ãƒƒã‚¯
- æ™‚åˆ»ä¾å­˜ã®ãƒ†ã‚¹ãƒˆã¯æ™‚åˆ»ã‚’å›ºå®š
- ãƒ©ãƒ³ãƒ€ãƒ å€¤ã¯å›ºå®šã‚·ãƒ¼ãƒ‰ã‚’ä½¿ç”¨

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ
1. **ç’°å¢ƒä¾å­˜ã®å¤±æ•—**: ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã‚’ç¢ºèª
2. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¾å­˜**: éåŒæœŸå‡¦ç†ã®é©åˆ‡ãªå¾…æ©Ÿã‚’è¿½åŠ 
3. **é †åºä¾å­˜**: ãƒ†ã‚¹ãƒˆã®ç‹¬ç«‹æ€§ã‚’ç¢ºä¿

### ãƒ‡ãƒãƒƒã‚°æ‰‹æ³•
- `--verbose` ãƒ•ãƒ©ã‚°ã§ãƒ­ã‚°è©³ç´°ã‚’è¡¨ç¤º
- å˜ä¸€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã§ã‚¤solate
- ãƒ†ã‚¹ãƒˆå‰å¾Œã®çŠ¶æ…‹ã‚’å‡ºåŠ›