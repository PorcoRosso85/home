<!DOCTYPE html>
<html>
<head>
    <title>KuzuDB Multi-Browser Sync Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; gap: 20px; }
        .panel { border: 1px solid #ccc; padding: 20px; flex: 1; }
        button { margin: 5px; padding: 10px; }
        .log { background: #f0f0f0; padding: 10px; margin-top: 10px; height: 200px; overflow-y: auto; }
        .users { margin-top: 10px; }
        .user { padding: 5px; background: #e0e0e0; margin: 2px; }
    </style>
</head>
<body>
    <h1>KuzuDB Multi-Browser Sync Demo</h1>
    <p>Open this page in multiple browsers to test synchronization</p>
    
    <div class="container">
        <div class="panel">
            <h2>Controls</h2>
            <button id="createUser">Create Random User</button>
            <button id="refresh">Refresh Users</button>
            <button id="clear">Clear All</button>
            
            <h3>Create Custom User</h3>
            <input type="text" id="userName" placeholder="User name">
            <button id="createCustom">Create</button>
        </div>
        
        <div class="panel">
            <h2>Users in Local KuzuDB</h2>
            <div id="users" class="users"></div>
        </div>
        
        <div class="panel">
            <h2>Event Log</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        // KuzuDB WASM をCDNから読み込み
        import kuzu from 'https://unpkg.com/kuzu-wasm@0.10.0/index.js';
        
        const log = (msg) => {
            const logEl = document.getElementById('log');
            logEl.innerHTML += `${new Date().toLocaleTimeString()}: ${msg}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
        };
        
        class SyncClient {
            constructor() {
                this.clientId = `client_${Math.random().toString(36).substr(2, 9)}`;
                log(`Client ID: ${this.clientId}`);
            }
            
            async initialize() {
                try {
                    // KuzuDB初期化
                    log('Initializing KuzuDB...');
                    await kuzu.init();
                    this.db = new kuzu.Database(':memory:');
                    this.conn = new kuzu.Connection(this.db);
                    
                    // スキーマ作成
                    await this.conn.query(`
                        CREATE NODE TABLE IF NOT EXISTS User(
                            id STRING, 
                            name STRING, 
                            createdBy STRING,
                            PRIMARY KEY(id)
                        )
                    `);
                    log('KuzuDB initialized');
                    
                    // WebSocket接続
                    this.connectWebSocket();
                    
                    // 初期データ取得
                    await this.refreshUsers();
                } catch (error) {
                    log(`Error: ${error.message}`);
                }
            }
            
            connectWebSocket() {
                try {
                    this.ws = new WebSocket('ws://localhost:8080');
                    
                    this.ws.onopen = () => {
                        log('WebSocket connected');
                        // 接続時に履歴を要求
                        this.requestHistory();
                    };
                    
                    this.ws.onmessage = async (event) => {
                        const data = JSON.parse(event.data);
                        log(`Received: ${data.type}`);
                        
                        if (data.type === 'event' && data.payload) {
                            await this.applyRemoteEvent(data.payload);
                        } else if (data.type === 'history' && data.events) {
                            log(`Received history: ${data.events.length} events`);
                            await this.applyHistoryEvents(data.events);
                        }
                    };
                    
                    this.ws.onerror = (error) => {
                        log('WebSocket error');
                    };
                    
                    this.ws.onclose = () => {
                        log('WebSocket disconnected');
                        // 再接続
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                } catch (error) {
                    log(`WebSocket error: ${error.message}`);
                }
            }
            
            async createUser(name) {
                const userId = `u_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                
                // ローカルに作成
                await this.conn.query(`
                    CREATE (u:User {id: $id, name: $name, createdBy: $createdBy})
                `, { id: userId, name: name, createdBy: this.clientId });
                
                log(`Created user: ${name}`);
                
                // 他のクライアントに同期
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'event',
                        payload: {
                            template: 'CREATE_USER',
                            params: { id: userId, name: name, createdBy: this.clientId },
                            clientId: this.clientId,
                            id: `evt_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                            timestamp: Date.now()
                        }
                    }));
                }
                
                await this.refreshUsers();
            }
            
            async applyRemoteEvent(event) {
                if (event.clientId === this.clientId) return; // 自分のイベントは無視
                
                if (event.template === 'CREATE_USER') {
                    try {
                        await this.conn.query(`
                            CREATE (u:User {id: $id, name: $name, createdBy: $createdBy})
                        `, event.params);
                        log(`Synced user: ${event.params.name} from ${event.params.createdBy}`);
                        await this.refreshUsers();
                    } catch (error) {
                        // 既に存在する場合は無視
                        if (!error.message.includes('already exists')) {
                            log(`Sync error: ${error.message}`);
                        }
                    }
                }
            }
            
            async refreshUsers() {
                const result = await this.conn.query(`
                    MATCH (u:User) 
                    RETURN u.id as id, u.name as name, u.createdBy as createdBy
                    ORDER BY u.id
                `);
                const users = await result.getAllObjects();
                
                const usersEl = document.getElementById('users');
                usersEl.innerHTML = users.map(u => 
                    `<div class="user">
                        ${u.name} 
                        <small>(by ${u.createdBy === this.clientId ? 'me' : u.createdBy})</small>
                    </div>`
                ).join('');
                
                log(`Total users: ${users.length}`);
            }
            
            requestHistory() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'requestHistory',
                        fromPosition: 0
                    }));
                    log('Requested history from server');
                }
            }
            
            async applyHistoryEvents(events) {
                log(`Applying ${events.length} historical events...`);
                let appliedCount = 0;
                
                for (const event of events) {
                    // 自分のイベントも含めて履歴を適用
                    if (event.template === 'CREATE_USER' && event.params) {
                        try {
                            await this.conn.query(`
                                CREATE (u:User {id: $id, name: $name, createdBy: $createdBy})
                            `, event.params);
                            appliedCount++;
                        } catch (error) {
                            // 既に存在する場合は無視
                            if (!error.message.includes('already exists')) {
                                log(`History sync error: ${error.message}`);
                            }
                        }
                    }
                }
                
                log(`Applied ${appliedCount} historical events`);
                await this.refreshUsers();
            }
            
            async clearAll() {
                await this.conn.query(`MATCH (u:User) DELETE u`);
                log('Cleared all users');
                await this.refreshUsers();
            }
        }
        
        // クライアント初期化
        const client = new SyncClient();
        window.client = client; // E2Eテスト用
        await client.initialize();
        
        // イベントハンドラー
        document.getElementById('createUser').onclick = async () => {
            const names = ['Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank', 'Grace'];
            const name = names[Math.floor(Math.random() * names.length)] + '_' + Date.now().toString().substr(-4);
            await client.createUser(name);
        };
        
        document.getElementById('createCustom').onclick = async () => {
            const name = document.getElementById('userName').value;
            if (name) {
                await client.createUser(name);
                document.getElementById('userName').value = '';
            }
        };
        
        document.getElementById('refresh').onclick = async () => {
            await client.refreshUsers();
        };
        
        document.getElementById('clear').onclick = async () => {
            if (confirm('Clear all users?')) {
                await client.clearAll();
            }
        };
    </script>
</body>
</html>