# Causal Ordering POC

## 概要

このPOCは、CRDTを使わずに因果順序（Causal Ordering）を使用してKuzuDBの同期を実現することを目的としています。

## アプローチ

1. **操作に一意のIDと依存関係を付与**
   - 各操作には`id`と`dependsOn`（依存する操作のID配列）を持たせる
   - 操作は依存関係が満たされるまで適用されない

2. **インクリメント操作の累積**
   - 並行するインクリメント操作をすべて記録
   - サーバー側で順序を保証して累積

3. **競合解決**
   - SET操作: タイムスタンプベースのLast-Write-Wins
   - INCREMENT操作: すべて累積
   - DELETE/UPDATE: 因果関係に基づいて解決

## ファイル構成

- `causal-sync-client.test.ts` - TDD Redフェーズのテスト
- `causal-sync-client.ts` - クライアント実装（未実装）
- `causal-operation-store.ts` - 操作ストア（未実装）
- `websocket-server.ts` - WebSocketサーバー（ポート8083）

## 実行方法

```bash
# テスト実行（Red phase）
nix run

# または
nix run .#test
```

## テストケース

1. **並行インクリメントのテスト**
   - 5クライアントが同時にカウンターをインクリメント
   - すべての操作が累積され、最終値が5になることを確認

2. **競合する更新の解決**
   - 2クライアントが同じノードを異なる値に更新
   - 一貫した結果になることを確認

3. **依存関係の待機**
   - 依存関係のある操作を逆順で送信
   - 正しい順序で適用されることを確認

## 現在のステータス

🔴 **TDD Red Phase** - テストは失敗することが期待されています。