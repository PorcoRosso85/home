#!/usr/bin/env -S deno run --allow-net --allow-read --allow-write --allow-env

/**
 * ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œãƒ¡ãƒ¼ãƒ«CLI
 * è¤‡æ•°ã®ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å¯¾å¿œã—ã€id/secretãƒšã‚¢ã‚’CLIå¼•æ•°ã§æ¸¡ã›ã‚‹
 */

import { GmailClient } from "./infrastructure/gmail_client.ts";
import { InMemoryDatabaseAdapter } from "./infrastructure/mock_adapters.ts";
import { MailService } from "./application/mail_service.ts";
import { OAuth2Helper, TokenData } from "./infrastructure/oauth_helper.ts";
import { OAUTH2_PROVIDERS } from "./infrastructure/oauth_config.ts";
import type { Account, MailServerAdapter, MailFetchOptions, Email, Draft } from "./mod.ts";

const REDIRECT_URI = "http://localhost:8080/callback";

// ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã®ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
function getTokenFile(provider: string): string {
  return `.${provider}_token.json`;
}

// ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã‚¯ãƒ©ã‚¹ï¼ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œç‰ˆï¼‰
class TokenManager {
  constructor(private provider: string) {}
  
  async loadToken(): Promise<TokenData | null> {
    try {
      const data = await Deno.readTextFile(getTokenFile(this.provider));
      return JSON.parse(data);
    } catch {
      return null;
    }
  }
  
  async saveToken(token: TokenData): Promise<void> {
    await Deno.writeTextFile(
      getTokenFile(this.provider),
      JSON.stringify(token, null, 2)
    );
  }
  
  async getValidToken(oauth: OAuth2Helper): Promise<string | null> {
    const token = await this.loadToken();
    if (!token) return null;
    
    // æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†å‰ã«æ›´æ–°ï¼‰
    if (token.expiresAt && token.expiresAt - Date.now() < 5 * 60 * 1000) {
      if (token.refreshToken) {
        console.log("ğŸ”„ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›´æ–°ä¸­...");
        const newToken = await oauth.refreshToken(token.refreshToken);
        await this.saveToken(newToken);
        return newToken.accessToken;
      }
      return null;
    }
    
    return token.accessToken;
  }
}

// ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
class ProviderMailAdapter implements MailServerAdapter {
  private tokenManager: TokenManager;
  private oauth: OAuth2Helper;
  private accessToken?: string;
  
  constructor(
    private provider: string,
    clientId?: string,
    clientSecret?: string
  ) {
    this.tokenManager = new TokenManager(provider);
    this.oauth = new OAuth2Helper(provider, REDIRECT_URI, clientId, clientSecret);
  }
  
  async authenticate(account: Account): Promise<{ success: boolean; error?: string }> {
    // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
    const token = await this.tokenManager.getValidToken(this.oauth);
    if (token) {
      this.accessToken = token;
      return { success: true };
    }
    
    // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹
    console.log("ğŸ” èªè¨¼ãŒå¿…è¦ã§ã™ã€‚");
    console.log(`\n${this.oauth.getProviderName()}ã®èªè¨¼æ‰‹é †:`);
    console.log("\n1. åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:");
    console.log("   nix run .#oauth -- server");
    console.log("\n2. ä»¥ä¸‹ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã:");
    console.log(`   ${this.oauth.getAuthorizationUrl("auth-state")}`);
    console.log(`\n3. ${this.oauth.getProviderName()}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã€æ¨©é™ã‚’è¨±å¯`);
    console.log("\n4. è¡¨ç¤ºã•ã‚ŒãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼");
    console.log("\n5. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ:");
    console.log(`   nix run .#mail -- ${this.provider} auth --code <èªè¨¼ã‚³ãƒ¼ãƒ‰>`);
    
    return { 
      success: false, 
      error: "èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ä¸Šè¨˜ã®æ‰‹é †ã«å¾“ã£ã¦ãã ã•ã„ã€‚" 
    };
  }
  
  async fetchEmails(account: Account, options: MailFetchOptions): Promise<Email[]> {
    if (!this.accessToken) {
      throw new Error("èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }
    
    // ç¾åœ¨ã¯Gmailã®ã¿ã‚µãƒãƒ¼ãƒˆ
    if (this.provider === "gmail") {
      const client = new GmailClient(this.accessToken);
      return client.fetchEmails(options);
    } else {
      throw new Error(`${this.provider}ã®ãƒ¡ãƒ¼ãƒ«å–å¾—ã¯æœªå®Ÿè£…ã§ã™`);
    }
  }
  
  async sendEmail(account: Account, draft: Draft): Promise<{ success: boolean; messageId?: string }> {
    throw new Error("é€ä¿¡ã¯æœªå®Ÿè£…");
  }
  
  async exchangeCodeForToken(code: string): Promise<void> {
    const token = await this.oauth.exchangeAuthorizationCode(code, "auth-state");
    await this.tokenManager.saveToken(token);
    this.accessToken = token.accessToken;
    
    console.log(`âœ… ${this.oauth.getProviderName()}ã®èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸï¼`);
  }
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
async function main() {
  const args = Deno.args;
  
  // ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
  if (args.length === 0 || args[0] === "help" || args[0] === "--help") {
    console.log(`
ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œãƒ¡ãƒ¼ãƒ«CLI

ä½¿ç”¨æ–¹æ³•:
  nix run .#mail -- <provider> [command] [options]

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼:
  ${Object.keys(OAUTH2_PROVIDERS).join(", ")}

ã‚³ãƒãƒ³ãƒ‰:
  fetch [options]        # ãƒ¡ãƒ¼ãƒ«ã‚’å–å¾—
  auth                   # èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
  auth --code <code>     # èªè¨¼ã‚³ãƒ¼ãƒ‰ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  --client-id <id>       # OAuth2 Client IDï¼ˆç’°å¢ƒå¤‰æ•°ã‚ˆã‚Šå„ªå…ˆï¼‰
  --client-secret <sec>  # OAuth2 Client Secretï¼ˆç’°å¢ƒå¤‰æ•°ã‚ˆã‚Šå„ªå…ˆï¼‰
  --unread               # æœªèª­ãƒ¡ãƒ¼ãƒ«ã®ã¿
  --limit <number>       # å–å¾—ä»¶æ•°åˆ¶é™
  --since <date>         # æŒ‡å®šæ—¥ä»¥é™ã®ãƒ¡ãƒ¼ãƒ«

ç’°å¢ƒå¤‰æ•°:
  <PROVIDER>_CLIENT_ID     # ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®Client IDï¼ˆä¾‹: GMAIL_CLIENT_IDï¼‰
  <PROVIDER>_CLIENT_SECRET # ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®Client Secret

ä¾‹:
  # Gmail
  nix run .#mail -- gmail fetch --unread --limit 5
  nix run .#mail -- gmail auth --code abc123
  
  # Outlookï¼ˆCLIå¼•æ•°ã§ID/SecretæŒ‡å®šï¼‰
  nix run .#mail -- outlook fetch \\
    --client-id "your-id" \\
    --client-secret "your-secret"
`);
    return;
  }
  
  // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’å–å¾—
  const provider = args[0].toLowerCase();
  if (!OAUTH2_PROVIDERS[provider]) {
    console.error(`âŒ ä¸æ˜ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${provider}`);
    console.error(`å¯¾å¿œãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${Object.keys(OAUTH2_PROVIDERS).join(", ")}`);
    Deno.exit(1);
  }
  
  // Client ID/Secretã‚’å–å¾—ï¼ˆCLIå¼•æ•°å„ªå…ˆï¼‰
  let clientId: string | undefined;
  let clientSecret: string | undefined;
  
  const clientIdIndex = args.indexOf("--client-id");
  if (clientIdIndex !== -1 && args[clientIdIndex + 1]) {
    clientId = args[clientIdIndex + 1];
  }
  
  const clientSecretIndex = args.indexOf("--client-secret");
  if (clientSecretIndex !== -1 && args[clientSecretIndex + 1]) {
    clientSecret = args[clientSecretIndex + 1];
  }
  
  // ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
  const db = new InMemoryDatabaseAdapter();
  const mailServer = new ProviderMailAdapter(provider, clientId, clientSecret);
  const mailService = new MailService(db, mailServer);
  
  // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
  const account: Account = {
    id: `${provider}-auto`,
    email: Deno.env.get(`${provider.toUpperCase()}_ACCOUNT`) || `user@${provider}.com`,
    provider: provider,
    authType: "oauth2",
    createdAt: new Date(),
    updatedAt: new Date()
  };
  await db.saveAccount(account);
  
  // ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
  const command = args[1] || "fetch";
  
  // èªè¨¼ã‚³ãƒãƒ³ãƒ‰
  if (command === "auth") {
    const codeIndex = args.indexOf("--code");
    if (codeIndex !== -1 && args[codeIndex + 1]) {
      // èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«äº¤æ›
      try {
        await mailServer.exchangeCodeForToken(args[codeIndex + 1]);
      } catch (error) {
        console.error("âŒ ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ã‚¨ãƒ©ãƒ¼:", error.message);
        Deno.exit(1);
      }
    } else {
      // èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹
      const authResult = await mailServer.authenticate(account);
      if (authResult.success) {
        console.log(`âœ… ${provider}ã¯æ—¢ã«èªè¨¼æ¸ˆã¿ã§ã™ã€‚`);
      }
    }
  }
  
  // ãƒ¡ãƒ¼ãƒ«å–å¾—ã‚³ãƒãƒ³ãƒ‰
  else if (command === "fetch") {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const authResult = await mailServer.authenticate(account);
    if (!authResult.success) {
      console.error("âŒ", authResult.error);
      Deno.exit(1);
    }
    
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ¼ã‚¹
    const options: MailFetchOptions = {
      account: account.email,
      unreadOnly: args.includes("--unread"),
      limit: undefined,
      since: undefined
    };
    
    const limitIndex = args.indexOf("--limit");
    if (limitIndex !== -1 && args[limitIndex + 1]) {
      options.limit = parseInt(args[limitIndex + 1]);
    }
    
    const sinceIndex = args.indexOf("--since");
    if (sinceIndex !== -1 && args[sinceIndex + 1]) {
      options.since = new Date(args[sinceIndex + 1]);
    }
    
    try {
      console.log(`ğŸ“§ ${provider}ã®ãƒ¡ãƒ¼ãƒ«ã‚’å–å¾—ä¸­...`);
      const emails = await mailService.fetchEmails(options);
      
      console.log(`\nâœ… å–å¾—ã—ãŸãƒ¡ãƒ¼ãƒ«: ${emails.length}ä»¶\n`);
      
      for (const email of emails) {
        console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
        console.log(`ğŸ“§ ${email.subject}`);
        console.log(`ğŸ‘¤ ${email.fromAddress}`);
        console.log(`ğŸ“… ${email.receivedAt.toLocaleString("ja-JP")}`);
        console.log(`ğŸ“– ${email.isRead ? "æ—¢èª­" : "æœªèª­"}`);
        
        if (email.bodyText && email.bodyText.length > 0) {
          const preview = email.bodyText.substring(0, 100).replace(/\n/g, " ");
          console.log(`\n${preview}${email.bodyText.length > 100 ? "..." : ""}`);
        }
      }
      
      if (emails.length === 0) {
        console.log("ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      }
    } catch (error) {
      console.error("âŒ ã‚¨ãƒ©ãƒ¼:", error.message);
      Deno.exit(1);
    }
  }
  
  else {
    console.error(`âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}`);
    console.error(`ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º: nix run .#mail help`);
    Deno.exit(1);
  }
}

// å®Ÿè¡Œ
if (import.meta.main) {
  main().catch(error => {
    console.error("âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:", error);
    Deno.exit(1);
  });
}