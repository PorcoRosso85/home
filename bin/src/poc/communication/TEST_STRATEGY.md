# テスト戦略 - n8nテストパターンの活用

## 概要
n8nの包括的なテストパターンを参考に、高品質なテストを効率的に実装します。

## n8nから学んだテストパターン

### 1. **モックパターン**
```typescript
// n8n: nockを使用したHTTPモック
nock(baseUrl)
  .get('/gmail/v1/users/me/messages')
  .reply(200, mockData);

// Deno版: fetchのモック
globalThis.fetch = async (url) => {
  return new Response(JSON.stringify(mockData));
};
```

### 2. **テストデータの構造化**
- **フィクスチャ**: 実際のAPIレスポンスを模倣
- **ヘルパー関数**: テストデータ作成の簡略化
- **エッジケース**: 空のレスポンス、エラー、ページネーション

### 3. **認証フローの完全性**
n8nのOAuth2テストから抽出した重要ケース：
- CSRF保護（stateパラメータ）
- トークン有効期限
- リフレッシュトークン
- 認証エラー処理

### 4. **API操作のカバレッジ**
GmailV2.node.test.tsから学んだテストケース：
- クエリパラメータの正確性
- ページネーション処理
- Base64エンコーディング
- ヘッダー解析

## 実装済みテスト

### 1. `oauth_flow.test.ts`
- ✅ 認証URL生成
- ✅ 必須パラメータ検証
- ✅ プロバイダー固有設定
- ✅ エラーハンドリング
- 🔲 トークン交換（fetchモック待ち）
- 🔲 トークンリフレッシュ

### 2. `gmail_api.test.ts`
- ✅ メール一覧取得
- ✅ クエリパラメータ構築
- ✅ ページネーション
- ✅ APIエラー処理
- ✅ Base64デコード
- 🔲 添付ファイル処理
- 🔲 マルチパートメッセージ

### 3. `oauth_config.test.ts`（実装済み）
- ✅ プロバイダー設定
- ✅ 環境変数/CLI引数の優先順位
- ✅ エラーケース

## テストの利点

### 1. **品質保証**
- n8nで実証済みのテストケース
- プロダクション環境のエッジケースをカバー

### 2. **開発効率**
- テストファーストで実装の方向性が明確
- リファクタリング時の安全性

### 3. **ドキュメント性**
- テストがAPIの使用例として機能
- 期待される動作の明確化

## 次のステップ

1. **fetchモックの改善**
   ```typescript
   // Deno用のモックライブラリ作成
   class FetchMock {
     private routes: Map<string, Response>;
     mock(pattern: string, response: any) { ... }
   }
   ```

2. **統合テストの追加**
   - CLI全体のE2Eテスト
   - 実際のOAuth2フロー（手動テスト）

3. **パフォーマンステスト**
   - 大量メール取得
   - 並行リクエスト処理

## まとめ
n8nのテストパターンを参考にすることで：
- **実装前に品質を確保**
- **車輪の再発明を最小限に**
- **プロダクションレベルのカバレッジ**

テストを先に書くことで、実装の詳細に囚われず、インターフェースと動作に集中できます。