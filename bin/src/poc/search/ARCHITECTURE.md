# 検索システムアーキテクチャ

## 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Search System                                │
├─────────────────────┬─────────────────────┬─────────────────────────┤
│    VSS Module       │ Embeddings Module   │   Hybrid Module         │
│   (Mock impl)       │  (Real impl)        │     (Future)            │
├─────────────────────┼─────────────────────┼─────────────────────────┤
│                     │                     │                         │
│  ┌─────────────┐   │  ┌──────────────┐  │  ┌─────────────────┐   │
│  │ Requirement │   │  │ Domain Layer  │  │  │ Hybrid Service  │   │
│  │  Embedder   │   │  ├──────────────┤  │  ├─────────────────┤   │
│  │ (384 dims)  │   │  │ • Types      │  │  │ • Keyword Search│   │
│  └─────────────┘   │  │ • Interfaces │  │  │ • Vector Search │   │
│         ↓          │  └──────────────┘  │  │ • Score Fusion  │   │
│  ┌─────────────┐   │         ↓          │  └─────────────────┘   │
│  │ Similarity  │   │  ┌──────────────┐  │           ↓             │
│  │   Search    │   │  │ Application  │  │  ┌─────────────────┐   │
│  └─────────────┘   │  │    Layer     │  │  │ Result Merger   │   │
│         ↓          │  ├──────────────┤  │  └─────────────────┘   │
│  ┌─────────────┐   │  │ • Use Cases  │  │                         │
│  │   KuzuDB    │   │  └──────────────┘  │                         │
│  │   Native    │   │         ↓          │                         │
│  │    VSS      │   │  ┌──────────────┐  │                         │
│  └─────────────┘   │  │Infrastructure│  │                         │
│                     │  ├──────────────┤  │                         │
│                     │  │ • Ruri Model │  │                         │
│                     │  │ • KuzuDB Repo│  │                         │
│                     │  │ • Subprocess │  │                         │
│                     │  └──────────────┘  │                         │
│                     │         ↓          │                         │
│                     │  ┌──────────────┐  │                         │
│                     │  │ KuzuDB with  │  │                         │
│                     │  │VECTOR Ext    │  │                         │
│                     │  └──────────────┘  │                         │
└─────────────────────┴─────────────────────┴─────────────────────────┘
```

## データフロー

```
User Query
    │
    ├─────────────────────────────────────────┐
    │                                         │
    ▼                                         ▼
VSS Path (384-dim)                    Embeddings Path (256-dim)
    │                                         │
    │  1. Hash-based                          │  1. Ruri v3 Model
    │     Mock Embedding                      │     Real Embedding
    │                                         │
    │  2. KuzuDB Native                       │  2. Subprocess Wrapper
    │     Vector Search                       │     (pytest safety)
    │                                         │
    │  3. Return Rankings                     │  3. KuzuDB VECTOR
    │                                         │     Extension Search
    │                                         │
    ▼                                         ▼
Results (Mock)                          Results (Real)
    │                                         │
    └─────────────────┬───────────────────────┘
                      │
                      ▼
              Future: Hybrid Results
              (Score Fusion & Dedup)
```

## テスト戦略

```
┌─────────────────────────────────────────────────────────┐
│                    Test Hierarchy                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Unit Tests          Integration Tests    E2E Tests    │
│  ┌─────────┐        ┌──────────────┐    ┌──────────┐  │
│  │ VSS     │        │ search/      │    │ Future   │  │
│  │ • Mock  │        │ test_*.py    │    │ Hybrid   │  │
│  │ • Fast  │        │              │    │ Tests    │  │
│  └─────────┘        │ • Module     │    └──────────┘  │
│                     │   Imports    │                   │
│  ┌─────────┐        │              │                   │
│  │Embeddings│       │ • Dimension  │                   │
│  │ • Real  │        │   Check      │                   │
│  │ • Wrapper│       │              │                   │
│  └─────────┘        └──────────────┘                   │
│                                                         │
│  pytest環境          Mixed環境          Production      │
│  (Subprocess)        (Direct+Sub)       (Direct only)   │
└─────────────────────────────────────────────────────────┘
```

## 技術的課題と解決策

```
┌─────────────────────────────┬─────────────────────────────┐
│         課題                │         解決策              │
├─────────────────────────────┼─────────────────────────────┤
│ 1. pytest + VECTOR segfault │ Subprocess wrapper pattern  │
│                             │ (vector_subprocess_wrapper) │
├─────────────────────────────┼─────────────────────────────┤
│ 2. 異なるベクトル次元       │ 各モジュール独立動作        │
│    VSS: 384, Emb: 256      │ 将来: 次元変換レイヤー      │
├─────────────────────────────┼─────────────────────────────┤
│ 3. モック vs 実装の統合     │ Hybrid moduleで抽象化       │
│                             │ インターフェース統一        │
├─────────────────────────────┼─────────────────────────────┤
│ 4. パフォーマンス           │ • キャッシング             │
│                             │ • バッチ処理               │
│                             │ • 非同期化（将来）         │
└─────────────────────────────┴─────────────────────────────┘
```