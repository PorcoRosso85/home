---
url: https://github.com/cachix/devenv/issues/1264
saved_at: 2025-07-16T20:35:14Z
title: Python + Poetry + Numpy ImportError with multiple python versions #1264
domain: github.com
---

[cachix](/cachix) / **[devenv](/cachix/devenv)** Public

# Python + Poetry + Numpy ImportError with multiple python versions #1264

[New issue](/login?return_to=)

Copy link

[New issue](/login?return_to=)

Copy link

Open

Open

[Python + Poetry + Numpy ImportError with multiple python versions](#top) #1264

Copy link

Labels

[question Further information is requested](https://github.com/cachix/devenv/issues?q=state%3Aopen%20label%3A%22question%22) Further information is requested

[@ianepreston](https://github.com/ianepreston) ## Description

[@ianepreston](https://github.com/ianepreston)

[ianepreston](https://github.com/ianepreston)

opened [on Jun 11, 2024](https://github.com/cachix/devenv/issues/1264#issue-2345229406)

Issue body actions

This feels very similar to [#1095](https://github.com/cachix/devenv/issues/1095) but I think it's different enough to warrant a new issue, although if you'd prefer me to close this and carry on that thread I'm happy to do so.

I've been trying to build out a devenv with python and poetry that can support libraries like numpy. As with the poster in [#1095](https://github.com/cachix/devenv/issues/1095) I was initially getting the `Original error was: libz.so.1: cannot open shared object file: No such file or directory` error.
Updating my `flake.nix` to include `libraries = with pkgs; [zlib];` in the python section, blowing away `.venv`, `.direnv`, `flake.lock`, and `poetry.lock` seemed to resolve the issue, I was able to launch python and import numpy. However, I got greedy. I want to be able to develop against multiple versions of python so I have multiple dev shells defined for each python version I want to support in the library I'm developing. Activating one of those environments caused the original import error to return. Switching back to the previously working environment also produces the error now, and deleting all the above mentioned files and restarting no longer resolves the issue for any environments. I'm really at a loss on this one. I get it not working, I get it working, but I don't get it working then not working. I assume there's some hidden file or setting I'm not touching but I don't know what it could be.

My `flake.nix` looks like this:

```
{
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    nixpkgs-python.url = "github:cachix/nixpkgs-python";
    nixpkgs-python.inputs = { nixpkgs.follows = "nixpkgs"; };
    devenv.url = "github:cachix/devenv";
  };

  nixConfig = {
    extra-trusted-public-keys =
      "devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=";
    extra-substituters = "https://devenv.cachix.org";
  };

  outputs = { self, nixpkgs, devenv, ... }@inputs:
    let
      system = "x86_64-linux";
      pkgs = import nixpkgs { system = system; };
      # A list of shell names and their Python versions
      pythonVersions = {
        python39 = "3.9";
        python310 = "3.10";
        python311 = "3.11";
        default = "3.10";
      };
      # A function to make a shell with a python version
      makePythonShell = shellName: pythonVersion:
        devenv.lib.mkShell {
          inherit inputs pkgs;
          modules = [
            ({ pkgs, config, ... }: {
              languages.python = {
                version = pythonVersion;
                libraries = with pkgs; [ zlib ];
                enable = true;
                venv.enable = true;
                poetry = {
                  enable = true;
                  activate.enable = true;
                  package = pkgs.poetry;
                  install = {
                    enable = true;
                    # compile = true;
                    installRootPackage = true;
                  };
                };
              };
            })
          ];
        };
    in {
      # mapAttrs runs the given function (makePythonShell) against every value
      # in the attribute set (pythonVersions) and returns a new set
      devShells.x86_64-linux = builtins.mapAttrs makePythonShell pythonVersions;
    };
}
```

`pyproject.toml` is very simple, I have a couple of basic dependencies that will work to ensure my environment is being activated and then a requirement for pandas:

```
[tool.poetry]
name = "nixpytesting"
version = "0.1.0"
description = "Figuring out nix and python"
authors = ["Ian Preston"]
readme = "README.md"

[tool.poetry.dependencies]
python = "^3.9"
requests = "^2.32.3"
pandas = "^2.2.2"

[tool.poetry.group.dev.dependencies]
ruff = "^0.4.8"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

Any advice for additional troubleshooting I can try would be appreciated.

saucoide, noamsto and dixslyf

## Metadata

## Metadata

### Assignees

No one assigned

### Labels

[question Further information is requested](https://github.com/cachix/devenv/issues?q=state%3Aopen%20label%3A%22question%22) Further information is requested

### Type

No type

### Projects

No projects

### Milestone

No milestone

### Relationships

None yet

### Development

No branches or pull requests

## Issue actions
