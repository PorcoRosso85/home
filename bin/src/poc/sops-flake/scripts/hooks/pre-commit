#!/usr/bin/env bash
# Git pre-commit hook to block plaintext secrets
# - Checks only staged files
# - Blocks env.sh/.env files and unencrypted files under secrets/

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Collect staged files
mapfile -t STAGED < <(git diff --cached --name-only --diff-filter=ACMRT)

if [[ ${#STAGED[@]} -eq 0 ]]; then
  exit 0
fi

fail=0
bad_files=()

is_text() {
  local p="$1"
  # Treat as text if file(1) says text or empty; ignore binaries
  file -b "$p" 2>/dev/null | grep -qi 'text' || return 1
}

for f in "${STAGED[@]}"; do
  # Skip deleted or non-existent
  [[ -f "$f" ]] || continue

  # Block common plaintext env files (must use encrypted variants)
  if [[ "$f" =~ (^|/)env\.sh$ || "$f" =~ (^|/)\.env(\..*)?$ ]]; then
    echo -e "${RED}✗ Blocked:${NC} $f (commit encrypted env instead: env.sh.enc)"
    bad_files+=("$f")
    fail=1
    continue
  fi

  # Check only typical text formats
  if [[ "$f" =~ ^secrets/.*\.(yaml|yml|json|toml|ini|txt|conf)$ ]]; then
    is_text "$f" || continue
    if ! grep -q 'ENC\[AES256_GCM' "$f"; then
      echo -e "${RED}✗ Unencrypted secret:${NC} $f"
      bad_files+=("$f")
      fail=1
    fi
  fi
done

if [[ $fail -ne 0 ]]; then
  echo "---"
  echo -e "${YELLOW}Fix suggestions:${NC}"
  echo "  - Encrypt each file: sops -e -i <file>"
  echo "  - For env files, commit env.sh.enc and never env.sh/.env"
  echo "  - Run: scripts/check-no-plaintext-secrets.sh (full check)"
  exit 1
fi

echo -e "${GREEN}✓ Secrets check passed${NC}"
exit 0

