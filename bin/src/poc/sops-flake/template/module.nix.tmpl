{ config, lib, pkgs, ... }:

with lib;

let
  cfg = config.services.{{SERVICE_NAME}};
in
{
  options.services.{{SERVICE_NAME}} = {
    enable = mkEnableOption "{{DESCRIPTION}}";
    
    user = mkOption {
      type = types.str;
      default = "{{SERVICE_USER}}";
      description = "User to run the service as";
    };
    
    group = mkOption {
      type = types.str;
      default = "{{SERVICE_USER}}";
      description = "Group to run the service as";
    };
  };

  config = mkIf cfg.enable {
    # Application-specific secrets
    sops.secrets = {
      "api-key" = {
        sopsFile = ./secrets/app.yaml;
        owner = cfg.user;
        group = cfg.group;
      };
      "db-password" = {
        sopsFile = ./secrets/app.yaml;
        owner = cfg.user;
        group = cfg.group;
      };
    };

    # Create service user
    users.users.${cfg.user} = {
      isSystemUser = true;
      group = cfg.group;
    };
    users.groups.${cfg.group} = {};

    # systemd service
    systemd.services.{{SERVICE_NAME}} = {
      description = "{{DESCRIPTION}}";
      after = [ "network.target" ];
      wantedBy = [ "multi-user.target" ];

      serviceConfig = {
        Type = "simple";
        User = cfg.user;
        Group = cfg.group;
        EnvironmentFile = [
          config.sops.secrets."api-key".path
          config.sops.secrets."db-password".path
        ];
        ExecStart = "${pkgs.{{PROJECT_NAME}}}/bin/{{PROJECT_NAME}}";
        Restart = "always";
        RestartSec = "10";
      };
    };
  };
}
