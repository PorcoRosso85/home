DELETE THIS FILE AFTER PHASE 1.2 IS COMPLETED

Phase 1.2 — Edge-Min（単一Worker + rwsdk-init 統合）

目的
- 最小の Cloudflare Worker を 1 本だけ導入し、/ingest /r/:id /sitemap* /revalidate を提供。
- rwsdk-init（SSR/Asset/Routingのリファレンス）を interfaces/site として並走させる。

スコープ
- interfaces/edge-min: 最小 Worker 実装（D1/KV バインド）
- infra-config/cloudflare: wrangler.shared.toml, d1.migrations（events/url_index）
- rwsdk-init を flake inputs で参照し devShell を流用（任意）

作業ツリー（作成）
- interfaces/edge-min/
  - src/ingest.ts        # pageview/click/utm 受信
  - src/redirect.ts      # /r/:id → 302 + クリック記録
  - src/sitemap.ts       # /sitemap.xml（小規模は単一）
  - src/revalidate.ts    # プリウォーム受付（擬似ISR）
  - wrangler.toml        # extends = ../../infra-config/cloudflare/wrangler.shared.toml
- infra-config/cloudflare/
  - wrangler.shared.toml # D1/KV の共有束縛
  - d1.migrations/0001_init.sql # events, url_index の DDL

重要設定（wrangler.shared.toml サンプル）
"""
name = "pseo-shared"
compatibility_date = "2024-09-23"

[vars]
STAGE = "staging" # or production
CANONICAL_HOST = "" # 未確定なら空でOK

[[d1_databases]]
binding = "DB"
database_name = "pseo"
database_id = "<to-fill>"

[[kv_namespaces]]
binding = "FLAGS"
id = "<to-fill>"
"""

D1 マイグレーション（0001_init.sql の例）
"""
-- events: pageview/click/utm の生ログ
create table if not exists events (
  id integer primary key autoincrement,
  ts integer not null,
  ip_hash text,
  ua text,
  type text not null,         -- 'pageview' | 'click'
  path text not null,
  ref text,
  utm_source text,
  utm_medium text,
  utm_campaign text,
  meta_json text
);

-- url_index: サイトマップ用 URL 台帳
create table if not exists url_index (
  id integer primary key autoincrement,
  slug text unique not null,
  lastmod text,
  status text not null default 'noindex' -- 'noindex' | 'index'
);
"""

flake inputs（rwsdk-init を参照する例）
"""
inputs.rwsdk-init.url = "path:../rwsdk-init";
# rwsdk-init 内の flake-readme を上書きフォロー（相対参照の解決対策）
inputs.rwsdk-init.inputs.flake-readme.follows = "flake-readme";
"""

実装チェックリスト
- [ ] ingest.ts が JSON を受け取り events へ保存（SSR環境からの副作用なし）
- [ ] redirect.ts が id→外部URL へ 302 し、クリックを events に保存
- [ ] sitemap.ts が url_index から sitemap.xml を返す（小規模時は単一ファイル）
- [ ] revalidate.ts が URL を受け取り、プリウォーム（単純に GET を投げるだけで可）
- [ ] wrangler.shared.toml を作成し、edge-min の wrangler.toml で extends 設定
- [ ] interfaces/site（rwsdk-init）の build/deploy が引き続き成功

受け入れ基準（DoD）
- [ ] edge-min の 4 エンドポイントへ疎通（200/302）
- [ ] D1(events/url_index) への書込み/参照が成功
- [ ] site（rwsdk-init）と edge-min が同時デプロイ可能（独立）

ロールバック
- edge-min を無効化しても site は稼働（役割分離）。

備考
- 1.2 では i18n/Queues/R2/RateLimit/Observability は対象外（1.3 以降）。
