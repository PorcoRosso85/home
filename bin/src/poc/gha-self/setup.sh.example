#!/usr/bin/env bash
# GitHub Actions Self-hosted Runner Setup Reference
# This file demonstrates runner setup patterns - DO NOT EXECUTE
# POC責務: self-hosted runner登録手順の文書化

#==============================================================================
# ENVIRONMENT VALIDATION
#==============================================================================

# Check prerequisites before setup
validate_environment() {
    # Check if in nix develop shell (nixpkgs provides config.sh)
    which config.sh || echo "Error: Not in nix develop shell"
    
    # Check GitHub CLI authentication
    gh auth status || echo "Error: GitHub CLI not authenticated"
    
    # Check repository access
    gh repo view || echo "Error: Cannot access repository"
    
    # Check Docker daemon (if needed for containerized actions)
    docker info || echo "Warning: Docker not available"
}

#==============================================================================
# TRADITIONAL SETUP (Manual Token)
#==============================================================================

# Setup using manually obtained token from GitHub UI
setup_with_manual_token() {
    # Token obtained from: Settings -> Actions -> Runners -> New self-hosted runner
    local TOKEN="AABBCCDDEEFFGGHHIIJJKKLLMMNN"
    local REPO_URL="https://github.com/username/repository"
    
    # Configure runner with manual settings
    config.sh \
        --url "$REPO_URL" \
        --token "$TOKEN" \
        --name "manual-runner-$(hostname)" \
        --work "_work" \
        --labels "self-hosted,Linux,X64" \
        --unattended \
        --replace
}

#==============================================================================
# MODERN SETUP (GitHub CLI)
#==============================================================================

# Setup using GitHub CLI for automation
setup_with_gh_cli() {
    # Get repository name automatically
    local REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
    
    # Fetch registration token via API
    local TOKEN=$(gh api \
        --method POST \
        "/repos/${REPO}/actions/runners/registration-token" \
        -q .token)
    
    # Configure with automatic settings
    config.sh \
        --url "https://github.com/${REPO}" \
        --token "$TOKEN" \
        --name "cli-runner-$(hostname)" \
        --work "_work" \
        --labels "self-hosted,nix" \
        --unattended
}

#==============================================================================
# POC SETUP (Ephemeral Mode)
#==============================================================================

# Recommended setup for POC testing
setup_ephemeral_poc() {
    local REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
    local TOKEN=$(gh api --method POST "/repos/${REPO}/actions/runners/registration-token" -q .token)
    
    # Ephemeral flag ensures automatic cleanup after one job
    config.sh \
        --url "https://github.com/${REPO}" \
        --token "$TOKEN" \
        --name "poc-$(hostname)-$(date +%s)" \
        --work "_work_poc" \
        --labels "self-hosted,nix,poc-test" \
        --unattended \
        --ephemeral  # Auto-remove after one job
}

#==============================================================================
# ORGANIZATION RUNNER SETUP
#==============================================================================

# Setup runner at organization level (requires org admin)
setup_org_runner() {
    local ORG="my-organization"
    local TOKEN=$(gh api --method POST "/orgs/${ORG}/actions/runners/registration-token" -q .token)
    
    config.sh \
        --url "https://github.com/${ORG}" \
        --token "$TOKEN" \
        --name "org-runner-$(hostname)" \
        --work "_work" \
        --labels "self-hosted,org-runner" \
        --unattended \
        --runnergroup "Default"  # Organization runner group
}

#==============================================================================
# CUSTOM CONFIGURATIONS
#==============================================================================

# Setup with custom working directory
setup_custom_workdir() {
    local CUSTOM_WORK="/tmp/runner-work"
    mkdir -p "$CUSTOM_WORK"
    
    config.sh \
        --url "https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)" \
        --token "$(gh api --method POST /repos/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions/runners/registration-token -q .token)" \
        --name "custom-runner" \
        --work "$CUSTOM_WORK" \
        --labels "self-hosted,custom" \
        --unattended
}

# Setup with specific labels for workflow targeting
setup_with_labels() {
    # Labels used in workflow: runs-on: [self-hosted, gpu, ubuntu-20.04]
    config.sh \
        --url "https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)" \
        --token "$(gh api --method POST /repos/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions/runners/registration-token -q .token)" \
        --name "labeled-runner" \
        --work "_work" \
        --labels "self-hosted,gpu,ubuntu-20.04,high-memory" \
        --unattended
}

#==============================================================================
# CLEANUP PROCEDURES
#==============================================================================

# Remove runner registration
unregister_runner() {
    # Get removal token
    local REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
    local REMOVE_TOKEN=$(gh api --method POST "/repos/${REPO}/actions/runners/remove-token" -q .token)
    
    # Remove runner
    config.sh remove --token "$REMOVE_TOKEN"
}

# Full cleanup including files
full_cleanup() {
    # Stop any running instances
    pkill -f Runner.Listener || true
    
    # Unregister if registered
    [[ -f .runner ]] && unregister_runner
    
    # Remove all runner files
    rm -rf _work _diag .runner .credentials .credentials_rsaparams
}

#==============================================================================
# USAGE EXAMPLES
#==============================================================================

# Example 1: Quick POC test
example_poc_test() {
    validate_environment
    setup_ephemeral_poc
    ./run.sh --once  # Run one job and exit
}

# Example 2: Production setup
example_production() {
    validate_environment
    setup_with_gh_cli
    ./run.sh  # Run continuously
}

# Example 3: CI/CD integration
example_cicd() {
    validate_environment
    setup_ephemeral_poc
    # Runner will auto-cleanup after job completion
}

#==============================================================================
# NOTES
#==============================================================================
# - Tokens expire after 1 hour
# - Ephemeral runners auto-delete after one job
# - Labels must match workflow's runs-on specification
# - _work directory contains job execution files
# - _diag directory contains diagnostic logs
# - .runner file stores configuration
# - .credentials stores authentication