name: Cron Job Test

on:
  # 5分ごとに実行（テスト用）
  schedule:
    - cron: '*/5 * * * *'
  
  # 手動実行も可能
  workflow_dispatch:
  
  # Push時にも実行（デバッグ用）
  push:
    branches: [ main, dev ]

jobs:
  cron-test:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: System Information
      run: |
        echo "=== System Information ==="
        echo "Date: $(date)"
        echo "Hostname: $(hostname)"
        echo "User: $(whoami)"
        echo "PWD: $(pwd)"
        echo "OS: $(uname -a)"
        echo ""
        
    - name: Nix Environment Check
      run: |
        echo "=== Nix Environment ==="
        if command -v nix &> /dev/null; then
          echo "Nix version: $(nix --version)"
          echo "Nix store: /nix/store exists"
        else
          echo "Nix not found in PATH"
        fi
        echo ""
        
    - name: Runner Information
      run: |
        echo "=== Runner Information ==="
        echo "Runner name: $RUNNER_NAME"
        echo "Runner OS: $RUNNER_OS"
        echo "Runner architecture: $RUNNER_ARCH"
        echo "GitHub workspace: $GITHUB_WORKSPACE"
        echo ""
        
    - name: Test Nix Development Environment
      run: |
        echo "=== Testing Nix Flake ==="
        cd $GITHUB_WORKSPACE
        if [ -f "flake.nix" ]; then
          echo "Found flake.nix"
          nix flake check 2>&1 || echo "Flake check failed"
          nix develop --command echo "Nix develop environment works" 2>&1 || echo "Nix develop failed"
        else
          echo "No flake.nix found"
        fi
        echo ""
        
    - name: Test Runner Scripts
      run: |
        echo "=== Testing Runner Scripts ==="
        cd $GITHUB_WORKSPACE
        if nix develop --command which runner-setup 2>/dev/null; then
          echo "runner-setup command available"
        else
          echo "runner-setup command not found"
        fi
        
        if nix develop --command which runner-service 2>/dev/null; then
          echo "runner-service command available"
        else
          echo "runner-service command not found"
        fi
        echo ""
        
    - name: Cron Test Success
      run: |
        echo "=== Cron Test Completed Successfully ==="
        echo "Execution time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "This workflow ran on a self-hosted runner with Nix support"
        
    - name: Environment Variables Debug
      run: |
        echo "=== Environment Variables ==="
        echo "PATH: $PATH"
        echo "HOME: $HOME"
        echo "RUNNER_WORKSPACE: $RUNNER_WORKSPACE"
        echo ""
        
    - name: Log Cron Execution
      run: |
        echo "=== Logging Execution ==="
        LOG_FILE="$HOME/cron-test.log"
        echo "$(date): Cron test executed successfully" >> "$LOG_FILE"
        echo "Log entry added to: $LOG_FILE"
        if [ -f "$LOG_FILE" ]; then
          echo "Recent log entries:"
          tail -5 "$LOG_FILE"
        fi