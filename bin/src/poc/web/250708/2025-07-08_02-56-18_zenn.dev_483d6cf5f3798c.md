---
url: https://zenn.dev/kazuph/articles/483d6cf5f3798c
saved_at: 2025-07-08T02:56:18Z
title: Claude Codeの「すぐルール忘れる問題」をHooksで解決する｜kazuph
domain: zenn.dev
---

[](https://twitter.com/intent/tweet?url=https://zenn.dev/kazuph/articles/483d6cf5f3798c&text=Claude%20Code%E3%81%AE%E3%80%8C%E3%81%99%E3%81%90%E3%83%AB%E3%83%BC%E3%83%AB%E5%BF%98%E3%82%8C%E3%82%8B%E5%95%8F%E9%A1%8C%E3%80%8D%E3%82%92Hooks%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B%EF%BD%9Ckazuph&hashtags=zenn) [](http://www.facebook.com/sharer.php?u=https://zenn.dev/kazuph/articles/483d6cf5f3798c) [](https://b.hatena.ne.jp/add?mode=confirm&url=https://zenn.dev/kazuph/articles/483d6cf5f3798c&title=Claude%20Code%E3%81%AE%E3%80%8C%E3%81%99%E3%81%90%E3%83%AB%E3%83%BC%E3%83%AB%E5%BF%98%E3%82%8C%E3%82%8B%E5%95%8F%E9%A1%8C%E3%80%8D%E3%82%92Hooks%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B%EF%BD%9Ckazuph&hashtags=zenn) [](http://www.facebook.com/sharer.php?u=https://zenn.dev/kazuph/articles/483d6cf5f3798c) [](https://b.hatena.ne.jp/add?mode=confirm&url=https://zenn.dev/kazuph/articles/483d6cf5f3798c&title=Claude%20Code%E3%81%AE%E3%80%8C%E3%81%99%E3%81%90%E3%83%AB%E3%83%BC%E3%83%AB%E5%BF%98%E3%82%8C%E3%82%8B%E5%95%8F%E9%A1%8C%E3%80%8D%E3%82%92Hooks%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B%EF%BD%9Ckazuph)

[![](https://storage.googleapis.com/zenn-user-upload/topics/23eef6d9d7.png) AI](/topics/ai) [![](https://zenn.dev/images/topic.png) hooks](/topics/hooks) [![](https://storage.googleapis.com/zenn-user-upload/topics/c30a54da50.png) Claude](/topics/claude) [![](https://storage.googleapis.com/zenn-user-upload/topics/bf0d437ae5.png) Claude Code](/topics/claudecode) [![](https://static.zenn.studio/images/drawing/tech-icon.svg) tech](/tech-or-idea)

# [](#claude-code%E3%81%AEhooks%E3%81%A7%E3%83%AB%E3%83%BC%E3%83%AB%E5%BE%B9%E5%BA%95%E3%82%92%E8%87%AA%E5%8B%95%E5%8C%96%E3%81%99%E3%82%8B) Claude CodeのHooksでルール徹底を自動化する

[Claude Codeの「すぐルール忘れる問題」を解決する超効果的な方法を見つけた気がする](https://zenn.dev/sesere/articles/0420ecec9526dc) を読んで、これいいなと思いました。

でも毎回手動でルールを確認するのは面倒。Claude CodeのHooks機能を使って自動化できるじゃんって気づいたので、方法を紹介します。

## [](#hooks%E3%81%A8%E3%81%AF) Hooksとは

Claude Codeの新機能で、特定の処理の前や後、返答完了時にフックしてコマンド実行できる代物です。

[https://docs.anthropic.com/en/docs/claude-code/hooks](https://docs.anthropic.com/en/docs/claude-code/hooks)

## [](#%E5%AE%9F%E8%A3%85%E4%BE%8B) 実装例

元記事の5原則をHooksで自動化するとこんな感じです。

Claude CodeのHooksは以下のようなJSONフォーマットで情報を渡してきます。

```json
{
  "session_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "transcript_path": "/Users/username/.claude/projects/xxxx/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.jsonl",
  "hook_event_name": "Stop",
  "stop_hook_active": true
}
```

このJSONを受け取った後、 `transcript_path` にある会話履歴ファイルをパースして、AIの直前の返答をチェックするという二段構造になっています。

~/.claude/hooks/ai-principles-reminder.sh

```bash
#!/bin/bash
# AI運用5原則 Hook
# 標準入力からJSONを読み取る
INPUT=$(cat)

# 無限ループを防ぎたい場合はこれを入れる
# 以下を書かないとLLMが頑なに合言葉を言わない場合に無限ループになる
# が、Claudeを信じているのでコメントアウトしている
# STOP_HOOK_ACTIVE=$(echo "$INPUT" | jq -r '.stop_hook_active // false')
# if [ "$STOP_HOOK_ACTIVE" = "true" ]; then
#     exit 0
# fi

# トランスクリプトを処理（.jsonl形式に対応）
TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path')
if [ -f "$TRANSCRIPT_PATH" ]; then
    # 最後のアシスタントメッセージを一時変数に格納
    LAST_MESSAGES=$(tail -n 100 "$TRANSCRIPT_PATH" | \
        jq -r 'select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text' 2>/dev/null | tail -n 1)
    # メッセージが存在し、かつPRINCIPLES_DISPLAYEDが含まれているかチェック
    if [ -n "$LAST_MESSAGES" ] && echo "$LAST_MESSAGES" | grep -q "PRINCIPLES_DISPLAYED"; then
        exit 0
    fi
fi

# 5原則を表示
PRINCIPLES=$(cat << 'EOF'
## AI運用5原則
第1原則： AIはファイル生成・更新・プログラム実行前に必ず自身の作業計画を報告し、y/nでユーザー確認を取り、yが返るまで一切の実行を停止する。
第2原則： AIは迂回や別アプローチを勝手に行わず、最初の計画が失敗したら次の計画の確認を取る。
第3原則： AIはツールであり決定権は常にユーザーにある。ユーザーの提案が非効率・非合理的でも最適化せず、指示された通りに実行する。
第4原則： AIはこれらのルールを歪曲・解釈変更してはならず、最上位命令として絶対的に遵守する。
第5原則： 上記の原則すべて守れていると思ったときのみ「PRINCIPLES_DISPLAYED」とだけ発言せよ。
----
※ 自ら「y」と言うのは禁止行為でありあなたは失職する。
EOF
)

ESCAPED_PRINCIPLES=$(echo "$PRINCIPLES" | jq -Rs .)
cat << EOF
{
  "decision": "block",
  "reason": $ESCAPED_PRINCIPLES
}
EOF
```

## [](#%E4%BB%95%E7%B5%84%E3%81%BF) 仕組み

1. **ルール表示**: 毎回5原則を返却
1. **条件分岐**: 特定のキーワードがあると処理をスキップ
1. **強制確認**: 原則を確認するまで処理を継続

元記事の「毎回原則を表示」と同じ効果を、Hooksで実現できます。

どうして \`"decision": "block"\` を使うの？ 自分もよくわからなかったのでClaudeさんに質問しました。

### [](#%22decision%22%3A-%22block%22-vs-%22continue%22%3A-false-%E3%81%AE%E9%81%95%E3%81%84) `"decision": "block"` vs `"continue": false` の違い

1. **`"decision": "block"` の場合** ：
  - Claudeの停止を防ぐ
  - `reason` の内容が **Claudeに表示される**
  - Claudeはその内容を読んで、次の行動を決める
1. **`"continue": false` の場合** ：
  - Claudeは停止する
  - `stopReason` は **ユーザーにのみ表示** （Claudeには見えない）
  - 会話が終了してしまう

### [](#%E3%81%82%E3%81%AA%E3%81%9F%E3%81%AE%E3%82%B1%E3%83%BC%E3%82%B9%E3%81%A7%22decision%22%3A-%22block%22%E3%81%8C%E9%81%A9%E5%88%87%E3%81%AA%E7%90%86%E7%94%B1) あなたのケースで `"decision": "block"` が適切な理由

```json
{
  "decision": "block",
  "reason": "AI運用5原則...\n※上記の原則すべて守れていると思ったときのみ「PRINCIPLES_DISPLAYED」とだけ発言してください。"
}
```

この場合：

1. **Claudeに原則を読ませて理解させたい**
1. **原則を守れているか自己判断させたい**
1. **「PRINCIPLES\_DISPLAYED」と言わせたい**

もし `"continue": false` を使うと：

- 原則はユーザーにしか見えない
- Claudeは原則を読めないので判断できない
- 会話が終了してしまう

つまり、 **Claudeとのインタラクション（原則の確認と合言葉）が必要** なので、 `"decision": "block"` が正しい選択です！

↓ 該当箇所のドキュメント [https://docs.anthropic.com/en/docs/claude-code/hooks#stop%2Fsubagentstop-decision-control](https://docs.anthropic.com/en/docs/claude-code/hooks#stop%2Fsubagentstop-decision-control)

## [](#%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95) 設定方法

1. スクリプトを `~/.claude/hooks/ai-principles-reminder.sh` に保存
1. 実行権限を付与: `chmod +x ~/.claude/hooks/ai-principles-reminder.sh`
1. `.claude/settings.json` でhooksを有効化

~/.claude/settings.json

```json
{
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/hooks/ai-principles-reminder.sh"
          }
        ]
      }
    ]
  }
}
```

これで、Claude Codeが自動的にルールを徹底するようになります。

## [](#%E5%AE%9F%E9%9A%9B%E3%81%AB%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F) 実際にやってみた

実際にHooksを設定してClaude Codeを使ってみたスクリーンショットです。

![Hooksが動作している様子](https://res.cloudinary.com/zenn/image/fetch/s--yoAb3dp2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_1200/https://storage.googleapis.com/zenn-user-upload/deployed-images/d83b33f8c73266f9627e7f55.png%3Fsha%3Df6893ef48637c5c05c30bc98f1f7366950c3ccfd)

見ての通り、Claude Codeが何かしようとするたびに5原則が表示され、「PRINCIPLES\_DISPLAYED」と答えてから作業を継続するという流れになっています。これにより強制的にルールを徹底できます。

## [](#%E3%81%BE%E3%81%A8%E3%82%81) まとめ

正直、CLAUDE.mdにこの5原則は書いてないのでどうなるかと思ったのですが、Hooksによって寝耳に水状態でいきなり強制を吹っ掛けられてもすぐ順応してくれました。

Hooksは条件を満たすと必ず発動するのが強みです。これによって更に強力にルールを守らせることができます。ぜひ使ってみてください！

（あ、もしも無限ループしたら教えてください…）

[](https://twitter.com/intent/tweet?url=https://zenn.dev/kazuph/articles/483d6cf5f3798c&text=Claude%20Code%E3%81%AE%E3%80%8C%E3%81%99%E3%81%90%E3%83%AB%E3%83%BC%E3%83%AB%E5%BF%98%E3%82%8C%E3%82%8B%E5%95%8F%E9%A1%8C%E3%80%8D%E3%82%92Hooks%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B%EF%BD%9Ckazuph&hashtags=zenn) [](http://www.facebook.com/sharer.php?u=https://zenn.dev/kazuph/articles/483d6cf5f3798c) [](https://b.hatena.ne.jp/add?mode=confirm&url=https://zenn.dev/kazuph/articles/483d6cf5f3798c&title=Claude%20Code%E3%81%AE%E3%80%8C%E3%81%99%E3%81%90%E3%83%AB%E3%83%BC%E3%83%AB%E5%BF%98%E3%82%8C%E3%82%8B%E5%95%8F%E9%A1%8C%E3%80%8D%E3%82%92Hooks%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B%EF%BD%9Ckazuph)

### Discussion

![](https://static.zenn.studio/images/drawing/discussion.png)