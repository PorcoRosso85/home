#!/usr/bin/env bash
# Example: Correct way to use firejail with nix commands
# This demonstrates the working method discovered during testing

echo "====================================="
echo "Correct Firejail Usage with Nix"
echo "====================================="
echo

# WRONG WAY (doesn't work)
echo "❌ WRONG: firejail nix run ..."
echo "   Problem: Nix daemon bypasses the sandbox"
echo

# RIGHT WAY (works)
echo "✅ CORRECT: nix develop -c firejail ..."
echo "   Solution: Run firejail inside the nix environment"
echo

# Working example
echo "=== Working Example ==="
echo

# Create test directory
mkdir -p restricted-test
echo "secret data" > restricted-test/secret.txt

echo "1. Testing WITHOUT firejail:"
cat restricted-test/secret.txt && echo "   → File readable"

echo
echo "2. Testing WITH firejail (correct method):"
echo "   Command: nix develop -c firejail --noprofile --blacklist=\$(pwd)/restricted-test -- cat restricted-test/secret.txt"

# Run from org directory where flake.nix exists
cd /home/nixos/bin/src/develop/org 2>/dev/null || {
    echo "   Note: Run from a directory with flake.nix for nix develop"
    exit 1
}

# Execute the correct way
nix develop -c firejail \
    --noprofile \
    --quiet \
    --blacklist="$(pwd)/../../poc/firejail-for-childs/restricted-test" \
    -- bash -c "cd ../../poc/firejail-for-childs && cat restricted-test/secret.txt 2>&1" \
    | grep -q "Permission denied" && echo "   → Access BLOCKED ✓" || echo "   → Access allowed (unexpected)"

echo
echo "=== Key Points ==="
echo "• Order matters: 'nix develop -c' comes FIRST"
echo "• --noprofile flag avoids default profile conflicts"
echo "• --read-only=/nix/store may be needed for complex commands"
echo "• Use -- to separate firejail options from the command"

# Cleanup
cd - >/dev/null 2>&1
rm -rf restricted-test 2>/dev/null