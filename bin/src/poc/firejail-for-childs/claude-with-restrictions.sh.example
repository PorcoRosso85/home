#!/usr/bin/env bash
# Example: Auto-restore permissions wrapper for Claude Code
# This script demonstrates how to temporarily restrict directory access
# and automatically restore permissions on exit (including Ctrl+C)

# Configuration
RESTRICTED_DIRS=(
    "test-dirs/child1"
    "test-dirs/child2"
    "test-dirs/child3"
)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Store original permissions
declare -A ORIGINAL_PERMS

# Function to save original permissions
save_permissions() {
    echo -e "${YELLOW}Saving original permissions...${NC}"
    for dir in "${RESTRICTED_DIRS[@]}"; do
        if [[ -d "$dir" ]]; then
            ORIGINAL_PERMS["$dir"]=$(stat -c %a "$dir")
            echo "  $dir: ${ORIGINAL_PERMS[$dir]}"
        fi
    done
}

# Function to restrict permissions
restrict_permissions() {
    echo -e "${RED}Restricting permissions...${NC}"
    for dir in "${RESTRICTED_DIRS[@]}"; do
        if [[ -d "$dir" ]]; then
            chmod 000 "$dir"
            echo "  $dir: restricted (000)"
        fi
    done
}

# Function to restore permissions
restore_permissions() {
    echo -e "${GREEN}Restoring original permissions...${NC}"
    for dir in "${RESTRICTED_DIRS[@]}"; do
        if [[ -d "$dir" ]] && [[ -n "${ORIGINAL_PERMS[$dir]}" ]]; then
            chmod "${ORIGINAL_PERMS[$dir]}" "$dir"
            echo "  $dir: restored (${ORIGINAL_PERMS[$dir]})"
        fi
    done
}

# Trap to ensure permissions are restored on exit
trap restore_permissions EXIT INT TERM

# Main execution
echo "====================================="
echo "Claude with Directory Restrictions"
echo "====================================="
echo

# Save and restrict
save_permissions
restrict_permissions

echo
echo -e "${YELLOW}Launching restricted environment...${NC}"
echo "Press Ctrl+C to exit and restore permissions"
echo

# Launch command (defaults to bash if no arguments)
if [[ $# -eq 0 ]]; then
    bash
else
    "$@"
fi

# Permissions will be automatically restored by trap