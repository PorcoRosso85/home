OAuth2認証フロー（@n8n/client-oauth2使用）

┌─────────┐     ┌──────────────┐     ┌──────────────┐     ┌─────────────┐
│  User   │     │ Your App     │     │ n8n OAuth2   │     │   Google    │
│         │     │              │     │   Client     │     │   OAuth2    │
└────┬────┘     └──────┬───────┘     └──────┬───────┘     └──────┬──────┘
     │                  │                     │                     │
     │ 1. Login Request │                     │                     │
     │─────────────────►│                     │                     │
     │                  │                     │                     │
     │                  │ 2. Create Client    │                     │
     │                  │────────────────────►│                     │
     │                  │                     │                     │
     │                  │ 3. Generate Auth URL│                     │
     │                  │◄────────────────────│                     │
     │                  │                     │                     │
     │ 4. Redirect to   │                     │                     │
     │◄─────────────────│                     │                     │
     │    Auth URL      │                     │                     │
     │                  │                     │                     │
     │ 5. Authenticate  │                     │                     │
     │──────────────────┼─────────────────────┼────────────────────►│
     │                  │                     │                     │
     │                  │                     │    6. Auth Code    │
     │◄─────────────────┼─────────────────────┼─────────────────────│
     │                  │                     │                     │
     │ 7. Callback with │                     │                     │
     │    Auth Code     │                     │                     │
     │─────────────────►│                     │                     │
     │                  │                     │                     │
     │                  │ 8. Exchange Code    │                     │
     │                  │────────────────────►│                     │
     │                  │                     │                     │
     │                  │                     │ 9. Request Tokens  │
     │                  │                     │───────────────────►│
     │                  │                     │                     │
     │                  │                     │ 10. Access Token   │
     │                  │                     │◄───────────────────│
     │                  │                     │   Refresh Token    │
     │                  │                     │                     │
     │                  │ 11. Return Tokens   │                     │
     │                  │◄────────────────────│                     │
     │                  │                     │                     │
     │ 12. Auth Success │                     │                     │
     │◄─────────────────│                     │                     │
     │                  │                     │                     │
     │                  │═══════ Authenticated Session ═══════════│
     │                  │                     │                     │
     │ 13. API Request  │                     │                     │
     │─────────────────►│                     │                     │
     │                  │                     │                     │
     │                  │ 14. Make Request    │                     │
     │                  │────────────────────►│                     │
     │                  │    with Token       │                     │
     │                  │                     │ 15. API Call       │
     │                  │                     │───────────────────►│
     │                  │                     │                     │
     │                  │                     │ 16. API Response   │
     │                  │                     │◄───────────────────│
     │                  │                     │                     │
     │                  │ 17. Return Data     │                     │
     │                  │◄────────────────────│                     │
     │                  │                     │                     │
     │ 18. API Response │                     │                     │
     │◄─────────────────│                     │                     │
     │                  │                     │                     │
     │                  │═══════ Token Expiry Handling ═══════════│
     │                  │                     │                     │
     │                  │ 19. Token Expired   │                     │
     │                  │────────────────────►│                     │
     │                  │                     │                     │
     │                  │                     │ 20. Refresh Token  │
     │                  │                     │───────────────────►│
     │                  │                     │                     │
     │                  │                     │ 21. New Access     │
     │                  │                     │◄───────────────────│
     │                  │                     │     Token          │
     │                  │                     │                     │
     │                  │ 22. Updated Token   │                     │
     │                  │◄────────────────────│                     │
     │                  │                     │                     │

自動テストのシーケンス（Playwright使用）

┌─────────────┐     ┌──────────────┐     ┌──────────────┐     ┌─────────────┐
│ Test Runner │     │  Playwright  │     │ n8n OAuth2   │     │Mock OAuth2  │
│   (Jest)    │     │   Browser    │     │   Client     │     │   Server    │
└──────┬──────┘     └──────┬───────┘     └──────┬───────┘     └──────┬──────┘
       │                    │                     │                     │
       │ 1. Start Test      │                     │                     │
       │───────────────────►│                     │                     │
       │                    │                     │                     │
       │ 2. Navigate to     │                     │                     │
       │    Auth URL        │                     │                     │
       │───────────────────►│                     │                     │
       │                    │                     │                     │
       │                    │ 3. Fill Credentials │                     │
       │                    │─────────────────────┼────────────────────►│
       │                    │  (Automated)        │                     │
       │                    │                     │                     │
       │                    │ 4. Click Authorize  │                     │
       │                    │─────────────────────┼────────────────────►│
       │                    │  (Automated)        │                     │
       │                    │                     │                     │
       │                    │                     │ 5. Return Auth Code│
       │                    │◄────────────────────┼─────────────────────│
       │                    │                     │                     │
       │ 6. Capture Code    │                     │                     │
       │◄───────────────────│                     │                     │
       │                    │                     │                     │
       │ 7. Exchange Code   │                     │                     │
       │────────────────────┼────────────────────►│                     │
       │                    │                     │                     │
       │                    │                     │ 8. Request Tokens  │
       │                    │                     │───────────────────►│
       │                    │                     │                     │
       │                    │                     │ 9. Mock Tokens     │
       │                    │                     │◄───────────────────│
       │                    │                     │                     │
       │ 10. Verify Tokens  │                     │                     │
       │◄───────────────────┼─────────────────────│                     │
       │                    │                     │                     │
       │ 11. Assert Success │                     │                     │
       │                    │                     │                     │