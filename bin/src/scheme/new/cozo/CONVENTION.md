# CozoDB Time Travel API プロジェクト規約

このドキュメントは、CozoDB Time Travel API プロジェクトの開発規約とアーキテクチャの説明を提供します。

## アーキテクチャ

このプロジェクトは、クリーンアーキテクチャの原則に基づいた3層アーキテクチャを採用しています。各層の責務は明確に分離され、以下のような構造になっています。

### 1. インフラストラクチャ層 (Infrastructure Layer)

データベースやファイルシステムなどの外部リソースとの直接的なやり取りを担当します。

- **場所**: `/infrastructure`ディレクトリ
- **責務**:
  - CozoDBとの通信
  - クエリの実行
  - 低レベルなデータアクセス
  - 外部リソースとのインターフェース

### 2. ドメイン層 (Domain Layer)

ビジネスロジックとドメインモデルを含む、アプリケーションの中核部分です。

- **場所**: `/domain`ディレクトリ
- **責務**:
  - ビジネスロジックの実装
  - ドメインモデルの定義
  - ドメインサービスの提供
  - ビジネスルールの適用

### 3. アプリケーション層 (Application Layer)

ドメイン層とインフラストラクチャ層を連携させ、ユースケースを実現します。

- **場所**: `/application`ディレクトリ
- **責務**:
  - ユースケースの実装
  - ドメインサービスの調整
  - 入出力の変換
  - 高レベルAPIの提供

### 4. インターフェース層 (Interface Layer)

ユーザーやシステムとのインターフェースを提供します。

- **場所**: `/interface`ディレクトリ
- **責務**:
  - CLI/GUI実装
  - APIエンドポイント
  - 入力バリデーション
  - レスポンスフォーマット

## ディレクトリ構造

```
/home/nixos/scheme/new/cozo/
├── infrastructure/         # インフラストラクチャ層
│   └── timeTravel/        # Time Travel機能のインフラ実装
│       └── repository.ts  # データアクセスリポジトリ
├── domain/                # ドメイン層
│   └── timeTravel/        # Time Travel機能のドメイン実装
│       └── service.ts     # ドメインサービス
├── application/           # アプリケーション層
│   └── timeTravel/        # Time Travel機能のアプリケーション実装
│       └── api.ts         # 外部向けAPI
└── interface/             # インターフェース層
    └── cli.ts             # コマンドラインインターフェース
```

## 命名規則

- **ファイル名**: キャメルケース（例: `repository.ts`, `service.ts`）
- **ディレクトリ名**: キャメルケース（例: `timeTravel`）
- **変数名**: キャメルケース（例: `filePath`, `commitMessage`）
- **関数名**: キャメルケース（例: `getFileVersions`, `compareVersions`）
- **クラス名**: パスカルケース（例: `TimeTravelRepository`）

## インポートのルール

- 相対パスを使用してインポートを行う（例: `import * as repo from "../../infrastructure/timeTravel/repository";`）
- 循環依存を避ける
- 依存方向は常に外側から内側へ（インターフェース層 → アプリケーション層 → ドメイン層 → インフラストラクチャ層）

## エラー処理

- エラーは適切に捕捉し、意味のあるエラーメッセージを提供する
- 低レベルの例外は上位層で適切に変換する
- ユーザー向けのエラーメッセージとデバッグ用の詳細情報を区別する

## タイムスタンプの取り扱い

- すべてのタイムスタンプはISO 8601形式を使用する（例: `2023-01-01T00:00:00Z`）
- タイムスタンプの検証は必ず行う
- タイムスタンプが指定されない場合は現在時刻を使用する

## テスト

- 各層ごとにテストを作成する
- インターフェース層では、CLIを通じた統合テストを行う
- テストはユースケースの検証に焦点を当てる

## ドキュメント

- 関数やクラスには適切なJSDocコメントを付ける
- 複雑なロジックには説明コメントを追加する
- README.mdやCONVENTION.mdなどのドキュメントを最新に保つ

このコンベンションはプロジェクトの開発を進める際のガイドラインとして使用してください。新しいコードを追加する際は、これらの規約に従い、アーキテクチャの整合性を維持してください。
