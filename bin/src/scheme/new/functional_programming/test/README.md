# テストディレクトリ

このディレクトリには、Function.meta.jsonスキーマを検証するためのエンドツーエンド(E2E)テストが格納されています。

## 実行方法

このディレクトリのテストスクリプトはすべて、以下のようにプロジェクトルートから直接実行できます：

```bash
# functionGraph.tsの実行例
./test/functionGraph.ts

# 依存関係解析E2Eテストの実行例
./test/dependencyAnalysisE2E.ts
```

## denoが不要な理由

各テストファイルは以下のシバン行で始まります：

```bash
#!/usr/bin/env -S nix shell nixpkgs#deno --command deno run --allow-read --allow-write --allow-run --check
```

これにより、次のことが行われます：

1. `nix shell nixpkgs#deno`を使用して一時的にDeno環境を立ち上げる
2. その環境内で`deno run`コマンドを実行する
3. スクリプト実行後に環境はクリーンアップされる

つまり、ユーザーのマシンにdenoが事前にインストールされている必要はなく、nixパッケージマネージャーを通じて一時的にdenoがダウンロードされ使用されます。

## テスト規約

### 命名規則

- ファイル名はキャメルケースで記述（例: `functionGraph.ts`, `dependencyAnalysisE2E.ts`）
- 関数名もキャメルケース形式を使用（例: `createTestSchema`, `runAnalysis`）

### ファイル構造

- すべてのE2Eテストはこのディレクトリ（`test/`）に配置
- 各テストファイルは独立して実行可能なスクリプトとして実装
- 必要に応じてテスト用の一時ファイルを生成し、テスト終了時に削除

### 実装ガイドライン

- テストファイルは必ず上記のシバン行で始める
- 外部依存ファイル（例：Function.meta.json）を参照してもよい
- テスト実行中に生成された一時ファイルはテスト終了時に必ず削除
- 標準出力に明確なテスト結果を表示（成功/失敗の判定を含む）
- 必要に応じてレポートファイルを生成する場合は、一時ディレクトリに出力

### ファイル操作に関する厳格なルール

1. **ファイル直接変更の禁止**
   - テスト内でJSONファイルや設定ファイルを直接変更してはならない
   - 直接変更はシステムの実際の動作をバイパスし、本質的なテストとは言えない
   - 必ずCLIコマンドまたは提供されたAPIを使用して変更を行うこと

2. **問題発見時の対応**
   - システム動作に問題を発見した場合はFIXMEコメントとして記録
   - ソースコードの問題箇所に直接コメントを追加し、修正の方向性を示す
   - テスト実行レポートにも問題を明記する

3. **ユーザーフィードバック**
   - E2Eテスト中に発見した問題点は必ずユーザーに明示的にフィードバック
   - 対応策の提案を含め、ユーザーの判断を仰ぐ
   - 対応が決定するまでテストは暫定的な成功とみなす

## 既存のテストファイル

1. **functionGraph.ts**
   - Function.meta.jsonの依存関係グラフを生成
   - Mermaid形式でグラフを視覚化

2. **dependencyAnalysisE2E.ts**
   - 複雑なスキーマと循環参照を含むスキーマを自動生成
   - 異なる出力形式（tree, JSON, Mermaid）でのテスト
   - GraphBuilderの機能（重複ノード検出、循環参照検出）を検証
