# CLI機能のテスト自動化要件

## 現状の課題

現在のCLI機能テスト（`cli.ts`内）には以下の課題があります：

- テストが実際のファイル（`add.json`, `calculateTotal.json`, `map.json`）に依存している
- テスト環境の準備と後片付けが手動
- テスト実行と検証が分離されていない
- 自動化されたテスト機能が不足している

## 要件

1. **既存のcli.tsファイル内**にテスト拡張を追加
2. `import.meta.main`の条件内でテスト自動化を実装（規約に沿った実装）
3. テスト用のJSONファイルを自動生成・削除できるようにする
4. テスト実行と検証が一連の流れで自動化されるようにする
5. 関数型プログラミングスタイルを維持する

## 仕様

### 1. テスト用JSONファイル生成機能

- テスト開始時に一時ディレクトリ内にテスト用JSONファイルを生成
- テスト終了時にファイルをクリーンアップ
- テスト用JSON構造体を内部的に定義（ハードコードせず、プログラムで生成）

### 2. CLI実行のテスト機能

- CLI自身の実行結果をキャプチャして検証できる機能
- テスト前後の状態を検証できる機能
- さまざまなCLIオプションの組み合わせをテストできる構造

### 3. テスト自動化関数

- テストケースを宣言的に定義できる構造
- テスト成功/失敗を明確に判定できる仕組み
- テスト結果のサマリーを出力する機能

## タスク

1. **cli.tsファイル内にテスト機能を追加**
   - `import.meta.main`ブロック内でテスト機能を実装
   - 既存のテスト実装と同様のパターンを採用

2. **テスト環境設定機能の実装**
   - 一時ディレクトリ作成と管理の関数を実装
   - テスト用JSONファイル生成関数を実装
   - テスト後のクリーンアップ関数を実装

3. **CLI実行結果検証機能の実装**
   - CLI実行結果をキャプチャする関数を実装
   - 期待される出力と実際の出力を比較する関数を実装
   - テスト成功/失敗を判定する関数を実装

4. **テストケース定義と実行機能の実装**
   - テストケースを定義するデータ構造を設計
   - テストケースを順次実行する関数を実装
   - テスト結果のサマリーを生成する関数を実装

5. **既存機能のテストケース実装**
   - 基本機能のテストケース（動的に生成したテストファイルに対するテスト）
   - 各オプション（--unified, --verbose, --format）のテストケース
   - エラーケースのテストケース

## 実装方針

- JSONファイル生成には、テンプレートオブジェクトを定義し、それを変形・拡張して様々なテストケースを生成
- CLI実行結果のキャプチャには、Denoの子プロセス実行機能を使用
- テストの自動化には、テストケースを宣言的に定義し、それらを順次実行するアプローチを採用
- 既存のDeno.testフレームワークとの互換性を維持
- すべてのテスト機能は関数型スタイルで実装し、クラスは使用しない

## テスト実行方法

```bash
# 通常の実行でテストも自動的に実行される（import.meta.mainの条件による）
./cli.ts
```

## 実装例（部分）

```typescript
// ファイルが直接実行された場合にテストを実行
if (import.meta.main) {
  // 通常のCLI機能を実行
  await main();
  
  // テスト機能も実行
  console.log("\n=== cli.ts 単体テスト実行中 ===");
  
  // テスト用一時ディレクトリ作成
  const testDir = await createTempDirectory();
  
  try {
    // テスト用JSONファイルを生成
    await generateTestFiles(testDir);
    
    // テストケースを実行
    await runTests(testDir);
  } finally {
    // テスト後のクリーンアップ
    await cleanupTempDirectory(testDir);
  }
}
```

## 成功基準

- すべてのテストケースが自動的に実行され、結果が検証できること
- 一時ファイルの生成と削除が自動的に行われること
- CLI機能のすべてのオプションと組み合わせがテストされること
- テスト結果のサマリーが明確に示されること
- 既存のCLI機能に影響がないこと
