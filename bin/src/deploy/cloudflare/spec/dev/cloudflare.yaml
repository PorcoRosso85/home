# Cloudflare Development Environment SOT Configuration - R2 Control Plane Example
# This demonstrates comprehensive R2 bucket management, bindings, and Workers integration
# In production, this file should be encrypted with SOPS

version: "1.0"

# R2 Control Plane Configuration - Bucket Definitions
r2:
  buckets:
    # Primary application buckets
    - name: "dev-user-uploads"
      binding: "USER_UPLOADS"
      location: "auto"  # Cloudflare auto-location
      lifecycle:
        enabled: true
        rules:
          - name: "cleanup-temp-uploads"
            action: "Delete"
            filter:
              prefix: "temp/"
            expiration:
              days: 7

    - name: "dev-static-assets"
      binding: "STATIC_ASSETS"
      location: "auto"
      cors:
        - allowed_origins: ["*"]
          allowed_methods: ["GET", "HEAD"]
          allowed_headers: ["Content-Type"]
          max_age: 3600

    - name: "dev-cache-storage"
      binding: "CACHE_STORAGE"
      location: "auto"
      lifecycle:
        enabled: true
        rules:
          - name: "cache-cleanup"
            action: "Delete"
            expiration:
              days: 30

    # Control Plane specific buckets
    - name: "dev-backup-storage"
      binding: "BACKUP_STORAGE"
      location: "auto"
      lifecycle:
        enabled: true
        rules:
          - name: "backup-retention"
            action: "Delete"
            expiration:
              days: 90

    - name: "dev-logs-archive"
      binding: "LOGS_ARCHIVE"
      location: "auto"
      lifecycle:
        enabled: true
        rules:
          - name: "log-rotation"
            action: "Delete"
            filter:
              prefix: "daily/"
            expiration:
              days: 14
          - name: "monthly-logs"
            action: "Delete"
            filter:
              prefix: "monthly/"
            expiration:
              days: 365

# Workers Configuration with R2 Bindings
workers:
  # Main API Worker - Multiple R2 bucket access
  - name: "dev-api-worker"
    script: "src/worker.ts"
    environment: "development"
    compatibility_date: "2024-09-01"
    compatibility_flags: ["nodejs_compat"]
    bindings:
      r2:
        - bucket: "dev-user-uploads"
          binding: "USER_UPLOADS"
        - bucket: "dev-static-assets"
          binding: "STATIC_ASSETS"
        - bucket: "dev-cache-storage"
          binding: "CACHE_STORAGE"
        - bucket: "dev-backup-storage"
          binding: "BACKUP_STORAGE"
      kv:
        - namespace: "dev-session-store"
          binding: "SESSIONS"
      environment_variables:
        - name: "ENVIRONMENT"
          value: "development"
        - name: "LOG_LEVEL"
          value: "debug"

  # Authentication Worker - User uploads access
  - name: "dev-auth-worker"
    script: "src/auth-worker.ts"
    environment: "development"
    compatibility_date: "2024-09-01"
    bindings:
      r2:
        - bucket: "dev-user-uploads"
          binding: "UPLOADS"
        - bucket: "dev-logs-archive"
          binding: "AUDIT_LOGS"
      kv:
        - namespace: "dev-auth-cache"
          binding: "AUTH_CACHE"
      environment_variables:
        - name: "AUTH_MODE"
          value: "development"

  # Control Plane Management Worker - Administrative operations
  - name: "dev-control-plane-worker"
    script: "src/control-plane-worker.ts"
    environment: "development"
    compatibility_date: "2024-09-01"
    bindings:
      r2:
        - bucket: "dev-backup-storage"
          binding: "BACKUPS"
        - bucket: "dev-logs-archive"
          binding: "LOGS"
        - bucket: "dev-cache-storage"
          binding: "CACHE"
      kv:
        - namespace: "dev-control-metadata"
          binding: "METADATA"
      environment_variables:
        - name: "CONTROL_PLANE_MODE"
          value: "development"
        - name: "BACKUP_RETENTION_DAYS"
          value: "90"

# KV Namespaces (Supporting infrastructure for R2 Control Plane)
kv:
  namespaces:
    - name: "dev-session-store"
      binding: "SESSIONS"
    - name: "dev-auth-cache"
      binding: "AUTH_CACHE"
    - name: "dev-control-metadata"
      binding: "METADATA"

# Control Plane specific configuration
control_plane:
  enabled: true
  monitoring:
    enabled: true
    metrics_bucket: "dev-logs-archive"
    metrics_prefix: "metrics/"
  backup:
    enabled: true
    source_buckets: ["dev-user-uploads", "dev-static-assets"]
    destination_bucket: "dev-backup-storage"
    schedule: "daily"
  lifecycle_management:
    enabled: true
    policy_enforcement: true