# RedwoodSDK R2 Connection Management System
# ==========================================
# Comprehensive toolset for R2 development, configuration, and deployment

# Default environment for commands
DEFAULT_ENV := "dev"

# Help - Show all available commands
help
    @echo "ğŸš€ RedwoodSDK R2 Connection Management System"
    @echo "============================================="
    @echo ""
    @echo "ğŸ“‹ Core Commands:"
    @echo "  just help                     - Show this help message"
    @echo "  just setup                    - Complete R2 setup (secrets + config)"
    @echo "  just status                   - Show R2 configuration status"
    @echo "  just clean                    - Clean generated files and backups"
    @echo ""
    @echo "ğŸ” Secret Management:"
    @echo "  just secrets:init             - Initialize encrypted secrets setup"
    @echo "  just secrets:edit [FILE]      - Edit R2 secrets (default: r2.yaml)"
    @echo "  just secrets:check            - Validate secret security"
    @echo ""
    @echo "ğŸ”§ R2 Configuration:"
    @echo "  just r2:gen-manifest [ENV]    - Generate R2 connection manifest"
    @echo "  just r2:gen-config [ENV]      - Generate wrangler.jsonc configuration"
    @echo "  just r2:gen-all [ENV]         - Generate all configurations"
    @echo "  just r2:validate [ENV]        - Validate R2 configurations"
    @echo "  just r2:verify-control-plane [ENV] - Verify R2 Control Plane operations and consistency"
    @echo ""
    @echo "ğŸŒ Environment Management:"
    @echo "  just r2:envs                  - Discover available environments"
    @echo "  just r2:status [ENV]          - Show environment-specific status"
    @echo "  just r2:list-configs          - List all generated configurations"
    @echo ""
    @echo "ğŸ“‹ Resource Plane Operations:"
    @echo "  just res:inventory [ENV]      - Show Cloudflare resource inventory"
    @echo "  just res:fetch-state [ENV]    - Fetch current remote state from Cloudflare"
    @echo "  just res:diff [ENV]           - Compare SOT with remote state (drift detection)"
    @echo ""
    @echo "ğŸ—ï¸ Infrastructure as Code (Pulumi):"
    @echo "  just cf:plan [ENV]            - Preview infrastructure changes (CI/CD safe)"
    @echo "  just cf:apply [ENV]           - Apply infrastructure changes (manual only, diff=0 required)"
    @echo "  just cf:destroy [ENV]         - Destroy infrastructure resources (manual only, diff=0 required)"
    @echo ""
    @echo "ğŸ§ª Testing & Validation:"
    @echo "  just r2:test [ENV]            - Test R2 configuration validation"
    @echo "  just r2:validate-all          - Validate all environments"
    @echo "  just r2:check-syntax          - Check TypeScript and JS syntax"
    @echo ""
    @echo "ğŸ”„ Development Workflows:"
    @echo "  just r2:dev [ACTION]          - Development workflow (gen/validate/test/full)"
    @echo "  just r2:quick [ENV]           - Quick setup generate + validate"
    @echo "  just r2:deploy-prep [ENV]     - Prepare for deployment validation"
    @echo ""
    @echo "ğŸ› ï¸ Advanced Tools:"
    @echo "  just r2:backup-config         - Backup current wrangler.jsonc"
    @echo "  just r2:restore-config [FILE] - Restore wrangler.jsonc from backup"
    @echo "  just r2:diff-configs ENV1 ENV2 - Compare configurations between environments"
    @echo ""
    @echo "ğŸ’¡ Usage Examples:"
    @echo "  just setup                    # Complete initial setup"
    @echo "  just r2:quick dev             # Quick dev environment setup"
    @echo "  just r2:dev full              # Full development workflow"
    @echo "  just r2:deploy-prep prod      # Prepare production deployment"
    @echo ""
    @echo "ğŸ“– Environment: Default={{DEFAULT_ENV}} (can be overridden with ENV=value)"

# === CORE COMMANDS ===

# Complete R2 setup (secrets + config)
setup
    @echo "ğŸš€ Complete R2 Setup"
    @echo "==================="
    @echo "This will initialize secrets and generate default configuration"
    @echo ""
    just secrets:init
    @echo ""
    just r2:gen-config {{DEFAULT_ENV}}
    @echo ""
    @echo "âœ… Setup complete! Run 'just status' to verify."

# Show R2 configuration status
status
    @echo "ğŸ“Š R2 Configuration Status"
    @echo "=========================="
    @echo "ğŸ”‘ Age key: Will be checked"
    @printf "ğŸ”§ SOPS config: "
    @if [ -f .sops.yaml ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi
    @printf "ğŸ” R2 secrets: "
    @if [ -f secrets/r2.yaml ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi
    @printf "âš™ï¸  wrangler.jsonc: "
    @if [ -f wrangler.jsonc ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi
    @printf "ğŸ“ Generated directory: "
    @if [ -d generated ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi
    @echo ""
    @if [ -f wrangler.jsonc ] && [ -f secrets/r2.yaml ]; then \
        echo "ğŸ‰ Ready for R2 development!"; \
        echo "   Run 'just r2:test' to validate configuration"; \
    else \
        echo "âš™ï¸ Run 'just setup' to complete configuration."; \
    fi

# Clean generated files and backups
clean
    @echo "ğŸ§¹ Cleaning generated files and backups..."
    @echo "Files to be removed:"
    @if [ -d generated ]; then echo "  - generated/ directory"; fi
    @if [ -f wrangler.jsonc ]; then echo "  - wrangler.jsonc"; fi
    @find . -name "wrangler.jsonc.backup.*" -type f 2>/dev/null | sed 's/^/  - /' || true
    @echo ""
    @echo "Continue? (y/N) " && read answer && [ "$$answer" = "y" ]
    @rm -rf generated/
    @rm -f wrangler.jsonc
    @find . -name "wrangler.jsonc.backup.*" -type f -delete 2>/dev/null || true
    @echo "âœ… Cleanup complete"

# === SECRET MANAGEMENT ===

# Initialize encrypted secrets setup
secrets:init
    @echo "ğŸ” Initializing R2 secrets..."
    nix run .#secrets-init

# Edit R2 connection secrets
secrets:edit
    @echo "âœï¸ Editing R2 secrets: secrets/r2.yaml"
    nix run .#secrets-edit -- secrets/r2.yaml

# Verify secrets security (no plaintext secrets)
secrets:check
    @echo "ğŸ” Checking for plaintext secrets..."
    nix flake check

# === R2 CONFIGURATION ===

# Generate R2 connection manifest
r2:gen-manifest ENV
    @echo "ğŸ”§ Generating R2 connection manifest for {{ENV}}..."
    nix run .#gen-r2-manifest -- --env {{ENV}}

# Generate wrangler.jsonc configuration
r2:gen-config ENV
    @echo "âš™ï¸ Generating wrangler.jsonc for {{ENV}}..."
    nix run .#gen-wrangler-config-enhanced -- {{ENV}}

# Generate all R2 configurations
r2:gen-all ENV
    @echo "ğŸ”§ Generating all R2 configurations for {{ENV}}..."
    just r2:gen-config {{ENV}}
    just r2:gen-manifest {{ENV}}

# Validate R2 configurations
r2:validate ENV
    @echo "ğŸ§ª Validating R2 configuration for {{ENV}}..."
    nix run .#validate-r2-config -- --env {{ENV}}

# Verify R2 Control Plane operations and consistency
r2:verify-control-plane ENV
    @echo "ğŸ›ï¸  Verifying R2 Control Plane for {{ENV}}..."
    @echo "======================================="
    @echo "This command performs comprehensive R2 Control Plane verification:"
    @echo "â€¢ SOT configuration validation"
    @echo "â€¢ Pulumi plan verification"
    @echo "â€¢ wrangler.jsonc generation consistency"
    @echo "â€¢ Bucket and binding integrity checks"
    @echo ""
    ./scripts/verify-r2-control-plane.js {{ENV}}

# === ENVIRONMENT MANAGEMENT ===

# Discover available environments
r2:envs
    @echo "ğŸ” Discovering R2 environments..."
    nix run .#discover-r2-envs

# Show environment-specific status
r2:status ENV
    @echo "ğŸ“Š R2 Status for {{ENV}} environment"
    @echo "===================================="
    @printf "âš™ï¸  wrangler.jsonc: "
    @if [ -f wrangler.jsonc ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi
    @printf "ğŸ“‹ Connection manifest: "
    @if [ -f "generated/r2-connection-manifest-{{ENV}}.json" ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi
    @printf "ğŸ” R2 secrets: "
    @if [ -f secrets/r2.yaml ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi
    @echo ""
    @if [ -f wrangler.jsonc ]; then \
        echo "ğŸ·ï¸  Current configuration:"; \
        echo "   Account ID: $$(jq -r '.account_id // "not set"' wrangler.jsonc)"; \
        echo "   R2 Buckets: $$(jq -r '.r2_buckets[]?.binding // empty' wrangler.jsonc | tr '\n' ' ' | sed 's/ $$//' | sed 's/ /, /g' || echo "none")"; \
    fi

# List all generated configurations
r2:list-configs
    @echo "ğŸ“‹ Generated R2 Configurations"
    @echo "=============================="
    @if [ -d generated ]; then \
        echo "Connection manifests:"; \
        find generated -name "r2-connection-manifest-*.json" -exec basename {} \; | sed 's/r2-connection-manifest-//; s/.json$$//' | sed 's/^/  - /' || echo "  None found"; \
    else \
        echo "  No generated directory found"; \
    fi
    @echo ""
    @echo "Wrangler configurations:"
    @if [ -f wrangler.jsonc ]; then echo "  - wrangler.jsonc (current)"; else echo "  - None found"; fi
    @find . -name "wrangler.jsonc.backup.*" -type f -exec basename {} \; | sed 's/^/  - /' 2>/dev/null || true

# === RESOURCE PLANE OPERATIONS ===

# Show current Cloudflare resource inventory
res:inventory ENV
    @echo "ğŸ“‹ Cloudflare Resource Inventory ({{ENV}})"
    @echo "========================================"
    @echo ""
    @echo "ğŸ” Account Information:"
    @wrangler whoami 2>/dev/null || echo "âŒ Not authenticated - run 'wrangler login'"
    @echo ""
    @echo "ğŸª£ R2 Buckets:"
    @wrangler r2 bucket list 2>/dev/null | head -20 || echo "âŒ Failed to list R2 buckets - check authentication"
    @echo ""
    @echo "âš™ï¸  Configuration Status:"
    @printf "  - wrangler.jsonc: "
    @if [ -f wrangler.jsonc ]; then echo "âœ… Present"; else echo "âŒ Missing"; fi
    @printf "  - Environment: {{ENV}}"
    @if [ -f "generated/r2-connection-manifest-{{ENV}}.json" ]; then echo " (âœ… manifest exists)"; else echo " (âš ï¸ no manifest)"; fi

# Fetch current remote state from Cloudflare
res:fetch-state ENV
    @echo "ğŸŒ Fetching remote state from Cloudflare ({{ENV}})"
    @echo "================================================"
    @echo ""
    @if ! command -v wrangler >/dev/null 2>&1; then \
        echo "âŒ Error: wrangler CLI not found"; \
        echo "   Please install wrangler: npm install -g wrangler"; \
        exit 1; \
    fi
    @if ! wrangler whoami >/dev/null 2>&1; then \
        echo "âŒ Error: Not authenticated with Cloudflare"; \
        echo "   Please run: wrangler login"; \
        exit 1; \
    fi
    nix run .#fetch-remote-state -- --env {{ENV}} --verbose

# Compare SOT configuration with remote state (drift detection)
res:diff ENV
    @echo "ğŸ” SOT vs Remote State Comparison ({{ENV}})"
    @echo "==========================================="
    @echo ""
    @if ! command -v wrangler >/dev/null 2>&1; then \
        echo "âŒ Error: wrangler CLI not found"; \
        echo "   Please install wrangler: npm install -g wrangler"; \
        exit 1; \
    fi
    @if ! wrangler whoami >/dev/null 2>&1; then \
        echo "âŒ Error: Not authenticated with Cloudflare"; \
        echo "   Please run: wrangler login"; \
        exit 1; \
    fi
    @if [ ! -f "spec/{{ENV}}/cloudflare.yaml" ]; then \
        echo "âŒ Error: SOT configuration not found"; \
        echo "   Expected: spec/{{ENV}}/cloudflare.yaml"; \
        echo "   Please create SOT configuration for {{ENV}} environment"; \
        exit 1; \
    fi
    @echo "ğŸ” Comparing SOT configuration with remote Cloudflare state..."
    @echo "   SOT file: spec/{{ENV}}/cloudflare.yaml"
    @echo "   Remote: Cloudflare API (via wrangler)"
    @echo ""
    @echo "â„¹ï¸  Exit codes:"
    @echo "   0 = No drift (SOT matches remote)"
    @echo "   1 = Drift detected (differences found)"
    @echo "   2+ = Error (SOT/remote/comparison issues)"
    @echo ""
    node scripts/diff-state.js --env {{ENV}} --format detailed --verbose

# === TESTING & VALIDATION ===

# Test R2 connection
r2:test ENV
    @echo "ğŸ§ª Testing R2 configuration for {{ENV}}..."
    @echo "Running configuration validation (Resource Plane operations only)..."
    nix run .#validate-r2-config -- --env {{ENV}}

# Validate all environments
r2:validate-all
    @echo "ğŸ§ª Validating all R2 environments..."
    @envs=$$(nix run .#discover-r2-envs 2>/dev/null | grep -E '^   - ' | sed 's/^   - //' || echo "dev stg prod"); \
    for env in $$envs; do \
        echo ""; \
        echo "ğŸ” Validating $$env..."; \
        just r2:validate $$env || echo "âŒ Validation failed for $$env"; \
    done

# Check TypeScript and JavaScript syntax
r2:check-syntax
    @echo "ğŸ” Checking syntax..."
    nix flake check

# === DEVELOPMENT WORKFLOWS ===

# Development workflow helper
r2:dev ACTION ENV
    @echo "ğŸš€ R2 Development Workflow: {{ACTION}} for {{ENV}}"
    nix run .#r2-dev-workflow -- {{ENV}} {{ACTION}}

# Quick setup generate + validate
r2:quick ENV
    @echo "âš¡ Quick R2 setup for {{ENV}}..."
    just r2:gen-all {{ENV}}
    just r2:validate {{ENV}}
    @echo "âœ… Quick setup complete for {{ENV}}"

# Prepare for deployment validation
r2:deploy-prep ENV
    @echo "ğŸš€ Preparing {{ENV}} for deployment validation..."
    @echo ""
    @echo "Step 1: Generate fresh configurations"
    just r2:gen-all {{ENV}}
    @echo ""
    @echo "Step 2: Validate configurations"
    just r2:validate {{ENV}}
    @echo ""
    @echo "Step 3: Check syntax and security"
    just r2:check-syntax
    just secrets:check
    @echo ""
    @echo "âœ… {{ENV}} environment ready for deployment!"
    @echo "ğŸ“‹ Next steps:"
    @echo "   - Review generated wrangler.jsonc"
    @echo "   - Test in staging environment if available"
    @echo "   - Deploy with: wrangler deploy"

# === ADVANCED TOOLS ===

# Backup current wrangler.jsonc
r2:backup-config
    @if [ ! -f wrangler.jsonc ]; then \
        echo "âŒ No wrangler.jsonc found to backup"; \
        exit 1; \
    fi
    @backup_file="wrangler.jsonc.backup.$$(date +%Y%m%d_%H%M%S)"; \
    cp wrangler.jsonc "$$backup_file"; \
    echo "ğŸ’¾ Backup created: $$backup_file"

# Restore wrangler.jsonc from backup
r2:restore-config FILE
    @if [ ! -f "{{FILE}}" ]; then \
        echo "âŒ Backup file not found: {{FILE}}"; \
        exit 1; \
    fi
    @if [ -f wrangler.jsonc ]; then \
        echo "ğŸ’¾ Creating backup of current wrangler.jsonc..."; \
        cp wrangler.jsonc "wrangler.jsonc.backup.$$(date +%Y%m%d_%H%M%S)"; \
    fi
    @cp "{{FILE}}" wrangler.jsonc
    @echo "âœ… Restored wrangler.jsonc from {{FILE}}"

# Compare configurations between environments
r2:diff-configs ENV1 ENV2
    @echo "ğŸ” Comparing R2 configurations: {{ENV1}} vs {{ENV2}}"
    @echo "================================================="
    @echo ""
    @if [ ! -f "generated/r2-connection-manifest-{{ENV1}}.json" ]; then \
        echo "âŒ Manifest for {{ENV1}} not found. Run: just r2:gen-manifest {{ENV1}}"; \
        exit 1; \
    fi
    @if [ ! -f "generated/r2-connection-manifest-{{ENV2}}.json" ]; then \
        echo "âŒ Manifest for {{ENV2}} not found. Run: just r2:gen-manifest {{ENV2}}"; \
        exit 1; \
    fi
    @echo "ğŸ“‹ Connection Manifest Differences:"
    @diff -u "generated/r2-connection-manifest-{{ENV1}}.json" "generated/r2-connection-manifest-{{ENV2}}.json" || echo "   Configurations are identical"

# === LEGACY SUPPORT ===

# Legacy command mappings for backward compatibility
# Note: These legacy aliases are kept for backward compatibility but are deprecated
alias r2-status := r2:status
alias r2-test := r2:test
alias r2-gen-config := r2:gen-config
alias r2-check-secrets := secrets:check
alias r2-setup-dry-run := setup

# Initialize encrypted secrets setup (legacy)
secrets-init: secrets:init

# Edit R2 connection secrets (legacy)
secrets-edit: secrets:edit

# === INFRASTRUCTURE AS CODE (PULUMI) ===

# Preview infrastructure changes (CI/CD safe)
cf:plan ENV
    @echo "ğŸ—ï¸ Pulumi Infrastructure Plan for {{ENV}}"
    @echo "========================================"
    @echo ""
    @echo "ğŸ›¡ï¸ Running safety gate validation..."
    @if ! node scripts/pulumi-safety-gate.js --operation plan --env {{ENV}}; then \
        echo "âŒ Safety gate blocked operation"; \
        exit 1; \
    fi
    @echo ""
    @echo "ğŸš€ Executing Pulumi preview..."
    @cd pulumi && pulumi preview --stack {{ENV}}

# Apply infrastructure changes (manual only, diff=0 required)
cf:apply ENV
    @echo "ğŸ—ï¸ Pulumi Infrastructure Apply for {{ENV}}"
    @echo "========================================="
    @echo ""
    @echo "âš ï¸ WARNING: This will modify live infrastructure!"
    @echo "   Environment: {{ENV}}"
    @echo "   Timestamp: $$(date -Iseconds)"
    @echo ""
    @echo "ğŸ›¡ï¸ Running safety gate validation..."
    @if ! node scripts/pulumi-safety-gate.js --operation apply --env {{ENV}}; then \
        echo "âŒ Safety gate blocked operation"; \
        echo ""; \
        echo "ğŸ¯ Prerequisites for cf:apply:"; \
        echo "   âœ… Wrangler authentication"; \
        echo "   âœ… SOT configuration exists"; \
        echo "   âœ… Configuration drift check (diff=0)"; \
        echo "   âœ… Manual execution confirmation"; \
        echo ""; \
        echo "ğŸ“‹ Remediation:"; \
        echo "   1. Run: just res:diff {{ENV}}"; \
        echo "   2. Fix any configuration drift"; \
        echo "   3. Retry cf:apply operation"; \
        exit 1; \
    fi
    @echo ""
    @echo "ğŸš€ Executing Pulumi apply..."
    @cd pulumi && pulumi up --stack {{ENV}} --yes

# Destroy infrastructure resources (manual only, diff=0 required)
cf:destroy ENV
    @echo "ğŸ—ï¸ Pulumi Infrastructure Destroy for {{ENV}}"
    @echo "=============================================="
    @echo ""
    @echo "ğŸš¨ DANGER: This will DESTROY live infrastructure!"
    @echo "   Environment: {{ENV}}"
    @echo "   Timestamp: $$(date -Iseconds)"
    @echo "   Action: IRREVERSIBLE DESTRUCTION"
    @echo ""
    @echo "ğŸ›¡ï¸ Running safety gate validation..."
    @if ! node scripts/pulumi-safety-gate.js --operation destroy --env {{ENV}}; then \
        echo "âŒ Safety gate blocked operation"; \
        echo ""; \
        echo "ğŸ¯ Prerequisites for cf:destroy:"; \
        echo "   âœ… Wrangler authentication"; \
        echo "   âœ… SOT configuration exists"; \
        echo "   âœ… Configuration drift check (diff=0)"; \
        echo "   âœ… Manual execution confirmation"; \
        echo ""; \
        echo "ğŸ“‹ Remediation:"; \
        echo "   1. Run: just res:diff {{ENV}}"; \
        echo "   2. Fix any configuration drift"; \
        echo "   3. Retry cf:destroy operation"; \
        exit 1; \
    fi
    @echo ""
    @echo "ğŸš€ Executing Pulumi destroy..."
    @cd pulumi && pulumi destroy --stack {{ENV}} --yes