# RedwoodSDK R2 Connection Management System
# ==========================================
# Comprehensive toolset for R2 development, configuration, and deployment

# Default environment for commands
DEFAULT_ENV := "dev"

# Help - Show all available commands
help:
    @echo "üöÄ RedwoodSDK R2 Connection Management System"
    @echo "============================================="
    @echo ""
    @echo "üìã Core Commands:"
    @echo "  just help                     - Show this help message"
    @echo "  just setup                    - Complete R2 setup (secrets + config)"
    @echo "  just status                   - Show R2 configuration status"
    @echo "  just clean                    - Clean generated files and backups"
    @echo ""
    @echo "üîê Secret Management:"
    @echo "  just secrets:init             - Initialize encrypted secrets setup"
    @echo "  just secrets:edit [FILE]      - Edit R2 secrets (default: r2.yaml)"
    @echo "  just secrets:check            - Validate secret security"
    @echo ""
    @echo "üîß R2 Configuration:"
    @echo "  just r2:gen-manifest [ENV]    - Generate R2 connection manifest"
    @echo "  just r2:gen-config [ENV]      - Generate wrangler.jsonc configuration"
    @echo "  just r2:gen-all [ENV]         - Generate all configurations"
    @echo "  just r2:validate [ENV]        - Validate R2 configurations"
    @echo ""
    @echo "üåç Environment Management:"
    @echo "  just r2:envs                  - Discover available environments"
    @echo "  just r2:status [ENV]          - Show environment-specific status"
    @echo "  just r2:list-configs          - List all generated configurations"
    @echo ""
    @echo "üß™ Testing & Validation:"
    @echo "  just r2:test [ENV]            - Test R2 connection (local for dev)"
    @echo "  just r2:validate-all          - Validate all environments"
    @echo "  just r2:check-syntax          - Check TypeScript and JS syntax"
    @echo ""
    @echo "üîÑ Development Workflows:"
    @echo "  just r2:dev [ACTION]          - Development workflow (gen/validate/test/full)"
    @echo "  just r2:quick [ENV]           - Quick setup: generate + validate"
    @echo "  just r2:deploy-prep [ENV]     - Prepare for deployment validation"
    @echo ""
    @echo "üõ†Ô∏è Advanced Tools:"
    @echo "  just r2:backup-config         - Backup current wrangler.jsonc"
    @echo "  just r2:restore-config [FILE] - Restore wrangler.jsonc from backup"
    @echo "  just r2:diff-configs ENV1 ENV2 - Compare configurations between environments"
    @echo ""
    @echo "üí° Usage Examples:"
    @echo "  just setup                    # Complete initial setup"
    @echo "  just r2:quick dev             # Quick dev environment setup"
    @echo "  just r2:dev full              # Full development workflow"
    @echo "  just r2:deploy-prep prod      # Prepare production deployment"
    @echo ""
    @echo "üìñ Environment: Default={{DEFAULT_ENV}} (can be overridden with ENV=value)"

# === CORE COMMANDS ===

# Complete R2 setup (secrets + config)
setup:
    @echo "üöÄ Complete R2 Setup"
    @echo "==================="
    @echo "This will initialize secrets and generate default configuration"
    @echo ""
    just secrets:init
    @echo ""
    just r2:gen-config {{DEFAULT_ENV}}
    @echo ""
    @echo "‚úÖ Setup complete! Run 'just status' to verify."

# Show R2 configuration status
status:
    @echo "üìä R2 Configuration Status"
    @echo "=========================="
    @echo -n "üîë Age key: "
    @if [ -f ~/.config/sops/age/keys.txt ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo -n "üîß SOPS config: "
    @if [ -f .sops.yaml ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo -n "üîê R2 secrets: "
    @if [ -f secrets/r2.yaml ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo -n "‚öôÔ∏è  wrangler.jsonc: "
    @if [ -f wrangler.jsonc ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo -n "üìÅ Generated directory: "
    @if [ -d generated ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo ""
    @if [ -f wrangler.jsonc ] && [ -f secrets/r2.yaml ]; then \
        echo "üéâ Ready for R2 development!"; \
        echo "   Run 'just r2:test' to test locally"; \
    else \
        echo "‚öôÔ∏è Run 'just setup' to complete configuration."; \
    fi

# Clean generated files and backups
clean:
    @echo "üßπ Cleaning generated files and backups..."
    @echo "Files to be removed:"
    @if [ -d generated ]; then echo "  - generated/ directory"; fi
    @if [ -f wrangler.jsonc ]; then echo "  - wrangler.jsonc"; fi
    @find . -name "wrangler.jsonc.backup.*" -type f 2>/dev/null | sed 's/^/  - /' || true
    @echo ""
    @echo "Continue? (y/N) " && read answer && [ "$$answer" = "y" ]
    @rm -rf generated/
    @rm -f wrangler.jsonc
    @find . -name "wrangler.jsonc.backup.*" -type f -delete 2>/dev/null || true
    @echo "‚úÖ Cleanup complete"

# === SECRET MANAGEMENT ===

# Initialize encrypted secrets setup
secrets:init:
    @echo "üîê Initializing R2 secrets..."
    nix run .#secrets-init

# Edit R2 connection secrets
secrets:edit FILE="secrets/r2.yaml":
    @echo "‚úèÔ∏è Editing R2 secrets: {{FILE}}"
    nix run .#secrets-edit -- {{FILE}}

# Verify secrets security (no plaintext secrets)
secrets:check:
    @echo "üîç Checking for plaintext secrets..."
    nix flake check

# === R2 CONFIGURATION ===

# Generate R2 connection manifest
r2:gen-manifest ENV=DEFAULT_ENV:
    @echo "üîß Generating R2 connection manifest for {{ENV}}..."
    nix run .#gen-r2-manifest -- --env {{ENV}}

# Generate wrangler.jsonc configuration
r2:gen-config ENV=DEFAULT_ENV:
    @echo "‚öôÔ∏è Generating wrangler.jsonc for {{ENV}}..."
    nix run .#gen-wrangler-config-enhanced -- {{ENV}}

# Generate all R2 configurations
r2:gen-all ENV=DEFAULT_ENV:
    @echo "üîß Generating all R2 configurations for {{ENV}}..."
    just r2:gen-config {{ENV}}
    just r2:gen-manifest {{ENV}}

# Validate R2 configurations
r2:validate ENV=DEFAULT_ENV:
    @echo "üß™ Validating R2 configuration for {{ENV}}..."
    nix run .#validate-r2-config -- --env {{ENV}}

# === ENVIRONMENT MANAGEMENT ===

# Discover available environments
r2:envs:
    @echo "üîç Discovering R2 environments..."
    nix run .#discover-r2-envs

# Show environment-specific status
r2:status ENV=DEFAULT_ENV:
    @echo "üìä R2 Status for {{ENV}} environment"
    @echo "===================================="
    @echo -n "‚öôÔ∏è  wrangler.jsonc: "
    @if [ -f wrangler.jsonc ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo -n "üìã Connection manifest: "
    @if [ -f "generated/r2-connection-manifest-{{ENV}}.json" ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo -n "üîê R2 secrets: "
    @if [ -f secrets/r2.yaml ]; then echo "‚úÖ Found"; else echo "‚ùå Missing"; fi
    @echo ""
    @if [ -f wrangler.jsonc ]; then \
        echo "üè∑Ô∏è  Current configuration:"; \
        echo "   Account ID: $$(jq -r '.account_id // "not set"' wrangler.jsonc)"; \
        echo "   R2 Buckets: $$(jq -r '.r2_buckets[]?.binding // empty' wrangler.jsonc | tr '\n' ' ' | sed 's/ $$//' | sed 's/ /, /g' || echo "none")"; \
    fi

# List all generated configurations
r2:list-configs:
    @echo "üìã Generated R2 Configurations"
    @echo "=============================="
    @if [ -d generated ]; then \
        echo "Connection manifests:"; \
        find generated -name "r2-connection-manifest-*.json" -exec basename {} \; | sed 's/r2-connection-manifest-//; s/.json$$//' | sed 's/^/  - /' || echo "  None found"; \
    else \
        echo "  No generated directory found"; \
    fi
    @echo ""
    @echo "Wrangler configurations:"
    @if [ -f wrangler.jsonc ]; then echo "  - wrangler.jsonc (current)"; else echo "  - None found"; fi
    @find . -name "wrangler.jsonc.backup.*" -type f -exec basename {} \; | sed 's/^/  - /' 2>/dev/null || true

# === TESTING & VALIDATION ===

# Test R2 connection
r2:test ENV=DEFAULT_ENV:
    @echo "üß™ Testing R2 connection for {{ENV}}..."
    @if [ "{{ENV}}" = "dev" ]; then \
        echo "Running local R2 test..."; \
        nix run .#test-r2-local; \
    else \
        echo "‚ö†Ô∏è Remote testing not available for {{ENV}} environment"; \
        echo "   Running configuration validation instead..."; \
        just r2:validate {{ENV}}; \
    fi

# Validate all environments
r2:validate-all:
    @echo "üß™ Validating all R2 environments..."
    @envs=$$(nix run .#discover-r2-envs 2>/dev/null | grep -E '^   - ' | sed 's/^   - //' || echo "dev stg prod"); \
    for env in $$envs; do \
        echo ""; \
        echo "üîç Validating $$env..."; \
        just r2:validate $$env || echo "‚ùå Validation failed for $$env"; \
    done

# Check TypeScript and JavaScript syntax
r2:check-syntax:
    @echo "üîç Checking syntax..."
    nix flake check

# === DEVELOPMENT WORKFLOWS ===

# Development workflow helper
r2:dev ACTION="full" ENV=DEFAULT_ENV:
    @echo "üöÄ R2 Development Workflow: {{ACTION}} for {{ENV}}"
    nix run .#r2-dev-workflow -- {{ENV}} {{ACTION}}

# Quick setup: generate + validate
r2:quick ENV=DEFAULT_ENV:
    @echo "‚ö° Quick R2 setup for {{ENV}}..."
    just r2:gen-all {{ENV}}
    just r2:validate {{ENV}}
    @echo "‚úÖ Quick setup complete for {{ENV}}"

# Prepare for deployment validation
r2:deploy-prep ENV:
    @echo "üöÄ Preparing {{ENV}} for deployment validation..."
    @echo ""
    @echo "Step 1: Generate fresh configurations"
    just r2:gen-all {{ENV}}
    @echo ""
    @echo "Step 2: Validate configurations"
    just r2:validate {{ENV}}
    @echo ""
    @echo "Step 3: Check syntax and security"
    just r2:check-syntax
    just secrets:check
    @echo ""
    @echo "‚úÖ {{ENV}} environment ready for deployment!"
    @echo "üìã Next steps:"
    @echo "   - Review generated wrangler.jsonc"
    @echo "   - Test in staging environment if available"
    @echo "   - Deploy with: wrangler deploy"

# === ADVANCED TOOLS ===

# Backup current wrangler.jsonc
r2:backup-config:
    @if [ ! -f wrangler.jsonc ]; then \
        echo "‚ùå No wrangler.jsonc found to backup"; \
        exit 1; \
    fi
    @backup_file="wrangler.jsonc.backup.$$(date +%Y%m%d_%H%M%S)"; \
    cp wrangler.jsonc "$$backup_file"; \
    echo "üíæ Backup created: $$backup_file"

# Restore wrangler.jsonc from backup
r2:restore-config FILE:
    @if [ ! -f "{{FILE}}" ]; then \
        echo "‚ùå Backup file not found: {{FILE}}"; \
        exit 1; \
    fi
    @if [ -f wrangler.jsonc ]; then \
        echo "üíæ Creating backup of current wrangler.jsonc..."; \
        cp wrangler.jsonc "wrangler.jsonc.backup.$$(date +%Y%m%d_%H%M%S)"; \
    fi
    @cp "{{FILE}}" wrangler.jsonc
    @echo "‚úÖ Restored wrangler.jsonc from {{FILE}}"

# Compare configurations between environments
r2:diff-configs ENV1 ENV2:
    @echo "üîç Comparing R2 configurations: {{ENV1}} vs {{ENV2}}"
    @echo "================================================="
    @echo ""
    @if [ ! -f "generated/r2-connection-manifest-{{ENV1}}.json" ]; then \
        echo "‚ùå Manifest for {{ENV1}} not found. Run: just r2:gen-manifest {{ENV1}}"; \
        exit 1; \
    fi
    @if [ ! -f "generated/r2-connection-manifest-{{ENV2}}.json" ]; then \
        echo "‚ùå Manifest for {{ENV2}} not found. Run: just r2:gen-manifest {{ENV2}}"; \
        exit 1; \
    fi
    @echo "üìã Connection Manifest Differences:"
    @diff -u "generated/r2-connection-manifest-{{ENV1}}.json" "generated/r2-connection-manifest-{{ENV2}}.json" || echo "   Configurations are identical"

# === LEGACY SUPPORT ===

# Legacy command mappings for backward compatibility
r2\:status: r2:status
r2\:test: r2:test
r2\:gen-config: r2:gen-config
r2\:gen-config-env ENV: (r2:gen-config ENV)
r2\:gen-config-prod: (r2:gen-config "prod")
r2\:gen-config-stg: (r2:gen-config "stg")
r2\:validate ENV: (r2:validate ENV)
r2\:check-secrets: secrets:check
r2\:setup-dry-run: setup

# Initialize encrypted secrets setup (legacy)
secrets-init: secrets:init

# Edit R2 connection secrets (legacy)
secrets-edit: secrets:edit