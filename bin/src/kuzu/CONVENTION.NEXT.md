# Kuzu Query システム規約準拠率向上タスク

## 📊 現状の規約準拠率

| 項目 | 準拠状況 | 評価 | 詳細 |
|------|----------|------|------|
| 型定義方式 | ✅ 95% | type定義優先、一部interface残存 | testsディレクトリのみ3箇所でinterface使用 |
| 関数型原則 | ✅ 90% | 高階関数DI実装済み | 汎用システムで高階関数依存性注入完了 |
| エラー処理 | ❌ 60% | throw使用箇所が複数存在 | **10ファイル15箇所でthrow使用** |
| パターンマッチ | ❌ 40% | if-else多用、switch不足 | 30ファイルでif文、switch使用も30ファイル |
| 設定管理 | ❌ 30% | ハードコード多数 | **1箇所でハードコードパス使用** |
| 汎用記述方式 | ✅ 85% | Result型回避済み | 共用体型によるエラー処理実装済み |

---

## 🎯 規約準拠率向上作業対象一覧

### 1. **エラー処理修正** (優先度: 🔴 最高)

**対象ファイル: 10個**
| ファイル | throw箇所数 | 修正内容 |
|---------|------------|---------|
| `integratedValidationRepository.ts` | 3箇所 | throw → エラー型返却 |
| `browserQueryRepository.ts` | 2箇所 | throw → エラー型返却 |
| `queryResult.ts` | 1箇所 | throw → エラー型返却 |
| `locationUri.ts` | 1箇所 | throw → エラー型返却 |
| `queryExecutor.ts` | 2箇所 | throw → エラー型返却 |
| `queryClient.ts` | 1箇所 | throw → エラー型返却 |
| `repositoryFactory.ts` | 1箇所 | throw → エラー型返却 |
| `dmlGenerator.ts` | 2箇所 | throw → エラー型返却 |
| `queryAdapter.ts` | 1箇所 | throw → エラー型返却 |
| `denoQueryRepository.ts` | 1箇所 | throw → エラー型返却 |

**合計**: 15箇所のthrow文をエラー型返却に変更

### 2. **デフォルト引数削除** (優先度: 🟡 中)

**対象ファイル: 8個**
| ファイル | デフォルト引数箇所数 | 修正内容 |
|---------|-------------------|---------|
| `browserQueryRepository.ts` | `= []` 3箇所 | 明示的引数に変更 |
| `nodeQueryRepository.ts` | `= []` 2箇所 | 明示的引数に変更 |
| `denoQueryRepository.ts` | `= []` 2箇所 | 明示的引数に変更 |
| `queryExecutor.ts` | `= []` 1箇所 | 明示的引数に変更 |
| `executeQuery.ts` | `= []` 1箇所 | 明示的引数に変更 |
| `generateQueries.ts` | `= []` 1箇所 | 明示的引数に変更 |
| `queryResult.ts` | `= []` 1箇所 | 明示的引数に変更 |
| `dmlGenerator.ts` | `= []` 2箇所 | 明示的引数に変更 |

**合計**: 13箇所のデフォルト引数を明示的引数に変更

### 3. **設定管理統一** (優先度: 🟠 中高)

**対象ファイル: 1個**
| ファイル | ハードコード箇所 | 修正内容 |
|---------|-----------------|---------|
| `integratedDmlService.ts` | `/home/nixos/bin/src/kuzu/query/dml` | variables.tsから取得 |

**合計**: 1箇所のハードコードパスを設定管理に移行

### 4. **パターンマッチ強化** (優先度: 🟢 低)

**現状**: 
- **30個のファイル**でif文使用
- **30個のファイル**でswitch文使用済み
- **比率**: 50% → 90%目標

**修正内容**: 複雑なif-else chainをswitch文に変更

### 5. **型定義方式統一** (優先度: 🟢 低)

**対象ファイル: 3個**（testsディレクトリのみ）
- 実装ファイルでは既にtype定義優先済み

---

## 📋 推奨作業順序

### Phase A: **エラー処理完全統一** (🔴 最高優先度)
- **作業量**: 15箇所のthrow文修正
- **効果**: 規約準拠率 60% → 95%
- **推定時間**: 30分

### Phase B: **設定管理統一** (🟠 中高優先度) 
- **作業量**: variables.ts作成 + 1箇所修正
- **効果**: 規約準拠率 30% → 90%
- **推定時間**: 10分

### Phase C: **デフォルト引数削除** (🟡 中優先度)
- **作業量**: 13箇所のデフォルト引数修正
- **効果**: 呼び出し側を明示的に統一
- **推定時間**: 20分

### Phase D: **パターンマッチ強化** (🟢 低優先度)
- **作業量**: 複雑なif-else → switch変換
- **効果**: 規約準拠率 40% → 80%
- **推定時間**: 40分

---

## 🎯 規約準拠率向上目標

**現在の総合準拠率**: **67%**
**目標準拠率**: **90%**

**Phase A + B 完了時**: **85%**
**全Phase完了時**: **92%**

---

## 📈 期待される効果

1. **コード品質向上**: 例外処理の統一によるエラーハンドリングの一貫性確保
2. **保守性向上**: 設定の外部化によるハードコード削減
3. **可読性向上**: パターンマッチによる条件分岐の明確化
4. **規約遵守**: 関数型プログラミング原則の完全適用

---

## 🚀 次のアクション

**Phase A（エラー処理統一）から開始推奨**
- 最も規約違反度が高く、効果も最大
- 他のPhaseの基盤となる重要な修正
