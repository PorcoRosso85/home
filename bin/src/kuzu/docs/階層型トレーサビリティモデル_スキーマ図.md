# 階層型トレーサビリティモデル スキーマ図

このドキュメントはトレーサビリティモデルのグラフデータベーススキーマを定義します。

```mermaid
flowchart TD
    %% ノード型の定義
    CodeEntity[("CodeEntity
    ---
    persistent_id: String
    name: String
    type: String
    signature: String
    complexity: Int
    start_position: Int
    end_position: Int")]
    
    RequirementEntity[("RequirementEntity
    ---
    id: String
    title: String
    description: String
    priority: String
    requirement_type: String")]
    
    LocationURI[("LocationURI
    ---
    scheme: String
    authority: String
    path: String
    fragment: String
    query: String")]
    
    VersionState[("VersionState
    ---
    id: String
    timestamp: DateTime
    description: String
    is_realized: Bool
    commit_id: String
    branch_name: String")]
    
    ReferenceEntity[("ReferenceEntity
    ---
    uri: String
    type: String
    version: String
    last_fetched: DateTime
    source_type: String")]
    
    %% フェーズ0追加ノード
    RequirementVerification[("RequirementVerification
    ---
    id: String
    name: String
    description: String
    verification_type: String
    verification_steps: Map
    expected_outcome: Map")]
    
    %% EntityAggregationViewノード
    EntityAggregationView[("EntityAggregationView
    ---
    aggregation_config: Map
    view_type: String
    filter_criteria: Map")]
    
    %% エッジの定義
    %% 基本的な関係
    CodeEntity -->|HAS_LOCATION| LocationURI
    RequirementEntity -->|HAS_LOCATION| LocationURI
    
    CodeEntity -->|REFERENCES| CodeEntity
    CodeEntity -->|REFERENCES| ReferenceEntity
    
    %% 要件間の関係 - 依存関係のみ残し、階層関係はLocationURIへ移行
    RequirementEntity -->|DEPENDS_ON| RequirementEntity
    
    %% 実装関係
    RequirementEntity -->|IS_IMPLEMENTED_BY| CodeEntity
    
    %% フェーズ0の関係
    RequirementEntity -->|VERIFIED_BY| RequirementVerification
    RequirementVerification -->|IS_IMPLEMENTED_BY| CodeEntity
    
    %% バージョン関連の関係
    VersionState -->|FOLLOWS| VersionState
    VersionState -->|TRACKS_STATE_OF| CodeEntity
    VersionState -->|TRACKS_STATE_OF| RequirementEntity
    
    %% LocationURI間の階層関係 - 要件とコードの階層構造を一元管理
    LocationURI -->|CONTAINS| LocationURI
    
    %% EntityAggregationViewの関係
    EntityAggregationView -->|USES| LocationURI
    EntityAggregationView -->|AGGREGATES| RequirementEntity
    EntityAggregationView -->|AGGREGATES| CodeEntity
    
    %% スタイル定義
    classDef node fill:#d4f0fd,stroke:#333,stroke-width:2px,color:#000
    classDef phase0Node fill:#d4ffcc,stroke:#383,stroke-width:2px,stroke-dasharray: 5 5,color:#000
    
    class CodeEntity,RequirementEntity,LocationURI,VersionState,ReferenceEntity,EntityAggregationView node
    class RequirementVerification phase0Node

    %% メタデータ注釈 - ノードとして追加
    subgraph SchemaInfo["スキーマメタデータ"]
        NodeTypeInfo["ノード型に関する注釈:
        - LocationURI: 要件・コード双方の階層を表現するノード
        - CodeEntity: 最下層のコード要素（関数、クラス等）
        - RequirementEntity: 最下層の要件要素
        - EntityAggregationView: URI階層から上位構造を生成・集計"]
        
        EdgeTypeInfo["エッジ型に関する注釈:
        - エッジ属性により関係の詳細を区別:
          - REFERENCES.ref_type: 'code'/'external' - コード参照/外部参照
          - DEPENDS_ON.dependency_type: 'technical'/'functional' - 依存関係の種類
          - IS_IMPLEMENTED_BY.implementation_type: 'direct'/'verification' - 実装の種類
          - CONTAINS.relation_type: 'version'/'location' - コンテナの種類
          - AGGREGATES.target_type: 'requirement'/'code' - 集計対象の種類"]
    end
```

## スキーマ説明

### ノード型

1. **CodeEntity**: コードの構成要素（関数、クラス、メソッドなど）を表すノード
   - 最下層のコードエンティティのみ使用
   - type属性により種類を区別（function, class, test, build_configなど）
   - 上位構造はLocationURIの階層で表現

2. **RequirementEntity**: システム要件を表すノード
   - 最下層の要件エンティティのみ使用
   - requirement_type属性により種類を区別（functional, security, performanceなど）
   - 上位要件はLocationURIの階層で表現

3. **LocationURI**: コードや要件の場所情報を保持するノード
   - 要件・コード双方の階層を表現
   - scheme属性: 'file', 'requirement', 'test'などに使用
   - fragment属性: 上位要件への参照などに使用
   - LocationURI間のCONTAINS関係で階層構造を表現

4. **VersionState**: バージョン管理情報を表すノード
   - branch_name属性: バージョンのブランチ情報（オプション）

5. **ReferenceEntity**: 外部参照情報を保持するノード
   - source_type属性: 参照ソースの種類を区別

6. **RequirementVerification**: 要件の検証方法を定義するノード（フェーズ0の拡張）

7. **EntityAggregationView**: URI階層から上位構造を生成し集計するためのノード
   - URI階層から上位構造を生成
   - 最下層エンティティの状態を集計
   - 進捗・カバレッジ・影響分析を提供

### エッジ型

#### 基本的な関係
- **HAS_LOCATION**: エンティティの位置情報を関連付ける
- **REFERENCES**: コード間の参照関係や外部参照への関係
  - ref_type属性で参照種別を区別（code/external）

#### 要件間の関係
- **DEPENDS_ON**: ある要件が別の要件に依存していることを表す関係
  - dependency_type属性で依存種別を区別（technical/functionalなど）

#### 実装関係
- **IS_IMPLEMENTED_BY**: 要件や検証のコードによる実装関係
  - implementation_type属性で実装種別を区別（direct/verificationなど）
- **VERIFIED_BY**: 要件と検証の関連付け

#### 階層関係
- **CONTAINS**: 親子関係を表すエッジ
  - relation_type属性で関係種別を区別（version/location）
  - LocationURI間のCONTAINS関係で要件とコードの階層構造を表現

#### バージョン関連
- **FOLLOWS**: バージョン間の順序関係
- **TRACKS_STATE_OF**: バージョンとエンティティ（コード/要件）の状態追跡関係

#### 集計ビュー関連
- **USES**: 集計ビューとURI階層の関連付け
- **AGGREGATES**: 状態の集計関係
  - target_type属性で集計対象を区別（requirement/code）

### 注意事項

- 要件とコードの階層構造はすべてLocationURIノードと、そのノード間のCONTAINS関係で表現します
- エッジ名は簡潔にし、詳細はエッジの属性で区別します
- 循環依存の検出には注意が必要です
