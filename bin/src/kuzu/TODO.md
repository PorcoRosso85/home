# 動作不一致の修正事項

READMEやヘルプの情報と実際の動作に不一致がある箇所：

2. `--query` コマンドで `MATCH (n) RETURN n` のような汎用的なクエリを実行すると `Binder exception: Expected the same data type for property id but found STRING and INT32.` というエラーが発生する

3. READMEにはコマンドの詳細な使用例が記載されているが、実際には引数の渡し方に問題があり動作しない例がある

4. 初期化処理（`--init`）は成功しているように見えるが、その後にクエリを実行しても期待通りのデータが取得できない

6. データベースノード参照時に型の不一致エラーが発生するが、この問題に対する解決方法や回避策がドキュメントにない

7. コマンドラインからの引数の渡し方に一貫性がなく、特に値を必要とするコマンドの動作が不安定

# リファクタリング計画

以下は、プロジェクトの改善を目的としたリファクタリング計画です。

## 完了したリファクタリング

### 0. デフォルト引数の禁止 ✓
- CONVENTION.mdに既に記載があり、プロジェクト全体で実施を徹底
- コード内のデフォルト引数使用箇所を削除
- 明示的な引数を要求するAPI設計に変更

### 1. クエリファイルパスの固定化 ✓
- DMLとDDLのディレクトリ構造を固定し、動的パス構築を廃止
- クエリのパス解決を簡素化し、予測可能性を向上
- ディレクトリ構造を変数として定義

### 2. コード可読性の改善 ✓
- 冗長なコメントの削除
- 関数の責務をより明確にする
- 冗長な引数名の削除
- シンプルな関数ドキュメント

## 未完了のリファクタリング案

### 3. SHACL検証のモジュール化
- SHACL検証機能を分離してより再利用しやすくする
- 検証ロジックを独立したモジュールとして実装
- 検証ルールを外部ファイルで管理し、拡張性を向上

### 4. エラーハンドリングの統一
- 異なるエラー形式を標準化
- 一貫したエラーメッセージ形式の採用
- 共通のエラーコードとメッセージ体系の確立
- エラー識別関数の統一

### 5. クエリローダーのインターフェース簡素化
- より少ないメソッドでインターフェースを提供
- 重複機能の統合
- API表面を減らし、使いやすさを向上

### 6. DB接続の単一責任化
- インメモリとディスクモードの条件分岐を整理
- 接続ロジックの抽象化
- 各接続モードごとに専用のファクトリ関数を用意

### 7. CLI機能の整理
- ヘルプ機能のさらなる簡素化
- デバッグログ出力の整理
- コマンドラインインターフェースの一貫性向上
- ユーザーエクスペリエンスの改善

### 8. テストの拡充
- 単体テストの追加
- エッジケースのカバレッジ拡大
- テスト駆動開発の推進
- テスト実行の自動化と継続的インテグレーション

### 9. パフォーマンス最適化
- 不要な中間オブジェクトの削減
- メモリ使用量の最適化
- 大量データ処理時の効率改善
- ボトルネックの特定と解消

### 10. 型定義のさらなる整理
- 必須でない型の削除
- 型定義の集約
- 型階層の整理と簡素化
- 型の一貫性確保

## 責務分担のリファクタリング

- [ ] upsertモジュールの責務構造を正しく整理する：
  - main -> cli -> 各コマンド（以降サブコマンド含め再帰処理）の階層構造に統一
  - main, cliモジュールから特定コマンドの実装詳細を削除
  
- [ ] initコマンド関連の責務整理：
  - [ ] cli.pyから特定コマンドに関するヘルプや使用例を削除し、initialize.pyに移動
  - [ ] with-dataフラグに関する処理をinitialize.pyに完全に移動
  - [ ] cli.pyの以下の記述を削除：
    ```python
    # initコマンド用の追加オプション
    parser.add_argument("--with-data", action="store_true", help="初期化時に初期データも登録する")
    parser.add_argument("--data-dir", help="初期データディレクトリのパス（デフォルト: query/init）")
    ```
  - [ ] サブコマンド構造に対応したargparseのサブパーサーを実装
    ```python
    # 例: サブパーサー実装例
    init_parser = subparsers.add_parser("init", help="データベースを初期化")
    init_parser.add_argument("--with-data", action="store_true", help="初期化時に初期データも登録する")
    init_parser.add_argument("--data-dir", help="初期データディレクトリのパス")
    ```

- [ ] コマンドハンドラの責務整理：
  - [ ] 各コマンドが自身の引数と説明を定義する構造に変更
  - [ ] 現在cliモジュールに散在しているコマンド固有のロジックを各コマンドモジュールに移動
  - [ ] コマンドヘルプや例を各コマンドモジュールから取得するよう変更

- [ ] print_help関数の改善：
  - [ ] 動的にコマンドから使用例とヘルプを取得するよう変更
  - [ ] 各コマンドが独自のヘルプ情報を提供するインターフェースを設計

- [ ] 高レベルモジュールの純粋化：
  - [ ] __main__.pyはcliモジュールの呼び出しに集中
  - [ ] cli.pyはコマンド検出と実行の調整に集中
  - [ ] 特定コマンドの実装知識を高レベルモジュールから完全に排除


## エラー処理のリファクタリング

- [ ] CONVENTION.mdに準拠したエラー処理の実装
  - [ ] try/except構文の排除
  - [ ] argparseの使用を廃止し、独自の引数解析に置き換え
  - [ ] 型による明示的なエラー処理の実装
  - [ ] コマンド側と呼び出し側でのエラー処理の責務分離の徹底

- [ ] CLIモジュールのリファクタリング
  - [ ] 引数解析ロジックを純粋関数に置き換え
  - [ ] 例外からエラー型への移行
  - [ ] 動的エラーメッセージ処理の実装

- [ ] 各コマンドのエラー処理統一
  - [ ] すべてのコマンドでTypedDictベースのエラー型を実装
  - [ ] エラーヘルプと実行例提供関数の実装
  - [ ] 一貫したエラー型インターフェースの提供
