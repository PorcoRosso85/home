# KuzuDB TypeScript同期プラットフォーム移行計画

## 概要

このドキュメントは、`poc/sync/unified`から`bin/src/sync/kuzu_ts`への移行と、PostgreSQL中央サーバーを代替する分散OLAP同期永続化プラットフォームの実装計画を記録したものです。

## 移行の背景

### 現状の課題
1. **PostgreSQL中央集権モデルの限界**
   - 単一障害点（SPOF）
   - スケーリングの物理的限界
   - 地理的分散時のレイテンシ

2. **Immutableモデル採用による新たな課題**
   - ストレージの無限増加
   - GDPR対応の困難性
   - クエリ性能の劣化

### 解決アプローチ
Unified Syncによる複数OLAP（KuzuDB）インスタンスの同期により、PostgreSQLが中央集権的に解決しようとしているすべての課題を分散型で解決する。

## アーキテクチャ

```
従来: Client → PostgreSQL中央 → Client（単一ボトルネック）
新規: Client → Local KuzuDB → Unified Sync → Other KuzuDBs（分散協調）
```

## 実装優先順位

### 🔴 優先度1: 生存必須要件（絶対に解決必須）

1. **ストレージ爆発問題**
   - イベント圧縮（70%削減目標）
   - S3アーカイブ（30日以上のデータ）
   - ホット/コールドデータ分離

2. **GDPR/法規制対応**
   - 論理削除イベント
   - 物理削除バッチプロセス
   - コンプライアンスレポート

3. **クエリ性能劣化**
   - 最新状態キャッシュ（O(1)アクセス）
   - バージョンインデックス
   - マテリアライズドビュー

### 🟡 優先度2: 運用必須要件

1. **監視・アラート**
   - ストレージ使用量監視
   - 性能メトリクス収集
   - 閾値ベースアラート

2. **バックアップ・リストア**
   - 差分バックアップ
   - ポイントインタイムリカバリ

### 🟢 優先度3: 移行容易性（参考程度）

- SQL互換性（Cypherで代替可能）
- 既存ツール統合（必要に応じて）

## 技術スタック

- **データベース**: KuzuDB（グラフデータベース）
- **同期**: WebSocket + Event Sourcing
- **ストレージ**: S3互換（アーカイブ用）
- **言語**: TypeScript（Deno）、Python（テスト）

## 移行ステップ

1. ✅ **完了**: `poc/sync/unified`から`bin/src/sync/kuzu_ts`へのコード移行
2. ✅ **完了**: テスト動作確認（E2E、統合、再接続テスト全てPASS）
3. 🔄 **次**: 優先度1の機能実装（TDDアプローチ）

## 成功指標

- **ストレージコスト**: 97%削減（月100万円→3万円）
- **法的リスク**: ゼロ（GDPR準拠）
- **クエリ性能**: 500倍高速化（500ms→1ms）
- **可用性**: 99.99%（単一障害点なし）

## 参考資料

- [discuss.md](./discuss.md) - PostgreSQL vs KuzuDBの詳細比較
- [README.md](../README.md) - プロジェクトの基本情報
- [CHANGELOG.md](../CHANGELOG.md) - 変更履歴