# KuzuDB インデックス分析レポート

## 取得日時
2025-01-26

## 情報源
https://docs.kuzudb.com/cypher/query-clauses/call/#show_indexes

## 1. KuzuDBがサポートするインデックスの種類

現在のドキュメントから確認できるインデックス：

### 1.1 FTS (Full-Text Search) インデックス
- テキスト検索用のインデックス
- 複数のプロパティに対して作成可能
- stemmerオプション（例：'porter'）をサポート
- 作成例：
```cypher
CALL CREATE_FTS_INDEX('book', 'bookIdx', ['abstract', 'author', 'title'], stemmer := 'porter');
```

### 1.2 HNSW (Hierarchical Navigable Small World) インデックス
- ベクトル検索用のインデックス
- 高次元データの近似最近傍探索に使用

## 2. インデックスの作成方法

### インデックス情報の確認
```cypher
CALL SHOW_INDEXES() RETURN *;
```

返される情報：
- table：テーブル名
- name：インデックス名
- index_type：インデックスタイプ
- property_names：対象プロパティ名
- extension_loaded：必要な拡張機能の読み込み状態
- definition：インデックス定義

## 3. インデックスが自動的に作成されるケース

**重要な発見：ドキュメントには自動インデックス作成に関する情報が含まれていない**

これは、KuzuDBが以下の可能性を示唆します：
- プライマリキーに対する自動インデックス作成がない可能性
- 外部キー制約に対する自動インデックス作成がない可能性
- 手動でのインデックス管理が必要

## 4. パフォーマンスへの影響

ドキュメントから直接的なパフォーマンス情報は得られませんでしたが、以下が推測されます：

### 4.1 検索パフォーマンス
- FTSインデックス：全文検索の高速化
- HNSWインデックス：ベクトル類似検索の高速化

### 4.2 書き込みパフォーマンス
- インデックスメンテナンスのオーバーヘッド（一般的な傾向）

## 現在の誤解の説明

### 1. イベントがKuzuDBインスタンスに保持される仕組み

**誤解の原因：**
- KuzuDBは組み込みデータベースであり、インスタンスは単一プロセス内に存在
- 「保持される」という表現が、永続化されたディスク上のデータと、メモリ上のインスタンスの混同を招いている

**実際の仕組み：**
1. KuzuDBインスタンスは、アプリケーションプロセス内で作成・破棄される
2. データは永続化されるが、インスタンス自体は保持されない
3. 各クエリ実行時に、ディスクからデータを読み込む必要がある

### 2. 集計クエリのパフォーマンス（OLAP vs OLTP）

**KuzuDBの位置づけ：**
- 組み込みグラフデータベース
- OLAP（分析処理）寄りの設計
- 列指向ストレージによる効率的な集計

**パフォーマンス特性：**
```
OLTP（トランザクション処理）向け：
- 単一レコードの高速アクセス
- 頻繁な小規模更新
- 低レイテンシ

OLAP（分析処理）向け：
- 大量データの集計・分析
- バッチ処理
- スループット重視
```

### 3. なぜ「保持されたインスタンスからの集計」でも違いが生じるのか

**根本的な誤解：**
「保持されたインスタンス」という概念自体が誤り

**実際の処理フロー：**
1. アプリケーション起動時：KuzuDBインスタンス作成
2. クエリ実行時：
   - ディスクからデータ読み込み
   - メモリ上で処理
   - 結果返却
3. アプリケーション終了時：インスタンス破棄

**パフォーマンス差の真の原因：**
- インデックスの有無
- データの物理的配置
- キャッシュの効果
- クエリプランの最適化

## 推奨事項

1. **インデックス戦略の見直し**
   - 頻繁にクエリされるプロパティへのインデックス追加
   - 特に集計で使用されるカラムへのインデックス検討

2. **アーキテクチャの再考**
   - KuzuDBを永続化層として使用
   - 集計結果のキャッシング層の導入
   - イベントソーシングパターンの適切な実装

3. **パフォーマンステスト**
   - 実際のデータ量でのベンチマーク
   - インデックス有無での比較
   - 適切なクエリプランの確認