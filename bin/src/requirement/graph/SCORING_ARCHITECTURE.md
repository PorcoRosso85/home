# スコアリングアーキテクチャ

## 概要
要件の整合性に関するすべてのスコアリングロジックはApplication層の`ScoringService`に集約されています。

## アーキテクチャ

```
┌───────────────────────────────────────────────────────────────────┐
│ Presentation層 (main.py)                                          │
│  - 外部入力の受付                                                 │
│  - スコアリング結果の出力                                         │
└─────────────────────────┬─────────────────────────────────────────┘
                          │
┌─────────────────────────▼─────────────────────────────────────────┐
│ Application層 (ScoringService)                                    │
│  - 統一されたスコアリング責務                                     │
│  - calculate_score(): 違反タイプに基づくスコア計算                │
│  - evaluate_violations(): 複数違反の評価                          │
│  - get_score_message(): スコアに応じたメッセージ生成             │
└─────────────────────────┬─────────────────────────────────────────┘
                          │
┌─────────────────────────▼─────────────────────────────────────────┐
│ Infrastructure層                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ HierarchyValidator                                          │ │
│  │  - 階層制約の検証のみ（スコア計算なし）                     │ │
│  │  - violation_typeとviolation_infoを返す                     │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ CustomProcedures                                            │ │
│  │  - 類似要件検索（スコアリングなし）                         │ │
│  │  - 制約違反チェック（スコアリングなし）                     │ │
│  │  - 影響分析（スコアリングなし）                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────┘
```

## スコア定義

| 違反タイプ | スコア | 説明 |
|-----------|--------|------|
| hierarchy_violation | -1.0 | 階層違反（下位が上位に依存） |
| self_reference | -1.0 | 自己参照 |
| circular_reference | -1.0 | 循環参照 |
| title_level_mismatch | -0.3 | タイトルと階層レベルの不整合 |
| constraint_violations | -0.2 × 違反数 | 制約違反（最大-1.0） |
| no_violation | 0.0 | 違反なし |

## データフロー

1. **外部入力** → main.py
2. **検証** → HierarchyValidator（違反検出）
3. **スコア計算** → ScoringService（スコアリング）
4. **応答** → main.py → 外部出力

## 利点

1. **単一責任の原則**: スコアリングロジックが一箇所に集約
2. **テスタビリティ**: ScoringServiceを独立してテスト可能
3. **拡張性**: 新しい違反タイプの追加が容易
4. **保守性**: スコアリングルールの変更が一箇所で完結