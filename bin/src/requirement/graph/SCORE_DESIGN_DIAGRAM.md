# スコア設計のシーケンス図

## 全体的なスコアリングフロー

```
┌─────────┐        ┌──────────┐        ┌─────────┐        ┌──────────┐
│ Client  │        │   Main   │        │ Domain  │        │  Infra   │
│(Me/LLM) │        │ (App)    │        │ Layer   │        │  Layer   │
└────┬────┘        └────┬─────┘        └────┬────┘        └────┬─────┘
     │                   │                   │                   │
     │ Cypher Query      │                   │                   │
     ├──────────────────>│                   │                   │
     │                   │                   │                   │
     │                   ├─ 1. 違反検出依頼 │                   │
     │                   ├───────────────────────────────────────>│
     │                   │                   │                   │
     │                   │                   │   違反情報      │
     │                   │<────────────────────────────────────────┤
     │                   │                   │                   │
     │                   ├─ 2. スコア計算   │                   │
     │                   ├──────────────────>│                   │
     │                   │                   │                   │
     │                   │                   ├─ ルール適用    │
     │                   │                   ├─ 重み付け計算  │
     │                   │                   ├─ 例外処理      │
     │                   │                   │                   │
     │                   │   スコア結果     │                   │
     │                   │<──────────────────┤                   │
     │                   │                   │                   │
     │                   ├─ 3. メッセージ生成│                   │
     │                   ├──────────────────>│                   │
     │                   │                   │                   │
     │ JSONL Response    │   人間向け      │                   │
     │<──────────────────┤   メッセージ    │                   │
     │ (score+message)   │<──────────────────┤                   │
     │                   │                   │                   │
```

## スコア計算の詳細フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Domain Layer (スコアリング)                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐      ┌──────────────────┐     ┌────────────────┐ │
│  │ ViolationScores │      │  FrictionRules   │     │HealthAssessment│ │
│  │                 │      │                  │     │                │ │
│  │ ・階層違反 -1.0  │      │ ・曖昧性         │     │ ・重み付き平均  │ │
│  │ ・自己参照 -1.0  │      │ ・優先度競合     │     │ ・3段階評価     │ │
│  │ ・循環参照 -1.0  │      │ ・時間経過       │     │ ・改善提案      │ │
│  │ ・タイトル -0.3  │      │ ・矛盾           │     │                │ │
│  └────────┬────────┘      └────────┬─────────┘     └────────┬───────┘ │
│           │                         │                         │         │
│           └─────────────────────────┴─────────────────────────┘         │
│                                     │                                   │
│                          ┌──────────▼──────────┐                       │
│                          │  ScoreCalculator   │                       │
│                          │                     │                       │
│                          │ 1. 違反タイプ判定   │                       │
│                          │ 2. ルール適用       │                       │
│                          │ 3. 組織モード調整   │                       │
│                          │ 4. 総合スコア計算   │                       │
│                          └─────────────────────┘                       │
└─────────────────────────────────────────────────────────────────────────┘
```

## スコアレベルと健全性マッピング

```
スコア範囲        違反レベル          健全性            アクション
─────────────────────────────────────────────────────────────────────────
    0.0         なし              Healthy          続行可能
                                 (健全)           
   -0.1         ┌─────────────┐                   
   -0.2         │   Minor     │                   推奨事項あり
   -0.3         │  (軽微)     │  Needs           
   -0.4         └─────────────┘  Attention        
   -0.5         ┌─────────────┐  (要注意)         修正推奨
   -0.6         │  Moderate   │                   
   -0.7         │  (中程度)   │                   
   -0.8         └─────────────┘  Critical         
   -0.9         ┌─────────────┐  (危機的)         即座に対応必要
   -1.0         │  Critical   │                   
                │  (重大)     │  Blocked          変更不可
                └─────────────┘  (ブロック)       
```

## 摩擦スコアの累積計算

```
                    曖昧性摩擦              優先度摩擦              時間摩擦
                        │                      │                      │
                    ┌───▼───┐             ┌───▼───┐             ┌───▼───┐
解釈数: 2 ────────> │ -0.6  │   高優先3つ─> │ -0.7  │   5バージョン>│ -0.8  │
曖昧用語: 3 ──┐     └───┬───┘   競合あり    └───┬───┘   大幅変更    └───┬───┘
              │         │                      │                      │
           ┌──▼──┐      │                      │                      │
           │-0.3 │      │                      │                      │
           └──┬──┘      │                      │                      │
              │         │                      │                      │
              └─────────┴──────────────────────┴──────────────────────┘
                                              │
                                    ┌─────────▼─────────┐
                                    │   総合摩擦スコア   │
                                    │                   │
                                    │  合計: -2.4       │
                                    │  正規化: -0.8     │
                                    └───────────────────┘
```

## 例外ルールの適用フロー

```
通常フロー:                          緊急時フロー (hotfix):
                                    
階層違反 ────> スコア: -1.0          階層違反 ────> スコア: -1.0
                   │                                    │
                   ▼                                    ▼
            ┌──────────────┐                    ┌──────────────┐
            │ 通常ルール   │                    │ 緊急時ルール │
            │ 適用         │                    │ 適用         │
            └──────┬───────┘                    └──────┬───────┘
                   │                                    │
                   ▼                                    ▼
            最終スコア: -1.0                     最終スコア: -0.5
            (変更ブロック)                       (警告のみ)
```

## 組織モード別の重み付け

```
┌─────────────────────────────────────────────────────────────────────┐
│                        スタートアップモード                           │
├─────────────────────────────────────────────────────────────────────┤
│  階層整合性 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  20%          │
│  摩擦度     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  30%  │
│  完全性     ━━━━━━━━━━━━━━━━━━━━━━━━━━━  10%                      │
│  速度       ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 40%│
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                      エンタープライズモード                           │
├─────────────────────────────────────────────────────────────────────┤
│  階層整合性 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 40%│
│  摩擦度     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  35%  │
│  完全性     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  20%              │
│  速度       ━━━━━━━━  5%                                            │
└─────────────────────────────────────────────────────────────────────┘
```