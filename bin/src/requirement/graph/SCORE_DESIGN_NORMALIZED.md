# 正規化されたスコア設計

## スコアリングフロー（整数ベース）

```
┌─────────┐        ┌──────────┐        ┌─────────┐        ┌──────────┐
│ Client  │        │   Main   │        │ Domain  │        │  Infra   │
│(Me/LLM) │        │ (App)    │        │ Layer   │        │  Layer   │
└────┬────┘        └────┬─────┘        └────┬────┘        └────┬─────┘
     │                   │                   │                   │
     │ Cypher Query      │                   │                   │
     ├──────────────────>│                   │                   │
     │                   │                   │                   │
     │                   ├─ 1. 違反検出     │                   │
     │                   ├───────────────────────────────────────>│
     │                   │                   │                   │
     │                   │                   │  ViolationCode  │
     │                   │<────────────────────────────────────────┤
     │                   │                   │  (整数コード)    │
     │                   │                   │                   │
     │                   ├─ 2. スコア計算   │                   │
     │                   ├──────────────────>│                   │
     │                   │                   │                   │
     │                   │                   ├─ BaseScore取得  │
     │                   │                   ├─ Phase係数適用  │
     │                   │                   ├─ Context係数適用│
     │                   │                   │                   │
     │                   │   Score: -85      │                   │
     │                   │<──────────────────┤  (整数値)       │
     │                   │                   │                   │
     │ Response          │                   │                   │
     │<──────────────────┤                   │                   │
     │ score: -85        │                   │                   │
     │ level: 2          │                   │                   │
     │                   │                   │                   │
```

## 違反コードと基本スコア（整数）

```
┌────────────────────────────────────────────────────────────────────────┐
│                        違反コード体系 (ViolationCode)                    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  コード   基本スコア   レベル   説明                                    │
│  ─────   ─────────   ─────   ─────────────────────────────────────   │
│   1001      -100       5     構造違反：階層スキップ                     │
│   1002      -100       5     構造違反：自己参照                       │
│   1003      -100       5     構造違反：循環参照                       │
│                                                                        │
│   2001       -30       3     整合性違反：タイトル不一致                │
│   2002       -50       4     整合性違反：必須項目欠落                 │
│                                                                        │
│   3001       -10       2     規約違反：命名規則                       │
│   3002       -20       2     規約違反：説明不足                       │
│                                                                        │
│   9000         0       1     違反なし                                │
└────────────────────────────────────────────────────────────────────────┘
```

## ビジネスフェーズ係数

```
フェーズ値    フェーズ名称        構造係数   摩擦係数   完全性係数   速度係数
─────────   ──────────────   ────────   ────────   ─────────   ────────
   0.2      初期探索期          0.5        0.3        0.2         2.0
   0.4      プロトタイプ期      0.7        0.5        0.4         1.5
   0.6      成長期              1.0        0.8        0.7         1.0
   0.8      安定期              1.2        1.0        0.9         0.7
   1.0      成熟期              1.5        1.2        1.0         0.5
```

## 摩擦要因の正規化

```
┌────────────────────────────────────────────────────────────────────────┐
│                          摩擦要因コード (FrictionCode)                   │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  要因ID   基本値   最大値   計算式                                      │
│  ─────   ─────   ─────   ─────────────────────────────────────────   │
│   F001     -20    -60    解釈複雑度 × -20 (最大3段階)                  │
│   F002     -30    -90    優先度競合数 × -30 (最大3件)                 │
│   F003     -10    -80    変更頻度 × -10 (最大8回)                    │
│   F004     -40   -100    矛盾検出数 × -40 (最大2.5件相当)            │
└────────────────────────────────────────────────────────────────────────┘

計算例：
F001(解釈複雑度2) = 2 × -20 = -40
F002(競合数3)     = 3 × -30 = -90
F003(変更頻度5)   = 5 × -10 = -50
─────────────────────────────────
摩擦合計                    = -180
```

## 総合スコア計算式

```
                  ┌─────────────────┐
                  │ 違反コード: 1001 │
                  │ 基本スコア: -100 │
                  └────────┬────────┘
                           │
                  ┌────────▼────────┐
                  │ フェーズ: 0.4   │
                  │ 構造係数: 0.7    │
                  └────────┬────────┘
                           │
                  ┌────────▼────────┐
                  │ 摩擦要因合計     │
                  │ F001: -40        │
                  │ F002: -30        │
                  └────────┬────────┘
                           │
         ┌─────────────────▼─────────────────────┐
         │           総合スコア計算                │
         │                                       │
         │  基本: -100                           │
         │  × フェーズ係数: 0.7 = -70           │
         │  ＋ 摩擦要因: -70                     │
         │  ─────────────────────────           │
         │  総合スコア: -140                     │
         │                                       │
         │  正規化（-100～0）: -100              │
         └───────────────────────────────────────┘
```

## コンテキスト係数

```
┌────────────────────────────────────────────────────────────────────────┐
│                        コンテキスト識別子 (ContextID)                    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ID    係数   条件                                                     │
│  ───   ───   ───────────────────────────────────────────────────────  │
│  C01   0.5   緊急対応（prefix: "hotfix_"）                             │
│  C02   0.3   セキュリティ対応（tag: "security_critical"）              │
│  C03   1.5   技術的負債（tag: "technical_debt"）                       │
│  C04   1.0   通常対応（デフォルト）                                     │
└────────────────────────────────────────────────────────────────────────┘
```

## スコアレベルマッピング（5段階）

```
スコア範囲      レベル   状態ID    アクション     表示色
──────────     ─────   ──────    ──────────    ─────
   0 ～  -20     1       S01      続行可能       緑
 -21 ～  -40     2       S02      注意喚起       黄
 -41 ～  -60     3       S03      修正推奨       橙
 -61 ～  -80     4       S04      修正必須       赤
 -81 ～ -100     5       S05      変更拒否       黒
```

## 健全性指標の計算

```
                カテゴリ別スコア（整数）
    ┌─────────────┬─────────────┬─────────────┬─────────────┐
    │ 構造: -20   │ 摩擦: -50   │ 完全性: -10 │ 負債: -30   │
    │ 重み: 30    │ 重み: 40    │ 重み: 20    │ 重み: 10    │
    └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┘
           │              │              │              │
           └──────────────┴──────────────┴──────────────┘
                                │
                    ┌───────────▼───────────┐
                    │     重み付き平均        │
                    │                       │
                    │ (-20×30 + -50×40 +    │
                    │  -10×20 + -30×10)     │
                    │ ─────────────────     │
                    │        100            │
                    │                       │
                    │     = -31             │
                    └───────────────────────┘
                                │
                    ┌───────────▼───────────┐
                    │   健全性レベル: 2      │
                    │   状態: S02（注意）    │
                    └───────────────────────┘
```