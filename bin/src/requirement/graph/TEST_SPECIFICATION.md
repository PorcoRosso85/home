# テスト仕様書

## 正式仕様テスト

`test_requirement_versioning.py` が要件管理システムの**正式な仕様定義**です。

### 設計原則

1. **イミュータブルエンティティ**
   - RequirementEntityは一度作成されたら変更不可
   - 更新は新しいエンティティの作成として実装

2. **完全な履歴保持**
   - 全ての過去バージョンが保持される
   - 削除された要件も履歴として残る

3. **LocationURIによる現在版管理**
   - LocationURIは常に最新バージョンを指す
   - 過去バージョンは直接アクセス可能

4. **完全な履歴追跡**
   - 全ての変更が追跡可能
   - タイムトラベルクエリをサポート

### テストカバレッジ

- **35個の包括的なテストケース**
- **16カテゴリの機能領域**
  - 基本的な履歴管理
  - エッジケース
  - 依存関係・階層構造
  - 検索・クエリ
  - 並行処理・競合
  - エラーケース
  - パフォーマンス
  - 統計・集計
  - 既存API互換性
  - メタデータ・追跡
  - 一括操作
  - グラフ特有操作
  - データ整合性
  - アクセス制御
  - インポート・エクスポート
  - 総合シナリオ

### 削除されたテスト

以下のテストは旧設計（ミュータブル＋スナップショット）に基づいており、削除されました：

- `test_version_service.py` - snapshot_idを期待していた
- その他、ミュータブル設計を前提としたテスト

### 修正されたテスト

- `test_jsonl_repository.py` - update()メソッドをsave()に変更
- `test_kuzu_repository.py` - スキーマをイミュータブル設計に更新

## 実装への要求

これらのテストが全てGREENになるために、実装は以下を満たす必要があります：

1. **save()メソッドの変更**
   - MERGEではなくCREATEを使用
   - 新しいversion_idを生成
   - LocationURIの更新

2. **find()メソッドの変更**
   - 最新バージョンを返すロジック
   - LocationURI経由でのアクセス

3. **get_requirement_history()の修正**
   - 実際の過去の状態を返す
   - 現在の状態を繰り返さない

4. **削除操作の実装**
   - エンティティは削除せず、DELETEオペレーションとして記録
   - 削除後も履歴アクセス可能

## 結論

「テストは仕様そのもの」の原則に従い、`test_requirement_versioning.py`のテストが全てパスすることが、システムの正しい実装の証明となります。