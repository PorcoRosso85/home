# スコアの安定性と実質価値の設計

## 問題：外部向けスコアと内部累積値の乖離

```
初期状態                3ヶ月後                 6ヶ月後
────────               ────────                ────────
表示: 85               表示: 72                表示: 58
内部: -15              内部: -28               内部: -42
状態: OK               状態: 要確認             状態: NG

「70以下はやり直し」ルールだと、途中で状態が変わってしまう
```

## 解決策：二層スコアシステム

### 1. 即時評価スコア（Immediate Score）と予測スコア（Projected Score）

```
┌─────────────────────────────────────────────────────────────────────┐
│                          スコア提示フォーマット                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  現在スコア: 85  [OK]                                               │
│  予測スコア: 68  [要注意] (3ヶ月後)                                 │
│                                                                     │
│  判定: 現在は基準を満たすが、3ヶ月以内に基準を下回る見込み            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2. スコア計算の時系列モデル

```
                    現在の要素                予測要素（重み付き）
    ┌──────────────────────────┐    ┌──────────────────────────┐
    │ 構造違反: 0              │    │ 技術的負債増加率: -2/月   │
    │ 摩擦度: -10              │    │ 複雑度増加率: -1/月      │
    │ 完全性: -5               │    │ チーム摩擦累積: -3/月     │
    └────────────┬─────────────┘    └────────────┬─────────────┘
                 │                                 │
                 └────────────┬────────────────────┘
                              │
                 ┌────────────▼────────────┐
                 │      スコア計算式         │
                 │                         │
                 │ 現在: 100 - 15 = 85     │
                 │ 3ヶ月: 85 - (6×3) = 67  │
                 │ 6ヶ月: 85 - (6×6) = 49  │
                 └─────────────────────────┘
```

## 実質価値を保つための設計

### 1. ベースライン固定方式

```
┌────────────────────────────────────────────────────────────────────┐
│                     ベースラインスコア（不変）                       │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  要件作成時のスコア: 85 (固定)                                      │
│  └─ 構造的健全性: 95                                               │
│  └─ 初期品質: 90                                                  │
│  └─ 設計意図: 85                                                  │
│                                                                    │
│  現在の状態スコア: 72 (変動)                                        │
│  └─ 累積摩擦: -8                                                  │
│  └─ 技術的負債: -5                                                │
│  └─ 時間劣化: -0                                                  │
│                                                                    │
│  判定: ベースライン85 > 70 なので、本質的にはOK                     │
│        ただし、現在状態72は要メンテナンス                           │
└────────────────────────────────────────────────────────────────────┘
```

### 2. 相対評価システム

```
プロジェクト全体の健全性コンテキスト
────────────────────────────────────
平均スコア: 65
標準偏差: 15

要件Aの評価:
絶対スコア: 72
相対スコア: +7（平均より上）
パーセンタイル: 73%

→ 「70以下はやり直し」でも、相対的には健全
```

## 推奨：ハイブリッドアプローチ

```
┌────────────────────────────────────────────────────────────────────┐
│                        統合スコアレポート                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  1. 即時判定（LLM向け）                                             │
│     スコア: 72/100                                                 │
│     判定: PASS（閾値70）                                           │
│                                                                    │
│  2. トレンド警告                                                   │
│     3ヶ月後予測: 66/100                                           │
│     判定: WARNING                                                  │
│     推奨: 予防的メンテナンス                                       │
│                                                                    │
│  3. 本質的価値                                                     │
│     設計品質: 85/100（不変）                                       │
│     実装状態: 72/100（変動）                                       │
│     判定: 設計は健全、実装要改善                                    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

## スコア変換テーブル（内部→外部）

```
内部累積値      外部表示      LLM判定        アクション
─────────      ────────      ─────        ──────────
  0 ～  -5        100          EXCELLENT     承認
 -6 ～ -15         85          GOOD          承認
-16 ～ -30         72          PASS          承認（要観察）
-31 ～ -45         58          WARNING       条件付き承認
-46 ～ -60         45          POOR          要修正
-61 ～ -100        20          FAIL          却下

※ 閾値70 = 内部値-30相当
```

## 実装例：スコアの安定性保証

```python
class StableScoreSystem:
    def calculate_score(self, requirement):
        # 1. ベースライン（不変）
        baseline = self._calculate_baseline(requirement.initial_state)
        
        # 2. 現在状態（変動）
        current = self._calculate_current(requirement.current_state)
        
        # 3. 予測値（トレンドベース）
        projected = self._project_future(current, requirement.history)
        
        return {
            "display_score": max(0, 100 + current),  # 0-100変換
            "baseline_score": baseline,
            "projected_score": projected,
            "decision": self._make_decision(baseline, current, projected),
            "confidence": self._calculate_confidence(requirement.history)
        }
    
    def _make_decision(self, baseline, current, projected):
        # ベースラインが閾値を超えていれば、本質的にOK
        if baseline >= 70:
            if current < 70:
                return "PASS_WITH_WARNING"
            return "PASS"
        return "FAIL"
```

この設計により、「70以下はやり直し」というシンプルなルールを維持しながら、システム内部の累積的な変化も適切に管理できます。