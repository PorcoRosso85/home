# テスト実行時間分析レポート

## 実行時間の概要
- **総テスト数**: 126個
- **総実行時間**: 約21分（1269.49秒）
- **平均実行時間**: 約10秒/テスト

## ボトルネック分析

### 1. VSS/FTS初期化のオーバーヘッド

#### 観察された事実
- SearchAdapterがVSSとFTSの両方を初期化
- 各テストでVECTOR拡張の読み込みが発生
- `create_vss()`と`create_fts()`の呼び出しコスト

#### 時間の内訳（推定）
```
VSS初期化:
- VECTOR拡張のインストール/ロード: 〜0.5秒
- Embeddingモデルの初期化: 〜2-3秒（初回）
- インデックス作成: データ量に依存

FTS初期化:
- FTS拡張の設定: 〜0.2秒
- インデックス作成: データ量に依存
```

### 2. E2Eテストの構造的問題

#### サブプロセス起動コスト
- 各E2Eテストがsubprocessでmain.pyを実行
- Pythonインタープリタの起動: 〜0.5秒/回
- モジュールのインポート: 〜0.5秒/回
- 合計オーバーヘッド: 〜1秒/テスト

#### データベース操作
- KuzuDB接続確立: 〜0.1秒
- スキーマ初期化: 〜0.2秒
- 実際のクエリ実行は高速

### 3. 予想との差異

**ユーザーの予想**: VSS機能テストが最も時間がかかる
**実際の状況**: 
- VSS初期化は確かに重い（2-3秒）
- しかし、主要因は「初期化の繰り返し」
- E2Eテストの数（43個）× 初期化コスト

### 4. 具体的な測定結果

高速テスト実行（slow/very_slowを除外）:
- 83個のテストを選択
- ドメインテスト: 瞬時に完了
- インフラテスト: 各〜0.1秒

### 5. 改善提案

#### 短期的改善
1. **開発時はE2Eテストをスキップ**
   ```bash
   nix run .#test -- -m "not e2e"
   ```

2. **VSS/FTS初期化の共有**
   - pytest fixtureでセッション単位の初期化
   - 現在は各テストで初期化している可能性

3. **並列実行の活用**
   ```bash
   nix run .#test -- -n auto
   ```

#### 中期的改善
1. **E2Eテストの削減**
   - 重複するシナリオの統合
   - 代表的なケースのみE2E化

2. **モック使用の検討**
   - VSS/FTS機能の一部をモック化
   - ただし、統合テストの価値は維持

3. **キャッシュの活用**
   - Embeddingモデルのキャッシュ
   - VECTOR拡張の事前ロード

## 結論

テスト実行時間の主要因は：
1. **E2Eテストの数と構造**（43個 × サブプロセス起動）
2. **VSS/FTS初期化の繰り返し**（テストごとに初期化）
3. **並列実行の未活用**

VSS自体の処理は想定通り重いが、それ以上に「繰り返し初期化」が問題。
開発効率のためには、E2Eテストの選択的実行が最も効果的。