# Requirement Graph Logic (RGL)

LLM専用の要件管理システム。階層ルールを強制し、フィードバックループで学習を促進。

## クイックスタート

```bash
# 開発環境の起動
nix develop

# テストの実行
nix run .#test

# アプリケーションの実行
nix run
```

## システム構成

```
┌─────────┐     ┌─────────┐     ┌──────────┐     ┌──────────┐     ┌────────────┐     ┌──────────┐     ┌─────────┐
│  User   │     │   LLM   │     │  System  │     │Hierarchy │     │  Query   │     │ Cypher  │     │ KuzuDB  │
│ユーザー │     │(Claude) │     │ (run.py) │     │Validator │     │Validator │     │Executor │     │グラフDB │
└────┬────┘     └────┬────┘     └────┬─────┘     └─────┬────┘     └────┬─────┘     └────┬────┘     └────┬────┘
     │               │               │                │                │               │              │
     │ 要件追加依頼  │               │                │                │               │              │
     ├──────────────>│               │                │                │               │              │
     │               │               │                │                │               │              │
     │               │ JSON生成      │                │                │               │              │
     │               ├──────────────>│                │                │               │              │
     │               │               │                │                │               │              │
     │               │               │ 階層チェック   │                │               │              │
     │               │               ├───────────────>│                │               │              │
     │               │               │                │                │               │              │
     ┌───────────────────────────────┴────────────────┴──────────────────────────────────────────────┐
     │ 階層違反の場合                                                                                  │
     │  ┌─────────────────────────────────────────────────────────────┐                              │
     │  │               │               │                │ 違反検出      │               │              │ │
     │  │               │               │<───────────────┤                │               │              │ │
     │  │               │               │                │                │               │              │ │
     │  │               │ エラー+提案  │                │                │               │              │ │
     │  │               │<──────────────┤                │                │               │              │ │
     │  │               │ (score:-1.0) │                │                │               │              │ │
     │  │               │               │                │                │               │              │ │
     │  │               │ 学習         │                │                │               │              │ │
     │  │               │ ↓            │                │                │               │              │ │
     │  │               │ 修正再試行   │                │                │               │              │ │
     │  │               ├──────────────>│                │                │               │              │ │
     │  └─────────────────────────────────────────────────────────────┘                              │
     └────────────────────────────────────────────────────────────────────────────────────────────────┘
     │               │               │                │                │               │              │
     ┌───────────────────────────────┴────────────────┴──────────────────────────────────────────────┐
     │ 正常な場合                                                                                      │
     │  ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │
     │  │               │               │                │ 検証OK         │               │              │ │ │
     │  │               │               │<───────────────┤                │               │              │ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │               │               │ Cypherチェック │                │               │              │ │ │
     │  │               │               ├────────────────────────────────>│               │              │ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │               │               │                │                │ クエリ安全    │              │ │ │
     │  │               │               │<────────────────────────────────┤               │              │ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │               │               │ 実行依頼       │                │               │              │ │ │
     │  │               │               ├─────────────────────────────────────────────────>│              │ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │               │               │                │                │               │ Cypher実行   │ │ │
     │  │               │               │                │                │               ├─────────────>│ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │               │               │                │                │               │ 結果         │ │ │
     │  │               │               │                │                │               │<─────────────┤ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │               │               │ クエリ結果     │                │               │              │ │ │
     │  │               │               │<─────────────────────────────────────────────────┤              │ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │               │ 応答+提案    │                │                │               │              │ │ │
     │  │               │<──────────────┤                │                │               │              │ │ │
     │  │               │ (score:0.0)  │                │                │               │              │ │ │
     │  │               │               │                │                │               │              │ │ │
     │  │ 整形済み応答 │               │                │                │               │              │ │ │
     │  │<──────────────┤               │                │                │               │              │ │ │
     │  └──────────────────────────────────────────────────────────────────────────────────────────┘  │
     └────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## 使い方

```bash
echo '{"type": "cypher", "query": "CREATE ..."}' | \
  LD_LIBRARY_PATH=/nix/store/l7d6vwajpfvgsd3j4cr25imd1mzb7d1d-gcc-14.3.0-lib/lib/ \
  RGL_DB_PATH=./rgl_db \
  python run.py
```

## 階層ルール

- Level 0: ビジョン
- Level 1: アーキテクチャ  
- Level 2: モジュール
- Level 3: コンポーネント
- Level 4: タスク

**親は必ず子より上位階層**

## スコアリング

要件の整合性に関する違反のみスコアを返します：

| 違反種別 | スコア | 説明 |
|---------|--------|------|
| 階層違反 | -1.0 | 下位が上位に依存 |
| 自己参照 | -1.0 | ノードが自身に依存 |
| 循環参照 | -1.0 | A→B→C→A |
| タイトル不整合 | -0.3 | タイトルと階層レベルの不一致 |

システムエラー（JSONエラー、環境設定エラー等）にはスコアを付与しません。