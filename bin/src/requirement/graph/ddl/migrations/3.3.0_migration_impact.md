# 3.3.0 簡素化マイグレーション影響分析

## 影響を受けるクエリテンプレート

### 1. priority プロパティを使用（6ファイル）

#### DMLクエリ（データ操作）
- `create_versioned_requirement.cypher`
  - 行10, 17: RequirementEntityのpriority設定
  - **対応**: パラメータから削除、デフォルト値設定を削除
  
- `update_versioned_requirement.cypher`  
  - 行17: SET句でのpriority更新
  - **対応**: SET句から削除
  
- `mark_as_deleted.cypher`
  - 行17: RETURNでpriority選択
  - **対応**: RETURN句から削除

#### DQLクエリ（データ照会）
- `get_requirement_history.cypher`
  - 行16: RETURNでpriority選択
  - **対応**: RETURN句から削除
  
- `get_requirement_history_v2.cypher`
  - 行48: WITH句でpriority選択
  - **対応**: WITH句から削除
  
- `get_version_diff.cypher`
  - 行35, 46: 差分比較でpriority参照
  - **対応**: 差分比較から削除

### 2. previous_state プロパティを使用（2ファイル）

- `get_requirement_history.cypher`
  - 行22: RETURNでprevious_state選択
  - **対応**: RETURN句から削除
  
- `get_requirement_history_v2.cypher`
  - 行21, 27, 36: コメントと条件でprevious_state参照
  - **対応**: ロジックの見直しが必要

## 影響を受けるアプリケーションコード

### 1. kuzu_repository.py
- priorityパラメータを受け取る箇所
- progress_percentageを使用する箇所

### 2. version_service.py  
- priorityを含むデータ構造
- previous_stateを期待する処理

### 3. テストファイル
- priorityを設定するテストケース
- previous_stateを検証するアサーション

## マイグレーション実行手順

1. **バックアップ**
   ```bash
   # 本番データのバックアップ
   cp /path/to/production.db /path/to/production_v3.2.0_backup.db
   ```

2. **クエリテンプレート更新**
   - 上記6ファイルのpriorityを削除
   - 上記2ファイルのprevious_stateを削除

3. **アプリケーションコード更新**
   - リポジトリ層の修正
   - サービス層の修正
   - テストの修正

4. **マイグレーション実行**
   ```cypher
   // 3.3.0_radical_simplification.cypherを実行
   ```

5. **動作確認**
   - 全テストの実行
   - 基本的なCRUD操作の確認

## ロールバック手順

問題が発生した場合:
1. バックアップからリストア
2. コードを3.2.0にリバート
3. 問題の原因を調査後、再度マイグレーション計画