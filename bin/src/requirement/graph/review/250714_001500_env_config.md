# 環境変数による設定管理議論 - 2025/07/14 00:15:00

## 議論参加者
- ユーザー（システム設計者）
- Claude（システム分析・提案）

## 議論の要点

### 要求事項
1. **外部ファイル禁止** - 設定ファイルは使わない
2. **デフォルト設定禁止** - 明示的な設定を強制
3. **必須エラー** - 環境変数がない場合は起動エラー
4. **構造化データ** - オブジェクトや配列を環境変数で表現

### 提案された形式

#### Option 1: JSON文字列
```bash
RGL_SIMILARITY_RULES='[{"threshold":0.95,"action":"reject"},{"threshold":0.75,"action":"pending"}]'
```
- ✅ 最も柔軟で表現力豊か
- ❌ エスケープが複雑
- ❌ 手入力でのミスが多い

#### Option 2: セミコロン区切りタプル ✅推奨
```bash
RGL_SIMILARITY_RULES="0.95:reject:重複のため拒否;0.75:pending:要確認;0:pending"
```
- ✅ 読みやすく、書きやすい
- ✅ エスケープ不要
- ✅ 拡張可能（フィールド追加が容易）

#### Option 3: パイプ区切り並列配列
```bash
RGL_SIMILARITY_THRESHOLDS="0.95|0.75|0"
RGL_SIMILARITY_ACTIONS="reject|pending_warn|pending"
```
- ✅ シンプル
- ❌ 配列間の対応関係が暗黙的
- ❌ 長さの不一致エラーが発生しやすい

#### Option 4: インデックス付き個別変数
```bash
RGL_SIMILARITY_RULE_0="0.95:reject"
RGL_SIMILARITY_RULE_1="0.75:pending_warn"
```
- ✅ 最も原始的で確実
- ❌ 管理が煩雑
- ❌ 個数の事前把握が困難

### 厳格なエラーハンドリング

```python
def validate_environment():
    rules = os.getenv('RGL_SIMILARITY_RULES')
    if not rules:
        raise EnvironmentError(
            "RGL_SIMILARITY_RULES is required. "
            "Format: '0.95:reject:message;0.75:pending'"
        )
    
    # パース検証
    try:
        parsed_rules = parse_similarity_rules(rules)
        validate_rules_logic(parsed_rules)
    except ValueError as e:
        raise EnvironmentError(f"Invalid RGL_SIMILARITY_RULES: {e}")
```

### 合意事項
- **推奨形式**: Option 2（セミコロン区切りタプル）
- **必須化**: 環境変数なしでの起動を禁止
- **検証**: 起動時の厳格なバリデーション

---
記録者: Claude
記録日時: 2025/07/14 00:15:00