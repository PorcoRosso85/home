# ステージ管理システム設計議論 - 2025/07/14 00:00:00

## 議論参加者
- ユーザー（システム設計者）
- Claude（システム分析・提案）

## 議論の背景
重複検出時のユーザージャーニーと要件ライフサイクル管理について、より良い設計を検討。

## 主要な議論ポイント

### 1. ステージ管理の必要性

#### 現状の問題
- 重複検出しても警告のみで要件は作成される
- 重複要件の事後処理が不明確
- 要件の状態管理が曖昧

#### 提案された解決策
3ステージによるライフサイクル管理:
- `pending` - 検証中・保留
- `active` - 開発対象として有効
- `rejected` - 競合により不採用

### 2. ステージ名の進化過程

#### 初期案
```
proposed → merge_candidate → active → deleted
```

#### 議論による改良
```
proposed → active → merged → superseded
```

#### 生物学的メタファー案
```
pending → alive → dead
```

#### 最終決定
```
pending → active → rejected
```

理由: 
- `active`は技術用語として適切
- `merged`状態は不要（統合=物理削除）
- シンプルな3状態で必要十分

### 3. データモデリングの選択

#### Option A: プロパティアプローチ
```cypher
RequirementEntity {
  id: "req_001",
  stage: "pending"  // ENUMプロパティ
}
```

#### Option B: ノード + リレーション ✅採用
```cypher
(r:RequirementEntity)-[:HAS_LIFECYCLE_STAGE]->(s:RequirementLifecycleStage {
  stage: "pending",
  display_name: "検証中"
})
```

選択理由:
- ステージのメタデータを独立管理
- グラフ構造として自然な表現
- 将来の拡張性

### 4. 命名の具体性

#### 却下された汎用名
- `State` - 汎用的すぎる
- `Stage` - 何のステージか不明

#### 採用された具体名
- `RequirementLifecycleStage` - 要件のライフサイクルステージ
- `HAS_LIFECYCLE_STAGE` - リレーション名

### 5. 環境変数による柔軟な制御

#### 従来案（review/250713_201459.md）
- 固定の閾値で自動拒否/統合
- インタラクティブ性の排除

#### 新提案
```bash
# 段階的な閾値設定
RGL_SIMILARITY_THRESHOLDS=0.95,0.75,0

# 各閾値の動作設定
RGL_SIMILARITY_ACTIONS=reject,pending_warn,pending
```

#### 理想的な拡張案
```json
// similarity_config.json
{
  "rules": [
    {"threshold": 0.95, "action": "reject", "message": "重複のため作成拒否"},
    {"threshold": 0.75, "action": "pending", "warning": true},
    {"threshold": 0, "action": "pending"}
  ]
}
```

### 6. 統合処理の方針

#### 議論のポイント
- プロセス履歴を残すか？ → **残さない**
- 統合フラグは必要か？ → **不要**
- 統合 = データ統合（物理削除）

### 7. 最終的なテンプレート設計

#### DDL
- `ddl/initialize_lifecycle_stages.cypher`

#### DML
- `dml/create_requirement_with_stage.cypher`
- `dml/update_lifecycle_stage.cypher`
- `dml/merge_and_delete_requirement.cypher`

#### DQL
- `dql/list_requirements_by_stage.cypher`
- `dql/get_requirement_with_stage.cypher`

## 設計思想の対比

### A案: 予防的アプローチ（review/250713）
- 作成前に判断
- 重複は作成させない
- 完全自動化

### B案: 事後的アプローチ（本議論）
- 一旦作成（pending）
- 人間が判断
- 透明性重視

### ハイブリッド案（環境変数制御）
- 高類似度(>0.95) → 即座拒否
- 中類似度(0.75-0.95) → pending + 警告
- 低類似度(<0.75) → pending

## 合意事項

1. **ステージ管理**: pending/active/rejected の3状態
2. **データモデル**: RequirementLifecycleStage ノード方式
3. **統合処理**: 物理削除（履歴なし）
4. **環境変数制御**: 閾値と動作の柔軟な設定
5. **命名規則**: 具体的で明確な名前を使用

## 未解決の課題

1. **バッチ処理 vs リアルタイム**: pending要件の処理タイミング
2. **権限管理**: 誰がステージ変更できるか
3. **通知機能**: pending要件の滞留アラート

## 次のアクション

1. 環境変数による段階的制御の詳細設計
2. ステージ管理テンプレートの実装
3. 既存システムとの統合方法の検討

---
記録者: Claude
記録日時: 2025/07/14 00:00:00
議論時間: 約2時間