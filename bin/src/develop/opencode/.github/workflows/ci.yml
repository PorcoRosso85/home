name: OpenCode CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run full integration tests daily at 02:00 UTC
    - cron: '0 2 * * *'

env:
  # Detect test mode: mock for PR/push, server for scheduled
  CI_TEST_MODE: ${{ github.event_name == 'schedule' && 'server' || 'mock' }}

jobs:
  quick-tests:
    name: Quick Tests (Mock Mode)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    steps:
    - uses: actions/checkout@v4

    - uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: ğŸ” Verify Environment
      run: |
        echo "ğŸ¯ Test Mode: $CI_TEST_MODE"
        echo "ğŸ“… Event: ${{ github.event_name }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"

    - name: âš¡ Quick Build Verification
      run: |
        echo "ğŸš€ Building core components..."
        nix build .#opencode-client
        echo "âœ… opencode-client build successful"

    - name: ğŸ”’ Lock Integrity Check
      run: |
        if [ ! -f flake.lock ]; then
          echo "âŒ flake.lock is missing - required for reproducibility"
          exit 1
        fi
        echo "âœ… flake.lock exists"

        # Check if lock was modified (detect unintended changes)
        expected_rev="8eaee110344796db060382e15d3af0a9fc396e0e"
        actual_rev=$(jq -r '.nodes.nixpkgs.locked.rev' flake.lock)
        if [ "$actual_rev" != "$expected_rev" ]; then
          echo "âš ï¸ flake.lock nixpkgs revision changed:"
          echo "   Expected: $expected_rev"
          echo "   Actual:   $actual_rev"
          echo "   This may be intentional (nix flake update) or unintended"
          echo "   Please verify this change was intended"
        else
          echo "âœ… flake.lock nixpkgs revision matches expected"
        fi

    - name: ğŸ—ï¸ Flake Syntax Verification
      run: nix flake check

    - name: ğŸ¯ Quick Feature Validation
      run: |
        echo "ğŸ§ª Running quick validation suite..."
        export CI_TEST_MODE=mock
        export OPENCODE_TIMEOUT=10

        # Run comprehensive quick validation (no external dependencies)
        if ./test_ci_quick_validation.sh; then
          echo "âœ… Quick validation tests passed"
        else
          echo "âŒ Quick validation tests failed"
          exit 1
        fi

    - name: ğŸ“Š Quick Test Summary
      run: |
        echo "ğŸ‰ Quick Test Summary"
        echo "===================="
        echo "âœ… Build verification: PASSED"
        echo "âœ… Lock integrity: PASSED"
        echo "âœ… Flake syntax: PASSED"
        echo "âœ… Quick validation: PASSED"
        echo "âœ… Acceptance criteria: VALIDATED"
        echo ""
        echo "âš¡ Total time: ~30-60 seconds"
        echo "ğŸ¯ Performance target: Sub-2-minute CI"

  comprehensive-tests:
    name: Comprehensive Tests (Server Mode)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
    - uses: actions/checkout@v4

    - uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: ğŸ” Verify Environment
      run: |
        echo "ğŸ¯ Test Mode: $CI_TEST_MODE"
        echo "ğŸ“… Event: ${{ github.event_name }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"

    - name: ğŸš€ Full Build Verification
      run: |
        echo "ğŸ—ï¸ Building all components..."
        nix build .#opencode-client
        echo "âœ… opencode-client build successful"

        # Verify opencode serve is available
        if ! nix develop --command opencode --help | grep -i serve; then
          echo "âŒ opencode serve command not available"
          exit 1
        fi
        echo "âœ… opencode serve command available"

    - name: ğŸ”’ Comprehensive Lock Verification
      run: |
        echo "ğŸ” Running comprehensive lock reproducibility tests..."
        if ./test_reproducibility_suite.sh; then
          echo "âœ… Reproducibility suite passed"
        else
          echo "âŒ Reproducibility suite failed"
          exit 1
        fi

    - name: â±ï¸ Timeout Behavior Verification
      run: |
        echo "â±ï¸ Testing timeout behavior..."
        export OPENCODE_TIMEOUT=5
        if ./test_timeout_behavior.sh; then
          echo "âœ… Timeout behavior tests passed"
        else
          echo "âŒ Timeout behavior tests failed"
          exit 1
        fi

    - name: ğŸ¯ Complete Integration Tests
      run: |
        echo "ğŸ§ª Running complete integration test suite..."
        export CI_TEST_MODE=server
        export OPENCODE_TIMEOUT=30

        if ./test_complete_integration.sh; then
          echo "âœ… Complete integration tests passed"
        else
          echo "âŒ Complete integration tests failed"
          exit 1
        fi

    - name: ğŸš€ Quick Start Validation
      run: |
        echo "ğŸš€ Running quick start validation..."
        # This test requires a real server, so we'll run it in a background job
        (nix develop --command opencode serve --port 4096 &)
        sleep 10  # Give server time to start

        export OPENCODE_URL="http://127.0.0.1:4096"
        export OPENCODE_PROJECT_DIR="$(pwd)"

        if ./quick-start-test.sh; then
          echo "âœ… Quick start validation passed"
        else
          echo "âŒ Quick start validation failed"
          exit 1
        fi

    - name: ğŸ“Š Comprehensive Test Summary
      run: |
        echo "ğŸ‰ Comprehensive Test Summary"
        echo "============================="
        echo "âœ… Full build verification: PASSED"
        echo "âœ… Lock reproducibility: PASSED"
        echo "âœ… Timeout behavior: PASSED"
        echo "âœ… Integration tests: PASSED"
        echo "âœ… Quick start validation: PASSED"
        echo ""
        echo "â±ï¸ Total time: ~3-5 minutes"