#!/usr/bin/env bash
# Transport Module - 実行可能コマンド集

# === 基本操作 ===

# セッション一覧
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from application import MultiSessionOrchestrator
orchestrator = MultiSessionOrchestrator()
result = orchestrator.discover_active_sessions()
print(f'Active sessions: {result[\"sessions\"]}')
"

# セッション作成（番号指定）
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from application import SingleSessionController
controller = SingleSessionController(1)
result = controller.start_new_session()
print(f'Session 1: {\"Created\" if result[\"success\"] else \"Failed\"} - {result.get(\"error\", \"\")}')
"

# セッション確認
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from application import SingleSessionController
controller = SingleSessionController(1)
status = controller.get_status()
print(f'Session 1: State={status[\"state\"]}, Session={status[\"has_session\"]}')
"

# === 高度な使用例 ===

# 複数セッション同時作成
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from infrastructure import create_session
from pathlib import Path
for i in [1, 2, 3]:
    work_dir = Path(f'/home/nixos/bin/src/poc/realtime-claudecode/{i:02d}')
    work_dir.mkdir(parents=True, exist_ok=True)
    session = create_session(work_dir)
    print(f'Session {i}: {"Created" if session else "Failed"}')
"

# プロセス検出（デバッグ用）
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from infrastructure import find_existing_claude_process
from pathlib import Path
for i in range(1, 6):
    work_dir = Path(f'/home/nixos/bin/src/poc/realtime-claudecode/{i:02d}')
    pid = find_existing_claude_process(work_dir)
    if pid:
        print(f'Session {i}: PID {pid}')
    else:
        print(f'Session {i}: Not running')
"

# コマンド送信（セッションへのコマンド実行）
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from infrastructure import send_command
from pathlib import Path
work_dir = Path('/home/nixos/bin/src/poc/realtime-claudecode/01')
result = send_command(work_dir, 'pwd')
print('Command sent' if result else 'Failed')
"

# セッション状態詳細（application層使用）
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from application import SingleSessionController
controller = SingleSessionController(1)
status = controller.get_status()
print(f'Session 1 status: {status}')
"

# 全セッション発見（orchestrator使用）
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "
from application import MultiSessionOrchestrator
orchestrator = MultiSessionOrchestrator()
discovered = orchestrator.discover_active_sessions()
print(f'Active sessions: {discovered}')
"


# === トラブルシューティング ===

# Python pathの確認
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "import sys; print(sys.path)"

# pexpectバージョン確認
nix shell --impure --expr '(import <nixpkgs> {}).python312.withPackages (ps: [ps.pexpect])' \
  -c python3 -c "import pexpect; print(f'pexpect version: {pexpect.__version__}')"

# === 注意事項 ===
# withPackagesを使用することで、Pythonインタープリタ自体が
# pexpect込みで再構築されるため、モジュールが正しく認識される