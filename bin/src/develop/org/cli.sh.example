#!/usr/bin/env bash
# tmux-based Multi-Agent Orchestration System
# Command examples using application.py functions

# === Core Operations ===

# 1. Start Worker - Start Claude Code with duplicate check
nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import start_worker_in_directory
result = start_worker_in_directory('/path/to/project-a')
if result['ok']:
    print(f\"Started worker {result['data']['pane_id']} for {result['data']['directory']}\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# 2. Send Command - Send command to specific worker
nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import send_command_to_worker_by_directory
result = send_command_to_worker_by_directory('/path/to/project-a', 'Fix the bug in main.py')
if result['ok']:
    print('Command sent successfully')
else:
    print(f\"Error: {result['error']['message']}\")
"

# 3. Check Status - Show all workers status
nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import get_all_workers_status
result = get_all_workers_status()
if result['ok']:
    for worker in result['data']['workers']:
        print(f\"Pane {worker['pane_id']}: {worker['directory']} ({worker['status']})\")
    print(f\"Total: {result['data']['total']} workers\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# 4. Clean Dead Workers - Remove dead workers from state
nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import clean_dead_workers_from_state
result = clean_dead_workers_from_state()
if result['ok']:
    print(f\"Cleaned {result['data']['removed']} dead workers\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# === Usage with Parameters ===

# Start worker for specific project
PROJECT="/home/user/my-project"
nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import start_worker_in_directory
result = start_worker_in_directory('$PROJECT')
if result['ok']:
    print(f\"Started worker {result['data']['pane_id']} for $PROJECT\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# Send command with variable
PROJECT="/home/user/my-project"
COMMAND="npm test"
nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import send_command_to_worker_by_directory
result = send_command_to_worker_by_directory('$PROJECT', '$COMMAND')
if result['ok']:
    print('Command sent successfully')
else:
    print(f\"Error: {result['error']['message']}\")
"

# === Batch Operations ===

# Start multiple workers
nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import start_worker_in_directory

projects = [
    '/home/user/frontend',
    '/home/user/backend',
    '/home/user/docs'
]

for project in projects:
    result = start_worker_in_directory(project)
    if result['ok']:
        print(f\"Started: {project}\")
    else:
        print(f\"Failed: {project} - {result['error']['message']}\")
"

# === Direct tmux Operations (Manual) ===

# Attach to session for manual inspection
tmux attach-session -t org-system
# Use Ctrl-b d to detach

# List all panes (debug)
tmux list-panes -a -F "#{pane_id} #{session_name}:#{window_name} #{pane_current_path}"

# Kill session and clean up
tmux kill-session -t org-system
rm ~/.org-state.json

# === Shell Function Helpers (Optional) ===

# Add these to your .bashrc for convenience (NOT required)
start_worker() {
    local project="${1:-$(pwd)}"
    nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import start_worker_in_directory
result = start_worker_in_directory('$project')
if result['ok']:
    print(f\"Started worker {result['data']['pane_id']} for $project\")
else:
    print(f\"Error: {result['error']['message']}\")
"
}

send_command() {
    local project="${1:-$(pwd)}"
    local command="$2"
    nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import send_command_to_worker_by_directory
result = send_command_to_worker_by_directory('$project', '$command')
if result['ok']:
    print('Command sent successfully')
else:
    print(f\"Error: {result['error']['message']}\")
"
}

show_status() {
    nix shell nixpkgs#python312Packages.libtmux --command python3 -c "
from application import get_all_workers_status
result = get_all_workers_status()
if result['ok']:
    for worker in result['data']['workers']:
        print(f\"Pane {worker['pane_id']}: {worker['directory']} ({worker['status']})\")
    print(f\"Total: {result['data']['total']} workers\")
else:
    print(f\"Error: {result['error']['message']}\")
"
}

# Usage:
# start_worker /path/to/project
# send_command /path/to/project "test command"
# show_status