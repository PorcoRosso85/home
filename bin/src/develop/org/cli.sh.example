#!/usr/bin/env bash
# tmux-based Multi-Agent Orchestration System
# Command examples using application.py functions

# === Complete Workflow: Find and Query Existing Projects ===

# Step 1: Find projects with specific patterns (using shell tools)
find ~/bin/src -name "flake.nix" -type f | head -5
# Output: Lists flake.nix files in the repository

# Step 2: Check if project has Claude history
PROJECT="${1:-$(pwd)}"  # Use argument or current directory
nix develop -c python3 -c "
from application import check_worker_has_history
result = check_worker_has_history('$PROJECT')
if result['ok']:
    data = result['data']
    print(f'History exists: {data[\"has_history\"]}')
    if data['has_history']:
        print(f'Found {data[\"file_count\"]} conversation files')
"

# Step 3: Start or reuse worker (with smart handling)
nix develop -c python3 -c "
from application import start_worker_in_directory, get_all_workers_status

# Check if worker already exists
status = get_all_workers_status()
worker_exists = False
if status['ok']:
    for w in status['data']['workers']:
        if w['directory'] == '$PROJECT':
            worker_exists = True
            print(f'Worker already {w[\"status\"]} for {w[\"directory\"]}')
            break

# Start if needed
if not worker_exists:
    result = start_worker_in_directory('$PROJECT')
    if result['ok']:
        print(f'Started new worker in pane {result[\"data\"][\"pane_id\"]}')
"

# Step 4: Send query
nix develop -c python3 -c "
from application import send_command_to_worker_by_directory
result = send_command_to_worker_by_directory(
    '$PROJECT',
    'What is the current state of this project?'
)
print('Query sent successfully' if result['ok'] else f'Error: {result[\"error\"]}')
"

# Step 5: Retrieve response (after waiting for Claude to respond)
sleep 10
nix develop -c python3 -c "
from application import get_claude_history
result = get_claude_history('$PROJECT', last_n=2)
if result['ok']:
    for msg in result['data']['messages']:
        if msg.get('role') == 'assistant':
            content = msg.get('content', '')
            print(content[:500] + '...' if len(content) > 500 else content)
"

# === Core Operations ===

# 1. Start Worker - Start Claude Code with duplicate check
nix develop -c python3 -c "
from application import start_worker_in_directory
result = start_worker_in_directory('/path/to/project')
if result['ok']:
    print(f\"Started worker {result['data']['pane_id']} for {result['data']['directory']}\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# 2. Send Command - Send command to specific worker
nix develop -c python3 -c "
from application import send_command_to_worker_by_directory
result = send_command_to_worker_by_directory('/path/to/project', 'Fix the bug in main.py')
if result['ok']:
    print('Command sent successfully')
else:
    print(f\"Error: {result['error']['message']}\")
"

# 3. Check Status - Show all workers status
nix develop -c python3 -c "
from application import get_all_workers_status
result = get_all_workers_status()
if result['ok']:
    for worker in result['data']['workers']:
        print(f\"Pane {worker['pane_id']}: {worker['directory']} ({worker['status']})\")
    print(f\"Total: {result['data']['total']} workers\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# 4. Clean Dead Workers - Remove dead workers from state
nix develop -c python3 -c "
from application import clean_dead_workers_from_state
result = clean_dead_workers_from_state()
if result['ok']:
    print(f\"Cleaned {result['data']['removed']} dead workers\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# === Usage with Parameters ===

# Start worker for specific project
PROJECT="${1:-/path/to/project}"
nix develop -c python3 -c "
from application import start_worker_in_directory
result = start_worker_in_directory('$PROJECT')
if result['ok']:
    print(f\"Started worker {result['data']['pane_id']} for $PROJECT\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# Send command with variable
PROJECT="${1:-/path/to/project}"
COMMAND="npm test"
nix develop -c python3 -c "
from application import send_command_to_worker_by_directory
result = send_command_to_worker_by_directory('$PROJECT', '$COMMAND')
if result['ok']:
    print('Command sent successfully')
else:
    print(f\"Error: {result['error']['message']}\")
"

# === Robust Worker Management (Handle Duplicate/Dead Workers) ===

nix develop -c python3 -c "
from application import (
    start_worker_in_directory,
    get_all_workers_status,
    clean_dead_workers_from_state
)
import time

def ensure_worker(directory):
    '''Ensure a worker is running for the directory'''
    
    # Try to start
    result = start_worker_in_directory(directory)
    if result['ok']:
        return f'Started new worker in {directory}'
    
    # If duplicate error, check if really alive
    if 'duplicate' in str(result.get('error', '')):
        status = get_all_workers_status()
        for w in status['data']['workers']:
            if w['directory'] == directory:
                if w['status'] == 'alive':
                    return f'Worker already running and alive'
                else:
                    # Dead worker, clean and retry
                    clean_dead_workers_from_state()
                    time.sleep(1)
                    retry = start_worker_in_directory(directory)
                    if retry['ok']:
                        return f'Restarted worker after cleanup'
    
    return f'Could not start worker: {result}'

# Use it
message = ensure_worker('${1:-/path/to/project}')
print(message)
"

# === Batch Operations ===

# Start multiple workers
nix develop -c python3 -c "
from application import start_worker_in_directory

projects = [
    '/path/to/project1',
    '/path/to/project2',
    '/path/to/project3'
]

for project in projects:
    result = start_worker_in_directory(project)
    if result['ok']:
        print(f\"Started: {project}\")
    else:
        print(f\"Failed: {project} - {result['error']['message']}\")
"

# === History and Verification ===

# 5. Check if worker has history (verification)
nix develop -c python3 -c "
from application import check_worker_has_history
result = check_worker_has_history('/path/to/project')
if result['ok']:
    print(f\"Has history: {result['data']['has_history']}\")
    print(f\"Message: {result['data']['message']}\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# 6. Get Claude conversation history (search feature)
nix develop -c python3 -c "
from application import get_claude_history
result = get_claude_history('/path/to/project', last_n=10)
if result['ok']:
    print(f\"Total messages: {result['data']['total_messages']}\")
    print(f\"Showing last {result['data']['showing']} messages\")
    # Display last 3 messages
    for msg in result['data']['messages'][-3:]:
        if 'content' in msg and isinstance(msg['content'], str):
            role = msg.get('role', 'unknown')
            content = msg['content'][:100] + '...' if len(msg['content']) > 100 else msg['content']
            print(f\"{role}: {content}\")
else:
    print(f\"Error: {result['error']['message']}\")
"

# === Direct tmux Operations (Manual) ===

# Attach to session for manual inspection
tmux attach-session -t org-system
# Use Ctrl-b d to detach

# List all panes (debug)
tmux list-panes -a -F "#{pane_id} #{session_name}:#{window_name} #{pane_current_path}"

# Kill session and clean up
tmux kill-session -t org-system

# === Shell Function Helpers (Optional) ===

# Add these to your .bashrc for convenience (NOT required)
start_worker() {
    local project="${1:-$(pwd)}"
    nix develop -c python3 -c "
from application import start_worker_in_directory
result = start_worker_in_directory('$project')
if result['ok']:
    print(f\"Started worker {result['data']['pane_id']} for $project\")
else:
    print(f\"Error: {result['error']['message']}\")
"
}

send_command() {
    local project="${1:-$(pwd)}"
    local command="$2"
    nix develop -c python3 -c "
from application import send_command_to_worker_by_directory
result = send_command_to_worker_by_directory('$project', '$command')
if result['ok']:
    print('Command sent successfully')
else:
    print(f\"Error: {result['error']['message']}\")
"
}

show_status() {
    nix develop -c python3 -c "
from application import get_all_workers_status
result = get_all_workers_status()
if result['ok']:
    for worker in result['data']['workers']:
        print(f\"Pane {worker['pane_id']}: {worker['directory']} ({worker['status']})\")
    print(f\"Total: {result['data']['total']} workers\")
else:
    print(f\"Error: {result['error']['message']}\")
"
}

# Usage:
# start_worker [project_path]
# send_command [project_path] [command]
# show_status