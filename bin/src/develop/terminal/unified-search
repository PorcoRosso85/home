#!/usr/bin/env -S nix shell nixpkgs#fzf nixpkgs#fd nixpkgs#ripgrep nixpkgs#bat --command bash

# unified-search - Unified search for files, keybindings, and functions with bat preview
#
# Usage: unified-search
# Keybinding: Ctrl+F

{
  # Files (limit depth for performance)
  fd --type f --max-depth 3 . 2>/dev/null | sed 's/^/file: /'
  
  # Bash keybindings
  bind -X 2>/dev/null | grep -v '^$' | sed 's/^/bind: /'
  bind -p 2>/dev/null | grep '^"' | sed 's/^/bind: /'
  
  # Bash functions
  declare -F 2>/dev/null | awk '{print $3}' | sed 's/^/func: /'
} | fzf \
  --height=80% \
  --preview='
    case {} in
      file:*) 
        f=$(echo {} | sed "s/^file: //")
        if [ -f "$f" ]; then
          bat --color=always --style=numbers --line-range=:500 "$f" 2>/dev/null || cat "$f"
        fi
        ;;
      bind:*) 
        echo {} | sed "s/^bind: //" | bat --color=always --language=bash --style=plain 2>/dev/null || echo {}
        ;;
      func:*) 
        fname=$(echo {} | sed "s/^func: //")
        declare -f "$fname" 2>/dev/null | bat --color=always --language=bash --style=numbers 2>/dev/null || declare -f "$fname"
        ;;
    esac
  ' \
  --preview-window=right:60% \
  --prompt="Search (file/bind/func)> " \
  --bind='enter:execute(
    case {} in
      file:*) 
        f=$(echo {} | sed "s/^file: //")
        bat --paging=always "$f" 2>/dev/null || less "$f"
        ;;
      func:*) 
        fname=$(echo {} | sed "s/^func: //")
        declare -f "$fname" | bat --paging=always --language=bash 2>/dev/null || declare -f "$fname" | less
        ;;
      bind:*) 
        echo {}
        ;;
    esac
  )'