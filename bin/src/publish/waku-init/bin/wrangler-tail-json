#!/usr/bin/env bash
#
# wrangler-tail-json - Stream JSON logs from deployed Cloudflare Workers
# 
# Single Responsibility: Capture wrangler tail output as clean JSON
# 
# Usage:
#   wrangler-tail-json <worker-name> [timeout]
#   
# Examples:
#   wrangler-tail-json my-worker        # Capture one event
#   wrangler-tail-json my-worker 10     # Capture for 10 seconds
#   
# Output:
#   Clean JSON to stdout (one event per line)
#   Status messages to stderr
#
# Pipe to analysis tools:
#   wrangler-tail-json my-worker | jq '.logs | length'
#   wrangler-tail-json my-worker | duckdb -c "SELECT * FROM read_json_auto('/dev/stdin')"

set -euo pipefail

WORKER="${1:?Usage: $0 <worker-name> [timeout]}"
TIMEOUT="${2:-3}"

# Temporary file for raw output
TMPFILE=$(mktemp)
trap "rm -f $TMPFILE" EXIT

# Capture with timeout
echo "Capturing logs from $WORKER (${TIMEOUT}s)..." >&2

if command -v wrangler >/dev/null 2>&1; then
    # Direct wrangler if available
    timeout "$TIMEOUT" wrangler tail "$WORKER" --format json 2>/dev/null | grep '^{' || true
else
    # Use nix develop if needed
    nix develop --quiet 2>/dev/null -c bash -c "
        timeout $TIMEOUT wrangler tail '$WORKER' --format json 2>/dev/null
    " | grep '^{' || true
fi