# 共通設計書

目次

- [共通設計書](#共通設計書)
  - [環境構成](#環境構成)
  - [命名規則](#命名規則)
    - [ステージ](#ステージ)
    - [リソース](#リソース)
  - [ログ](#ログ)
  - [サブネット](#サブネット)
    - [サブネット構成](#サブネット構成)
    - [割り当てIPアドレス一覧](#割り当てipアドレス一覧)
  - [ネットワークセキュリティ](#ネットワークセキュリティ)
    - [グループ構成](#グループ構成)
    - [追加フィルタリングルール](#追加フィルタリングルール)

## 環境構成

## 命名規則

### ステージ

| #   | 環境名   | ID  |
| --- | -------- | --- |
| 1   | 本番環境 | prd |
| 2   | 開発環境 | stg |
<!-- | 3 | 本番前共有環境 | stg | -->

### リソース

<https://avantg.sharepoint.com/:o:/r/teams/BANDAISPIRITSAI/_layouts/15/Doc.aspx?sourcedoc=%7Bff43e98b-7653-45b6-9f3b-e8714434e3ca%7D&action=edit&wd=target(%E9%96%8B%E7%99%BA.one%7Cb53893a8-599f-42e5-ada8-2034383a21e6%2F%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E5%91%BD%E5%90%8D%E8%A6%8F%E5%89%87%7Cf327823a-f78e-4542-bae1-3336ef90e4d5%2F)&wdorigin=703&wdpreservelink=1&clickparams=eyJBcHBOYW1lIjoiVGVhbXMtRGVza3RvcCIsIkFwcFZlcnNpb24iOiI0OS8yNDExMDExNTcyMiIsIkhhc0ZlZGVyYXRlZFVzZXIiOmZhbHNlfQ%3D%3D>

- Cloud Functions 一般画面
  - stg-pb-support-admin-gcf
  - pb-support-admin-gcf
- Cloud Functions 管理画面
  - stg-pb-support-gcf
  - pb-support-gcf
- Cloud Logging
  - stg-pb-support-gcl
  - pb-support-gcl
- Cloud Storage
  - stg-pb-support-admin-gcs-backend
  - pb-support-admin-gcs-backend
  - for
    - inquery_history
    - work_checklist
    - mail_template
- CloudSQL
  - stg-pb-support-sql-backend
  - pb-support-sql-backend
<!-- - Agent Builder (Vertex AI Apps) [link](https://console.cloud.google.com/gen-app-builder/engines?referrer=search&hl=ja&invt=Abjytg&project=bsp-pb-support-ai-stg)
  - search-inqu
  - search-work
  - search-mail -->
- Compute Engine
  - forwarding-rule, backend-service,
    - pb-support-admin-ai
    - pb-support-ai

(清書)

| リソース名               | 命名規則                          | 開発用                           | 本番用                       |
| ------------------------ | --------------------------------- | -------------------------------- | ---------------------------- |
| Cloud Functions 一般画面 | {env}-{sysname}-{resource}-{任意} | stg-pb-support-gcf               | pb-support-gcf               |
| Cloud Functions 管理画面 | {env}-{sysname}-{resource}-{任意} | stg-pb-support-admin-gcf         | pb-support-admin-gcf         |
| Cloud Logging            | {env}-{sysname}-{resource}-{任意} | stg-pb-support-gcl               | pb-support-gcl               |
| Cloud Storage            | {env}-{sysname}-{resource}-{任意} | stg-pb-support-admin-gcs-backend | pb-support-admin-gcs-backend |
| CloudSQL                 | {env}-{sysname}-{resource}-{任意} | stg-pb-support-sql-backend       | pb-support-sql-backend       |
| Compute Engine           | {env}-{sysname}-{resource}-{任意} | stg-pb-support-admin-ai          | pb-support-admin-ai          |
| VPC                      | {任意}                           | default                          | pb-support-admin-ai          |

## ログ

## サブネット

### サブネット構成

```bash
gcloud compute networks subnets list --project=$PROJECT_ID --format=json > subnets.json
```

| サブネット名 | リージョン              | IPアドレス範囲 | 使用可能IPアドレス数 |
| ------------ | ----------------------- | -------------- | -------------------- |
| default      | us-central1             | 10.128.0.0/20  | 4094                 |
| default      | europe-west1            | 10.132.0.0/20  |                      |
| default      | us-west1                | 10.138.0.0/20  |                      |
| default      | asia-east1              | 10.140.0.0/20  |                      |
| default      | us-east1                | 10.142.0.0/20  |                      |
| default      | asia-northeast1         | 10.146.0.0/20  |                      |
| default      | asia-southeast1         | 10.148.0.0/20  |                      |
| default      | us-east4                | 10.150.0.0/20  |                      |
| default      | australia-southeast1    | 10.152.0.0/20  |                      |
| default      | europe-west2            | 10.154.0.0/20  |                      |
| default      | europe-west3            | 10.156.0.0/20  |                      |
| default      | southamerica-east1      | 10.158.0.0/20  |                      |
| default      | asia-east2              | 10.160.0.0/20  |                      |
| default      | northamerica-northeast1 | 10.162.0.0/20  |                      |
| default      | europe-west4            | 10.164.0.0/20  |                      |
| default      | europe-north1           | 10.166.0.0/20  |                      |
| default      | us-west2                | 10.168.0.0/20  |                      |
| default      | asia-south1             | 10.170.0.0/20  |                      |
| default      | asia-south2             | 10.172.0.0/20  |                      |
| default      | europe-west6            | 10.174.0.0/20  |                      |
| default      | asia-northeast2         | 10.176.0.0/20  |                      |
| default      | europe-west12           | 10.178.0.0/20  |                      |
| default      | us-east5                | 10.180.0.0/20  |                      |
| default      | asia-northeast3         | 10.182.0.0/20  |                      |
| default      | australia-southeast2    | 10.184.0.0/20  |                      |
| default      | southamerica-west1      | 10.186.0.0/20  |                      |
| default      | europe-central2         | 10.188.0.0/20  |                      |
| default      | northamerica-northeast2 | 10.190.0.0/20  |                      |
| default      | asia-south2             | 10.192.0.0/20  |                      |
| default      | australia-southeast2    | 10.194.0.0/20  |                      |
| default      | southamerica-west1      | 10.196.0.0/20  |                      |
| default      | us-east7                | 10.198.0.0/20  |                      |
| default      | europe-west8            | 10.200.0.0/20  |                      |
| default      | europe-west9            | 10.202.0.0/20  |                      |

<!-- ### ネットワークアドレス -->

### 割り当てIPアドレス一覧

```bash
gcloud compute addresses list --project=$PROJECT_ID --format=json > external_ips.json
```

| アドレス名                 | 外部・内部 | 割り当てIPアドレス | 当リソースURL                        | 使用サービス                        |
| -------------------------- | ---------- | ------------------ | ------------------------------------ | ----------------------------------- |
| admin-global-ip-address    | 外部       | 34.54.247.182      | addresses/admin-global-ip-address    | forwardingRules/pb-support-admin-ai |
| frontend-global-ip-address | 外部       | 34.49.160.22       | addresses/frontend-global-ip-address | forwardingRules/pb-support-ai       |
| admin-ip-address           | 外部       | 34.146.131.92      | addresses/admin-ip-address           |                                     |
| frontend-ip-address        | 外部       | 35.200.73.192      | addresses/frontend-ip-address        |                                     |

## ネットワークセキュリティ

### グループ構成

```text
https://console.cloud.google.com/compute/networkendpointgroups/list?hl=ja&inv=1&invt=Abjzug&project=bsp-pb-support-ai-stg
```

| グループ名          | 紐づけられているサブネット名 | 使用リソース                         |
| ------------------- | ---------------------------- | ------------------------------------ |
| pb-support-ai       | -                            | pb-support-ai / Compute Engine       |
| pb-support-admin-ai | -                            | pb-support-admin-ai / Compute Engine |

### 追加フィルタリングルール

```text
https://console.cloud.google.com/net-security/firewall-manager/firewall-policies/list?inv=1&invt=AbjzzA&project=bsp-pb-support-ai-stg
```

受信セキュリティ規制

| 名前                   | 種類           | ターゲット   | フィルタ              | プロトコル / ポート            | アクション | 優先度 | ネットワーク | ログ | ヒットカウント | 前回のヒット |
| :--------------------- | :------------- | :----------- | :-------------------- | :----------------------------- | :--------- | :----- | :----------- | :--- | :------------- | :----------- |
| default-allow-icmp     | 上り（内向き） | すべてに適用 | IP 範囲: 0.0.0.0/0    | icmp                           | 許可       | 65534  | default      | オフ | —              | —            |
| default-allow-internal | 上り（内向き） | すべてに適用 | IP 範囲: 10.128.0.0/9 | tcp:0-65535, udp:0-65535, icmp | 許可       | 65534  | default      | オフ | —              | —            |
| default-allow-rdp      | 上り（内向き） | すべてに適用 | IP 範囲: 0.0.0.0/0    | tcp:3389                       | 許可       | 65534  | default      | オフ | —              | —            |
| default-allow-ssh      | 上り（内向き） | すべてに適用 | IP 範囲: 0.0.0.0/0    | tcp:22                         | 許可       | 65534  | default      | オフ | —              | —            |

<!-- | 優先度 | ルール名 | ポート番号 | プロトコル | ソース | 宛先 | アクション |
| ------ | -------- | ---------- | ---------- | ------ | ---- | ---------- | -->

送信セキュリティ規制

| 名前                   | 種類           | ターゲット   | フィルタ              | プロトコル / ポート            | アクション | 優先度 | ネットワーク | ログ | ヒットカウント | 前回のヒット |
| :--------------------- | :------------- | :----------- | :-------------------- | :----------------------------- | :--------- | :----- | :----------- | :--- | :------------- | :----------- |
